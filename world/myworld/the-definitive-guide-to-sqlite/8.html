<!DOCTYPE HTML>
<html lang="zh-tw" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>第6章  核心C API | SQLite 权威指南</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        <meta name="author" content="wizardforcel">
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-comment/plugin.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="./9.html" />
    
    
    <link rel="prev" href="./7.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="8"
        data-chapter-title="第6章  核心C API"
        data-filepath="8.md"
        data-basepath="."
        data-revision="Tue May 17 2016 11:53:33 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
                
                <li>
                    <a href="https://www.gitbook.com/book/wizardforcel/the-definitive-guide-to-sqlite" target="blank" class="custom-link">SQLite 权威指南</a>
                </li>
            
            

            
            <li class="divider"></li>
            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        SQLite权威指南
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="1.html">
            
                
                    <a href="./1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        推荐者的话
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="2.html">
            
                
                    <a href="./2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        前言
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="3.html">
            
                
                    <a href="./3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        第1章  SQLite介绍
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="4.html">
            
                
                    <a href="./4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        第2章 入门
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="5.html">
            
                
                    <a href="./5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        第3章  关系模型
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="6.html">
            
                
                    <a href="./6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        第4章  SQL
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="7.html">
            
                
                    <a href="./7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        第5章  设计和概念
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="8" data-path="8.html">
            
                
                    <a href="./8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        第6章  核心C API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="9.html">
            
                
                    <a href="./9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        第7章  扩充C API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="10.html">
            
                
                    <a href="./10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        第8章  语言扩展
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="11.html">
            
                
                    <a href="./11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        第9章  SQLite内核
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    本書使用 GitBook 釋出
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >SQLite 权威指南</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="&#x7B2C;6&#x7AE0;--&#x6838;&#x5FC3;c-api">&#x7B2C;6&#x7AE0;  &#x6838;&#x5FC3;C API</h1>
<p>&#x672C;&#x7AE0;&#x4ECB;&#x7ECD;&#x7528;&#x4E8E;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x7684;SQLite API&#x3002;&#x7B2C;5&#x7AE0;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x4E86;API&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#xFF0C;&#x672C;&#x7AE0;&#x5173;&#x6CE8;&#x7EC6;&#x8282;&#x3002;</p>
<p>&#x672C;&#x7AE0;&#x4ECE;&#x51E0;&#x4E2A;&#x4F8B;&#x5B50;&#x5F00;&#x59CB;&#xFF0C;&#x6DF1;&#x5165;&#x4ECB;&#x7ECD;C API&#x3002;&#x5B66;&#x5B8C;&#x672C;&#x7AE0;&#x4E4B;&#x540E;&#xFF0C;&#x4F60;&#x4F1A;&#x770B;&#x5230;&#x6BCF;&#x4E2A;C API&#x51FD;&#x6570;&#x90FD;&#x4E0E;&#x5E38;&#x7528;&#x7684;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x6709;&#x5173;&#xFF0C;&#x5305;&#x62EC;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x3001;&#x7BA1;&#x7406;&#x4E8B;&#x52A1;&#x3001;&#x53D6;&#x8BB0;&#x5F55;&#x3001;&#x5904;&#x7406;&#x9519;&#x8BEF;&#x7B49;&#x7B49;&#x3002;</p>
<p>SQLite&#x7684;&#x7248;&#x672C;3&#x7684;API&#x5305;&#x62EC;&#x5927;&#x7EA6;80&#x4E2A;&#x51FD;&#x6570;&#x3002;&#x53EA;&#x6709;8&#x4E2A;&#x51FD;&#x6570;&#x5728;&#x8FDE;&#x63A5;&#x3001;&#x67E5;&#x8BE2;&#x548C;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x65F6;&#x662F;&#x5FC5;&#x987B;&#x7684;&#xFF0C;&#x5176;&#x5B83;&#x7684;&#x51FD;&#x6570;&#x7528;&#x6765;&#x5B8C;&#x6210;&#x7279;&#x5B9A;&#x7684;&#x4EFB;&#x52A1;&#x3002;</p>
<p>&#x5982;&#x7B2C;5&#x7AE0;&#x6240;&#x8FF0;&#xFF0C;&#x7248;&#x672C;3&#x4E0E;2&#x7684;API&#x76F8;&#x6BD4;&#x6709;&#x8F83;&#x5927;&#x6539;&#x53D8;&#x3002;&#x6700;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x4E00;&#x4E2A;&#x6539;&#x53D8;&#x662F;&#x589E;&#x52A0;&#x4E86;&#x5BF9;UTF&#x7684;&#x652F;&#x6301;&#x3002;&#x6240;&#x6709;&#x63A5;&#x53D7;&#x5B57;&#x7B26;&#x4E32;&#x505A;&#x4E3A;&#x53C2;&#x6570;&#x6216;&#x8FD4;&#x56DE;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x51FD;&#x6570;&#x90FD;&#x540C;&#x65F6;&#x5177;&#x6709;UTF-8&#x548C;UTF-16&#x7684;&#x76F8;&#x4F3C;&#x4F53;&#x3002;&#x4F8B;&#x5982;&#xFF0C;sqlite3_open()&#xFF0C;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;UTF-8&#x7684;&#x6570;&#x636E;&#x5E93;&#x540D;&#x505A;&#x53C2;&#x6570;&#xFF1B;&#x800C;sqlite3_open16()&#x5177;&#x6709;&#x540C;&#x6837;&#x7684;&#x529F;&#x80FD;&#x4E0E;&#x683C;&#x5F0F;&#xFF0C;&#x4F46;&#x53C2;&#x6570;&#x4F7F;&#x7528;UTF-16&#x7F16;&#x7801;&#x3002;&#x672C;&#x7AE0;&#x4E00;&#x822C;&#x53EA;&#x4ECB;&#x7ECD;UTF-8&#x7684;&#x51FD;&#x6570;&#xFF0C;UTF-16&#x7248;&#x672C;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x540D;&#x5B57;&#x4E0A;&#x6709;&#x5FAE;&#x5C0F;&#x5DEE;&#x522B;&#x3002;</p>
<p>&#x672C;&#x7AE0;&#x6700;&#x597D;&#x987A;&#x5E8F;&#x5730;&#x8BFB;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x7EC6;&#x8282;&#x4E0A;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x9644;&#x5F55;B&#x3002;</p>
<p>&#x7A7A;&#x6CE8;&#xFF1A;&#x7B2C;6&#x3001;7&#x4E24;&#x7AE0;&#x5E94;&#x8BE5;&#x4E5F;&#x662F;&#x672C;&#x4E66;&#x7684;&#x7CBE;&#x534E;&#x4E86;&#xFF0C;&#x4E3B;&#x8981;&#x4ECB;&#x7ECD;&#x5BF9;SQLite&#x8FDB;&#x884C;&#x7F16;&#x7A0B;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x5927;&#x591A;&#x6570;SQLite&#x7684;&#x4F7F;&#x7528;&#x8005;&#x53EF;&#x80FD;&#x66F4;&#x5173;&#x5FC3;&#x8FD9;&#x4E24;&#x7AE0;&#xFF0C;&#x4F46;&#x6211;&#x53C8;&#x4E0D;&#x5F00;&#x53D1;&#x57FA;&#x4E8E;SQLite&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x7814;&#x7A76;SQLite&#x7EAF;&#x7CB9;&#x51FA;&#x4E8E;&#x5174;&#x8DA3;&#xFF0C;&#x4E2A;&#x4EBA;&#x66F4;&#x5173;&#x5FC3;SQLite&#x672C;&#x8EAB;&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x8FD9;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x53EA;&#x662F;&#x7565;&#x505A;&#x6D4F;&#x89C8;&#x3002;&#x5173;&#x5FC3;&#x8FD9;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x7684;&#x5144;&#x5F1F;&#x8FD8;&#x662F;&#x5F97;&#x81EA;&#x5DF1;&#x770B;&#x539F;&#x6587;&#x3002;</p>
<h2 id="&#x5C01;&#x88C5;&#x7684;&#x67E5;&#x8BE2;">&#x5C01;&#x88C5;&#x7684;&#x67E5;&#x8BE2;</h2>
<p>&#x4F60;&#x5DF2;&#x7ECF;&#x719F;&#x6089;&#x4E86;SQLite&#x6267;&#x884C;&#x67E5;&#x8BE2;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5305;&#x62EC;&#x5728;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x51FD;&#x6570;&#x4E2D;&#x6267;&#x884C;&#x5C01;&#x88C5;&#x7684;SQL&#x3002;&#x6211;&#x4EEC;&#x4ECE;&#x5C01;&#x88C5;&#x7684;SQL&#x5F00;&#x59CB;&#x4ECB;&#x7ECD;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x7B80;&#x5355;&#x3001;&#x72EC;&#x7ACB;&#x4E14;&#x6613;&#x7528;&#x3002;&#x5B83;&#x4EEC;&#x662F;&#x597D;&#x7684;&#x8D77;&#x70B9;&#xFF0C;&#x4F7F;&#x4F60;&#x80FD;&#x5F97;&#x5230;&#x4E50;&#x8DA3;&#xFF0C;&#x53C8;&#x4E0D;&#x4F1A;&#x88AB;&#x8FC7;&#x591A;&#x7684;&#x7EC6;&#x8282;&#x6240;&#x56F0;&#x6270;&#x3002;</p>
<h2 id="&#x8FDE;&#x63A5;&#x548C;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;">&#x8FDE;&#x63A5;&#x548C;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;</h2>
<p>&#x5728;&#x6267;&#x884C;SQL&#x547D;&#x4EE4;&#x4E4B;&#x524D;&#xFF0C;&#x9996;&#x5148;&#x8981;&#x8FDE;&#x63A5;&#x6570;&#x636E;&#x5E93;&#x3002;&#x56E0;&#x4E3A;SQLite&#x6570;&#x636E;&#x5E93;&#x5B58;&#x50A8;&#x5728;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x6587;&#x4EF6;&#x5F53;&#x4E2D;&#xFF0C;&#x6240;&#x4EE5;&#x8FDE;&#x63A5;&#x6570;&#x636E;&#x5E93;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x201C;&#x6253;&#x5F00;&#x201D;&#x6570;&#x636E;&#x5E93;&#x3002;&#x540C;&#x6837;&#xFF0C;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x4E5F;&#x5C31;&#x662F;&#x5173;&#x95ED;&#x6570;&#x636E;&#x5E93;&#x3002;</p>
<p>&#x6253;&#x5F00;&#x6570;&#x636E;&#x5E93;&#x7528;sqlite3_open()&#x6216;sqlite3_open16()&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x4EEC;&#x7684;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>int sqlite3_open(
    const char *filename,           /* Database filename (UTF-8) */
    sqlite3 **ppDb                    /* OUT: SQLite db handle */
);
int sqlite3_open16(
    const void *filename,            /* Database filename (UTF-16) */
    sqlite3 **ppDb                    /* OUT: SQLite db handle */
);
</code></pre><p>&#x5176;&#x4E2D;&#xFF0C;filename&#x53C2;&#x6570;&#x53EF;&#x4EE5;&#x662F;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x6216;&#x5B57;&#x7B26;&#x4E32;&apos;:memory:&apos;&#xFF0C;&#x6216;&#x4E00;&#x4E2A;&#x7A7A;&#x6307;&#x9488;(NULL)&#x3002;&#x7528;&#x540E;&#x4E24;&#x8005;&#x5C06;&#x521B;&#x5EFA;&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x3002;&#x5982;&#x679C;filename&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x5148;&#x5C1D;&#x8BD5;&#x6253;&#x5F00;&#xFF0C;&#x5982;&#x679C;&#x6587;&#x4EF6;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x7528;&#x8FD9;&#x4E2A;&#x540D;&#x5B57;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6570;&#x636E;&#x5E93;&#x3002;</p>
<p>&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x4F7F;&#x7528;sqlite3_close()&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x7684;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>int sqlite3_close(sqlite3*);
</code></pre><p>&#x4E3A;&#x4E86;sqlite3_close()&#x80FD;&#x591F;&#x6210;&#x529F;&#x6267;&#x884C;&#xFF0C;&#x6240;&#x6709;&#x4E0E;&#x8FDE;&#x63A5;&#x6240;&#x5173;&#x8054;&#x7684;&#x5DF2;&#x7F16;&#x8BD1;&#x7684;&#x67E5;&#x8BE2;&#x5FC5;&#x987B;&#x88AB;&#x5B9A;&#x6848;&#x3002;&#x5982;&#x679C;&#x4ECD;&#x7136;&#x6709;&#x67E5;&#x8BE2;&#x6CA1;&#x6709;&#x5B9A;&#x6848;&#xFF0C;sqlite3_close()&#x5C06;&#x8FD4;&#x56DE;SQLITE_BUSY&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF1A;Unable to close due to unfinalized statements&#x3002;</p>
<h2 id="&#x6267;&#x884C;query">&#x6267;&#x884C;Query</h2>
<p>&#x51FD;&#x6570;sqlite3_exec()&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x6267;&#x884C;SQL&#x547D;&#x4EE4;&#x7684;&#x5FEB;&#x901F;&#x3001;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x7279;&#x522B;&#x9002;&#x5408;&#x5904;&#x7406;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x7684;&#x4FEE;&#x6539;&#x64CD;&#x4F5C;(&#x4E0D;&#x9700;&#x8981;&#x8FD4;&#x56DE;&#x6570;&#x636E;)&#x3002;sqlite3_exec()&#x7684;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>int sqlite3_exec(

    sqlite3*, /* An open database */
    const char *sql, /* SQL to be executed */
    sqlite_callback, /* Callback function */
    void *data /* 1st argument to callback function */
    char **errmsg /* Error msg written here */
);
</code></pre><p>SQL&#x547D;&#x4EE4;&#x7531;sql&#x53C2;&#x6570;&#x63D0;&#x4F9B;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x7531;&#x591A;&#x4E2A;SQL&#x547D;&#x4EE4;&#x6784;&#x6210;&#xFF0C;sqlite3_exec()&#x4F1A;&#x5BF9;&#x5176;&#x4E2D;&#x6BCF;&#x4E2A;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x5206;&#x6790;&#x5E76;&#x6267;&#x884C;&#xFF0C;&#x76F4;&#x5230;&#x547D;&#x4EE4;&#x4E32;&#x7ED3;&#x675F;&#x6216;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x3002;&#x5217;&#x8868;6-1(&#x6765;&#x81EA;create.c)&#x8BF4;&#x660E;&#x4E86;sqlite3_exec()&#x7684;&#x7528;&#x6CD5;&#xFF1A;</p>
<p>&#x5217;&#x8868;6-1 &#x5BF9;&#x7B80;&#x5355;&#x7684;&#x547D;&#x4EE4;&#x4F7F;&#x7528;sqlite3_exec()</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &quot;util.h&quot;
#pragma comment(lib, &quot;sqlite3.lib&quot;)
int main(int argc, char **argv)
{
    sqlite3 *db;
    char *zErr;
    int rc;
    char *sql;
    rc = sqlite3_open(&quot;test.db&quot;, &amp;db);
    if (rc) {
        fprintf(stderr, &quot;Can&apos;t open database: %s\n&quot;, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }
    sql = &quot;create table episodes( id integer primary key,&quot;
        &quot;                  name text, cid int)&quot;;
    rc = sqlite3_exec(db, sql, NULL, NULL, &amp;zErr);
    if (rc != SQLITE_OK) {
        if (zErr != NULL) {
            fprintf(stderr, &quot;SQL error: %s\n&quot;, zErr);
            sqlite3_free(zErr);
        }
    }
    sql = &quot;insert into episodes (name,id) values (&apos;Cinnamon Babka2&apos;,1)&quot;;
    rc = sqlite3_exec(db, sql, NULL, NULL, &amp;zErr);
    if (rc != SQLITE_OK) {
        if (zErr != NULL) {
            fprintf(stderr, &quot;SQL error: %s\n&quot;, zErr);
            sqlite3_free(zErr);
        }
    }
    sqlite3_close(db);
    return 0;   
}
</code></pre><h3 id="&#x5904;&#x7406;&#x8BB0;&#x5F55;">&#x5904;&#x7406;&#x8BB0;&#x5F55;</h3>
<p>&#x5982;&#x7B2C;5&#x7AE0;&#x6240;&#x8FF0;&#xFF0C;&#x8FD8;&#x662F;&#x6709;&#x53EF;&#x80FD;&#x4ECE;sqlite3_exec()&#x53D6;&#x5F97;&#x8BB0;&#x5F55;&#x7684;&#x3002;sqlite3_exec()&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x56DE;&#x53EB;(callback)&#x673A;&#x5236;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x4ECE;SELECT&#x8BED;&#x53E5;&#x5F97;&#x5230;&#x7ED3;&#x679C;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x673A;&#x5236;&#x7531;sqlite3_exec()&#x51FD;&#x6570;&#x7684;&#x7B2C;3&#x548C;&#x7B2C;4&#x4E2A;&#x53C2;&#x6570;&#x5B9E;&#x73B0;&#x3002;&#x7B2C;3&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x5982;&#x679C;&#x63D0;&#x4F9B;&#x4E86;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#xFF0C;SQLite&#x5219;&#x4F1A;&#x5728;&#x6267;&#x884C;SELECT&#x8BED;&#x53E5;&#x671F;&#x95F4;&#x5728;&#x9047;&#x5230;&#x6BCF;&#x4E00;&#x6761;&#x8BB0;&#x5F55;&#x65F6;&#x8C03;&#x7528;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x3002;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x7684;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>typedef int (*sqlite3_callback)(
    void*, /* Data provided in the 4th argument of sqlite3_exec() */
    int, /* The number of columns in row */
    char**, /* An array of strings representing fields in the row */
    char** /* An array of strings representing column names */
);
</code></pre><p>&#x51FD;&#x6570;sqlite3_exec()&#x7684;&#x7B2C;4&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x4EFB;&#x4F55;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6307;&#x5B9A;&#x7684;&#x6570;&#x636E;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x662F;&#x4F60;&#x51C6;&#x5907;&#x63D0;&#x4F9B;&#x7ED9;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x7684;&#x3002;SQLite&#x5C06;&#x628A;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x4F5C;&#x4E3A;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x7684;&#x7B2C;1&#x4E2A;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x3002;</p>
<p>&#x603B;&#x4E4B;&#xFF0C;sqlite3_exec()&#x5141;&#x8BB8;&#x4F60;&#x5904;&#x7406;&#x4E00;&#x6279;&#x547D;&#x4EE4;&#xFF0C;&#x5E76;&#x4E14;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x6765;&#x6536;&#x96C6;&#x6240;&#x6709;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x636E;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5148;&#x5411;episodes&#x8868;&#x63D2;&#x5165;&#x4E00;&#x6761;&#x8BB0;&#x5F55;&#xFF0C;&#x518D;&#x4ECE;&#x4E2D;&#x67E5;&#x8BE2;&#x6240;&#x6709;&#x8BB0;&#x5F55;&#xFF0C;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x90FD;&#x5728;&#x4E00;&#x4E2A;sqlite3_exec()&#x8C03;&#x7528;&#x4E2D;&#x5B8C;&#x6210;&#x3002;&#x5B8C;&#x6574;&#x7684;&#x7A0B;&#x5E8F;&#x4EE3;&#x7801;&#x89C1;&#x5217;&#x8868;6-2&#xFF0C;&#x5B83;&#x6765;&#x81EA;exec.c&#x3002;</p>
<p>&#x5217;&#x8868;6-2 &#x5C06;sqlite3_exec()&#x7528;&#x4E8E;&#x8BB0;&#x5F55;&#x5904;&#x7406;</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &quot;util.h&quot;
#pragma comment(lib, &quot;sqlite3.lib&quot;)
int callback(void* data, int ncols, char** values, char** headers);
int main(int argc, char **argv)
{
    sqlite3 *db;
    int rc;
    char *sql;
    char *zErr;
       char* data;
    rc = sqlite3_open(&quot;test.db&quot;, &amp;db);
    if(rc) {
        fprintf(stderr, &quot;Can&apos;t open database: %s\n&quot;, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }
    data = &quot;Callback function called&quot;;
    sql = &quot;insert into episodes (name, cid) values (&apos;Mackinaw Peaches&apos;, 1);&quot;
          &quot;select * from episodes;&quot;;
    rc = sqlite3_exec(db, sql, callback, data, &amp;zErr);
    if(rc != SQLITE_OK) {
        if (zErr != NULL) {
            fprintf(stderr, &quot;SQL error: %s\n&quot;, zErr);
            sqlite3_free(zErr);
        }
    }
    sqlite3_close(db);
    return 0;   
}
int callback(void* data, int ncols, char** values, char** headers)
{
    int i;
    fprintf(stderr, &quot;%s: &quot;, (const char*)data);
    for(i=0; i &lt; ncols; i++) {
        fprintf(stderr, &quot;%s=%s &quot;, headers[i], values[i]);
    }
    fprintf(stderr, &quot;\n&quot;);
    return 0;
}
</code></pre><h2 id="&#x5B57;&#x7B26;&#x4E32;&#x5904;&#x7406;">&#x5B57;&#x7B26;&#x4E32;&#x5904;&#x7406;</h2>
<pre><code>int main(int argc, char **argv)
{
    char *sql;
    char *trouble = &quot;&apos;Here&apos;s trouble&apos;&quot;;
    sql = sqlite3_mprintf(&quot;insert into x values(&apos;%q&apos;)&quot;, trouble);
    fprintf(stdout, &quot;%s\n&quot;, sql);
    sqlite3_free(sql);
    return 0;   
}
</code></pre><p>The result sql will contain</p>
<p>insert into x values(&apos;&apos;&apos;Here&apos;&apos;s trouble&apos;&apos;&apos;)</p>
<p>Listing 6-3. Using sqlite3_vmprintf()</p>
<pre><code>int execute(sqlite3 *db, const char* sql, ...)
{
    char *err, *tmp;
    va_list ap;
    va_start(ap, sql);
    tmp = sqlite3_vmprintf(sql, ap);
    va_end(ap);
    int rc = sqlite3_exec(db, tmp, NULL, NULL, &amp;err);
    if(rc != SQLITE_OK) {
        if (err != NULL) {
            fprintf(stdout, &quot;execute() : Error %i : %s\n&quot;, rc, err);
            sqlite3_free(err);
        }
    }
    sqlite3_free(tmp);
    return rc;
}
</code></pre><h2 id="get-table&#x67E5;&#x8BE2;">Get Table&#x67E5;&#x8BE2;</h2>
<pre><code>int sqlite3_get_table(
    sqlite3*, /* An open database */
    const char *sql, /* SQL to be executed */
    char ***resultp, /* Result written to a char *[] that this points to */
    int *nrow, /* Number of result rows written here */
    int *ncolumn, /* Number of result columns written here */
    char **errmsg /* Error msg written here */
);
</code></pre><p>Listing 6-4. Using sqlite3_get_table</p>
<pre><code>void main(int argc, char **argv)
{
    sqlite3 *db;
    char *zErr;
    int rc,i;
    char *sql;
    char **result;
       int nrows, ncols;
    /* Connect to database, etc. */
    rc = sqlite3_open(&quot;test.db&quot;, &amp;db);
    sql = &quot;select * from episodes;&quot;;
    rc = sqlite3_get_table(db, sql, &amp;result, &amp;nrows, &amp;ncols, &amp;zErr);
    /* Do something with data */
       printf(&quot;rows=%d,cols=%d\n&quot;,nrows,ncols);
       for (i=0;i&lt;=nrows;i++)
              printf(&quot;%-5s%-20s%-5s\n&quot;,result[3*i],result[3*i+1],result[3*i+2]);
    /* Free memory */
    sqlite3_free_table(result);
}
</code></pre><p>If, for example, the result set returned is of the form</p>
<p>rows=2,cols=3</p>
<pre><code>id   name                cid
1    Cinnamon Babka2     (null)
2    Mackinaw Peaches    1
</code></pre><h2 id="&#x9884;&#x5904;&#x7406;&#x7684;&#x67E5;&#x8BE2;">&#x9884;&#x5904;&#x7406;&#x7684;&#x67E5;&#x8BE2;</h2>
<p>As you&#x2019;ll recall from Chapter 5, prepared queries are performed in three basic steps: compilation, execution, and finalization. This process is illustrated in Figure 6-1.</p>
<p><img src="img/image010.jpg" alt=""></p>
<p>Figure 6-1. Prepared query processing</p>
<p>Now that you&#x2019;ve seen the whole process, let&#x2019;s go through an example. A simple, complete program using a prepared query is listed in Listing 6-6. It is taken from select.c in the examples.</p>
<p>Listing 6-6. Using Prepared Queries</p>
<pre><code>#include &lt;string.h&gt;
int main(int argc, char **argv)
{
    int rc, i, ncols;
    sqlite3 *db;
    sqlite3_stmt *stmt;
    char *sql;
    const char *tail;
    rc = sqlite3_open(&quot;test.db&quot;, &amp;db);
    if(rc) {
        fprintf(stderr, &quot;Can&apos;t open database: %s\n&quot;, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }
    sql = &quot;select * from episodes;&quot;;
    rc = sqlite3_prepare(db, sql, (int)strlen(sql), &amp;stmt, &amp;tail);
    if(rc != SQLITE_OK) {
        fprintf(stderr, &quot;SQL error: %s\n&quot;, sqlite3_errmsg(db));
    }
    rc = sqlite3_step(stmt);
    ncols = sqlite3_column_count(stmt);
    while(rc == SQLITE_ROW) {
        for(i=0; i &lt; ncols; i++) {
            fprintf(stderr, &quot;&apos;%s&apos; &quot;, sqlite3_column_text(stmt, i));
        }
        fprintf(stderr, &quot;\n&quot;);
        rc = sqlite3_step(stmt);
    }
    sqlite3_finalize(stmt);
    sqlite3_close(db);
    return 0;   
}
</code></pre><p>&#x8DDF;sqlite3_exec()&#x76F8;&#x4F3C;&#xFF0C;sqlite3_prepare()&#x4E5F;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x5305;&#x62EC;&#x591A;&#x4E2A;SQL&#x8BED;&#x53E5;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x4E0D;&#x540C;&#x7684;&#x662F;sqlite3_prepare()&#x53EA;&#x5904;&#x7406;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x7684;&#x7B2C;1&#x4E2A;&#x8BED;&#x53E5;&#x3002;But it does make it easy for you to process subsequent SQL statements in the string by providing the pzTailout parameter. After you call sqlite3_prepare(), it will point this parameter (if provided) to the starting position of the next statement in the zSQL string. Using pzTail, processing a batch of SQL commands in a given string can be executed in a loop as follows:</p>
<pre><code>while(sqlite3_complete(sql) {
    rc = sqlite3_prepare(db, sql, strlen(sql), &amp;stmt, &amp;tail);
    /* Process query results */
    /* Skip to next command in string. */
    sql = tail;
}
</code></pre><h2 id="&#x53D6;&#x8BB0;&#x5F55;">&#x53D6;&#x8BB0;&#x5F55;</h2>
<h3 id="&#x53D6;&#x5B57;&#x6BB5;&#x4FE1;&#x606F;">&#x53D6;&#x5B57;&#x6BB5;&#x4FE1;&#x606F;</h3>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;sqlite3_column_name()&#x6765;&#x53D6;&#x5F97;&#x5404;&#x5B57;&#x6BB5;&#x7684;&#x540D;&#x79F0;&#xFF1A;</p>
<pre><code>    const char *sqlite3_column_name( sqlite3_stmt*, /* statement handle */
        int iCol /* column ordinal */);
</code></pre><p>&#x7C7B;&#x4F3C;&#x5730;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;sqlite3_column_type()&#x53D6;&#x5F97;&#x5404;&#x5B57;&#x6BB5;&#x7684;&#x5B58;&#x50A8;&#x7C7B;&#xFF1A;</p>
<pre><code>    int sqlite3_column_type( sqlite3_stmt*, /* statement handle */
        int iCol /* column ordinal */);
</code></pre><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6574;&#x6570;&#x503C;&#xFF0C;&#x4EE3;&#x8868;5&#x4E2A;&#x5B58;&#x50A8;&#x7C7B;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>#define SQLITE_INTEGER 1
#define SQLITE_FLOAT 2
#define SQLITE_TEXT 3
#define SQLITE_BLOB 4
#define SQLITE_NULL 5
</code></pre><p>&#x8FD9;&#x4E9B;&#x662F;SQLite&#x672C;&#x8EAB;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x6216;&#x79F0;&#x5B58;&#x50A8;&#x7C7B;&#xFF0C;&#x5728;&#x7B2C;4&#x7AE0;&#x6709;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002;All data stored within a SQLite database is stored in one of these five forms, depending on its initial representation and the affinity of the column. For our purposes, the terms storage class and data type are synonymous. For more information on storage classes, see the sections &#x201C;Storage Classes&#x201D; and &#x201C;Type Affinity&#x201D; in Chapter 4.</p>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;sqlite3_column_decltype()&#x51FD;&#x6570;&#x83B7;&#x5F97;&#x5B57;&#x6BB5;&#x58F0;&#x660E;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1A;</p>
<pre><code>    const char *sqlite3_column_decltype( sqlite3_stmt*, /* statement handle */
        int /* column ordinal */);
</code></pre><p>&#x5982;&#x679C;&#x7ED3;&#x679C;&#x96C6;&#x4E2D;&#x7684;&#x4E00;&#x5217;&#x4E0D;&#x662F;&#x6765;&#x81EA;&#x4E00;&#x4E2A;&#x5B9E;&#x9645;&#x7684;&#x5B57;&#x6BB5;(&#x5982;&#x6765;&#x81EA;&#x4E8E;&#x8868;&#x8FBE;&#x5F0F;&#x3001;&#x51FD;&#x6570;&#x6216;&#x805A;&#x5408;&#x7684;&#x7ED3;&#x679C;)&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5C06;&#x8FD4;&#x56DE;NULL&#x3002;For example, suppose you have a table in your database defined as</p>
<pre><code>CREATE TABLE t1(c1 INTEGER);
</code></pre><p>Then you execute the following query:</p>
<pre><code>SELECT c1 + 1, 0 FROM t1;
</code></pre><p>In this case, sqlite3_column_decltype() will return INTEGER for the first column and NULL for</p>
<p>the second.</p>
<p>&#x8FD8;&#x53EF;&#x4EE5;&#x7528;&#x4E0B;&#x5217;&#x51FD;&#x6570;&#x83B7;&#x5F97;&#x5B57;&#x6BB5;&#x7684;&#x5176;&#x5B83;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre><code>const char *sqlite3_column_database_name(sqlite3_stmt *pStmt, int iCol);

const char *sqlite3_column_table_name(sqlite3_stmt *pStmt, int iCol);
const char *sqlite3_column_origin_name(sqlite3_stmt *pStmt, int iCol);
</code></pre><p>The first function will return the database associated with a column, the second its table, and</p>
<p>the last function returns the column&#x2019;s actual name as defined in the schema. That is, if you</p>
<p>assigned the column an alias in the SQL statement, sqlite3_column_origin_name() will return</p>
<p>its actual name as defined in the schema. Note that these functions are only available if you</p>
<p>compile SQLite with the SQLITE_ENABLE_COLUMN_METADATA preprocessor directive.</p>
<p>&#x5217;&#x5143;&#x6570;&#x636E;&#xFF1A;</p>
<p>&#x5B57;&#x6BB5;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x53EF;&#x4EE5;&#x4ECE;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7684;query&#x83B7;&#x5F97;&#xFF0C;&#x4F7F;&#x7528;sqlite3_table_column_metadata()&#x51FD;&#x6570;&#xFF0C;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>SQLITE_API int sqlite3_table_column_metadata(
  sqlite3 *db,                /* Connection handle */
  const char *zDbName,        /* Database name or NULL */
  const char *zTableName,     /* Table name */
  const char *zColumnName,    /* Column name */
  char const **pzDataType,    /* OUTPUT: Declared data type */
  char const **pzCollSeq,     /* OUTPUT: Collation sequence name */
  int *pNotNull,              /* OUTPUT: True if NOT NULL constraint exists */
  int *pPrimaryKey,           /* OUTPUT: True if column part of PK */
  int *pAutoinc               /* OUTPUT: True if column is auto-increment */
);
</code></pre><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5305;&#x542B;&#x8F93;&#x5165;&#x548C;&#x8F93;&#x51FA;&#x53C2;&#x6570;&#x3002;&#x5B83;&#x4E0D;&#x5728;statement&#x53E5;&#x67C4;&#x4E0B;&#x5DE5;&#x4F5C;&#xFF0C;&#x4F46;&#x9700;&#x8981;&#x63D0;&#x4F9B;&#x8FDE;&#x63A5;&#x53E5;&#x67C4;&#x3001;&#x6570;&#x636E;&#x5E93;&#x540D;&#x3001;&#x8868;&#x540D;&#x548C;&#x5217;&#x540D;&#x3002;&#x53EF;&#x9009;&#x7684;&#x6570;&#x636E;&#x5E93;&#x540D;&#x6307;&#x660E;&#x9644;&#x52A0;&#x7684;&#x903B;&#x8F91;&#x6570;&#x636E;&#x5E93;&#x540D;(&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x4E0A;&#x53EF;&#x80FD;&#x9644;&#x52A0;&#x591A;&#x4E2A;&#x6570;&#x636E;&#x5E93;)&#x3002;&#x8868;&#x540D;&#x548C;&#x5B57;&#x6BB5;&#x540D;&#x662F;&#x5FC5;&#x987B;&#x7684;&#x3002;</p>
<h3 id="&#x53D6;&#x5B57;&#x6BB5;&#x503C;">&#x53D6;&#x5B57;&#x6BB5;&#x503C;</h3>
<p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;sqlite3_column_xxx()&#x51FD;&#x6570;&#x53D6;&#x5F53;&#x524D;&#x8BB0;&#x5F55;&#x4E2D;&#x6BCF;&#x4E2A;&#x5B57;&#x6BB5;&#x7684;&#x503C;&#xFF0C;&#x5176;&#x4E00;&#x822C;&#x5F62;&#x5F0F;&#x4E3A;&#xFF1A;</p>
<pre><code>xxx sqlite3_column_xxx( sqlite3_stmt*, /* statement handle */
    int iCol /* column ordinal */);
</code></pre><p>xxx&#x8868;&#x793A;&#x4F60;&#x5E0C;&#x671B;&#x5F97;&#x5230;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x3002;sqlite3_column_xxx()&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x51FD;&#x6570;&#xFF1A;</p>
<pre><code>int sqlite3_column_int(sqlite3_stmt*, int iCol);
double sqlite3_column_double(sqlite3_stmt*, int iCol);
long long int sqlite3_column_int64(sqlite3_stmt*, int iCol);
const void *sqlite3_column_blob(sqlite3_stmt*, int iCol);
const unsigned char *sqlite3_column_text(sqlite3_stmt*, int iCol);
const void *sqlite3_column_text16(sqlite3_stmt*, int iCol);
</code></pre><p>&#x5BF9;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;SQLite&#x90FD;&#x4F1A;&#x5C06;&#x5B57;&#x6BB5;&#x503C;&#x4ECE;&#x5B58;&#x50A8;&#x7C7B;&#x8F6C;&#x5316;&#x4E3A;&#x51FD;&#x6570;&#x6307;&#x5B9A;&#x7684;&#x7ED3;&#x679C;&#x7C7B;&#x578B;&#x3002;Table 6-1&#x4E2D;&#x662F;&#x8F6C;&#x6362;&#x89C4;&#x5219;&#x3002;</p>
<p>Table 6-1. Column Type Conversion Rules</p>
<pre><code>Internal Type         Requested Type             Conversion
NULL                   INTEGER                    Result is 0\.
NULL                   FLOAT                         Result is 0.0\.
NULL                   TEXT                          Result is a NULL pointer.
</code></pre><h3 id="&#x4E00;&#x4E2A;&#x5B9E;&#x9645;&#x7684;&#x4F8B;&#x5B50;">&#x4E00;&#x4E2A;&#x5B9E;&#x9645;&#x7684;&#x4F8B;&#x5B50;</h3>
<p>To help solidify all of these column functions, Listing 6-7 (taken from columns.c) illustrates using the functions we&#x2019;ve described to retrieve column information and values for a simple SELECT statement.</p>
<p>Listing 6-7. Obtaining Column Information</p>
<pre><code>#include &lt;string.h&gt;
int main(int argc, char **argv)
{
    int rc, i, ncols, id, cid;
       char *name, *sql;
    sqlite3 *db; sqlite3_stmt *stmt;
       sql = &quot;select id,cid,name from episodes&quot;;
    sqlite3_open(&quot;test.db&quot;, &amp;db);
    sqlite3_prepare(db, sql, strlen(sql), &amp;stmt, NULL);
    ncols = sqlite3_column_count(stmt);
    rc = sqlite3_step(stmt);
    /* Print column information */
    for(i=0; i &lt; ncols; i++) {
        fprintf(stdout, &quot;Column: name=%s, storage class=%i, declared=%s\n&quot;,
                         sqlite3_column_name(stmt, i),
                         sqlite3_column_type(stmt, i),
                         sqlite3_column_decltype(stmt, i));
    }
    fprintf(stdout, &quot;\n&quot;);
    while(rc == SQLITE_ROW) {
        id = sqlite3_column_int(stmt, 0);
        cid = sqlite3_column_int(stmt, 1);
        name = (char *)sqlite3_column_text(stmt, 2);
        if(name != NULL){
            fprintf(stderr, &quot;Row:  id=%i, cid=%i, name=&apos;%s&apos;\n&quot;, id,cid,name);
        } else {
            /* Field is NULL */
            fprintf(stderr, &quot;Row:  id=%i, cid=%i, name=NULL\n&quot;, id,cid);
        }
        rc = sqlite3_step(stmt);
    }
    sqlite3_finalize(stmt);
    sqlite3_close(db);
    return 0;
}
</code></pre><h2 id="&#x53C2;&#x6570;&#x5316;&#x7684;&#x67E5;&#x8BE2;">&#x53C2;&#x6570;&#x5316;&#x7684;&#x67E5;&#x8BE2;</h2>
<p><img src="img/image011.jpg" alt=""></p>
<p>Figure 6-2. SQL parameter binding</p>
<h2 id="&#x9519;&#x8BEF;&#x548C;&#x610F;&#x5916;">&#x9519;&#x8BEF;&#x548C;&#x610F;&#x5916;</h2>
<p>&#x6709;&#x4E9B;API&#x662F;&#x5F88;&#x53EF;&#x80FD;&#x51FA;&#x9519;&#x7684;&#xFF0C;&#x5728;&#x7F16;&#x7801;&#x65F6;&#x603B;&#x8981;&#x8BB0;&#x5F97;3&#x4EF6;&#x4E8B;&#xFF1A;&#x9519;&#x8BEF;&#x3001;&#x5FD9;&#x72B6;&#x6001;&#x548C;schema&#x6539;&#x53D8;&#x3002;</p>
<h2 id="&#x5904;&#x7406;&#x9519;&#x8BEF;">&#x5904;&#x7406;&#x9519;&#x8BEF;</h2>
<p>&#x5F88;&#x591A;API&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x6574;&#x6570;&#x7ED3;&#x679C;&#x7801;&#xFF0C;&#x8FD9;&#x8868;&#x793A;&#x5B83;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x7801;&#x3002;&#x5728;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4E4B;&#x524D;&#xFF0C;&#x5E94;&#x8BE5;&#x4ED4;&#x7EC6;&#x9605;&#x8BFB;&#x5173;&#x4E8E;&#x8BE5;&#x51FD;&#x6570;&#x7684;&#x8BF4;&#x660E;(&#x89C1;&#x9644;&#x5F55;B)&#xFF0C;&#x770B;&#x5B83;&#x53EF;&#x80FD;&#x5F15;&#x53D1;&#x4EC0;&#x4E48;&#x9519;&#x8BEF;&#x3002;API&#x4E2D;&#x5B9A;&#x4E49;&#x4E86;&#x5927;&#x7EA6;23&#x79CD;&#x9519;&#x8BEF;&#x3002;&#x6240;&#x6709;&#x7684;SQLite&#x8FD4;&#x56DE;&#x7801;&#x89C1;&#x8868;6-2&#x3002;&#x6240;&#x6709;&#x80FD;&#x591F;&#x8FD4;&#x56DE;&#x8FD9;&#x4E9B;&#x7801;&#x7684;&#x51FD;&#x6570;&#x5305;&#x62EC;&#xFF1A;</p>
<pre><code>sqlite3_bind_xxx()
sqlite3_close()
sqlite3_create_collation()
sqlite3_collation_needed()
sqlite3_create_function()
sqlite3_prepare()
sqlite3_exec()
sqlite3_finalize()
sqlite3_get_table()
sqlite3_open()
sqlite3_reset()
sqlite3_step()
sqlite3_transfer_bindings()
</code></pre><p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x51FD;&#x6570;sqlite3_errmsg()&#x83B7;&#x5F97;&#x9644;&#x52A0;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF0C;&#x5176;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>const char *sqlite3_errmsg(sqlite3 *);
</code></pre><p>&#x5B83;&#x4EE5;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x53E5;&#x67C4;&#x4F5C;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x8BE5;&#x8FDE;&#x63A5;&#x6700;&#x8FD1;&#x7684;&#x4E00;&#x6761;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x3002;&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x6709;&#x53D1;&#x751F;&#x9519;&#x8BEF;&#xFF0C;&#x5B83;&#x8FD4;&#x56DE;&#x201C;not an error&#x201D;&#x3002;</p>
<p>&#x8868;6-2 SQLit&#x7684;&#x8FD4;&#x56DE;&#x7801;</p>
<table>
<thead>
<tr>
<th>&#x8FD4;&#x56DE;&#x7801;</th>
<th>&#x8BF4;&#x660E;</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQLITE_OK</td>
<td>The operation was successful.</td>
</tr>
<tr>
<td>SQLITE_ERROR</td>
<td>General SQL error or missing database. It may be possible to obtain more error information depending on the error condition (SQLITE_SCHEMA, for example).</td>
</tr>
<tr>
<td>SQLITE_PERM</td>
<td>Access permission denied. Cannot read or write to the database file.</td>
</tr>
<tr>
<td>SQLITE_ABORT</td>
<td>A callback routine requested an abort.</td>
</tr>
<tr>
<td>SQLITE_BUSY</td>
<td>The database file is locked.</td>
</tr>
<tr>
<td>SQLITE_LOCKED</td>
<td>A table in the database is locked.</td>
</tr>
<tr>
<td>SQLITE_NOMEM</td>
<td>A call to malloc() has failed within a database operation.</td>
</tr>
<tr>
<td>SQLITE_READONLY</td>
<td>An attempt was made to write to a read-only database.</td>
</tr>
<tr>
<td>SQLITE_INTERRUPT</td>
<td>Operation was terminated by sqlite3_interrupt().</td>
</tr>
<tr>
<td>SQLITE_IOERR</td>
<td>Some kind of disk I/O error occurred.</td>
</tr>
<tr>
<td>SQLITE_CORRUPT</td>
<td>The database disk image is malformed. This will also occur if an attempt is made to open a non-SQLite database file as a SQLite database. SQLITE_FULL Insertion failed because the database is full. There is no more space on the file system or the database file cannot be expanded.</td>
</tr>
<tr>
<td>SQLITE_CANTOPEN</td>
<td>SQLite was unable to open the database file.</td>
</tr>
<tr>
<td>SQLITE_PROTOCOL</td>
<td>The database is locked or there has been a protocol error.</td>
</tr>
<tr>
<td>SQLITE_EMPTY</td>
<td>(Internal only) The database table is empty.</td>
</tr>
<tr>
<td>SQLITE_SCHEMA</td>
<td>The database schema has changed.</td>
</tr>
<tr>
<td>SQLITE_CONSTRAINT</td>
<td>Abort due to constraint violation. This constant is returned if the SQL statement would have violated a database constraint (such as attempting to insert a value into a unique index that already exists in the index).</td>
</tr>
<tr>
<td>SQLITE_MISMATCH</td>
<td>Data type mismatch. An example of this is an attempt to insert non-integer data into a column labeled INTEGER PRIMARY KEY. For mostcolumns, SQLite ignores the data type and allows any kind of data to be stored. But an INTEGER PRIMARY KEY column is only allowed to store integer data.</td>
</tr>
<tr>
<td>SQLITE_MISUSE</td>
<td>Library was used incorrectly. This error might occur if one or more of the SQLite API routines is used incorrectly. Examples of incorrect usage include calling sqlite3_exec() after the database has been closed using sqlite3_close() or calling sqlite3_exec() with the same database pointer simultaneously from two separate threads.</td>
</tr>
<tr>
<td>SQLITE_NOLFS</td>
<td>Uses OS features not supported on host. This value is returned if the SQLite library was compiled with large file support (LFS) enabled butLFS isn&#x2019;t supported on the host operating system.</td>
</tr>
<tr>
<td>SQLITE_AUTH</td>
<td>Authorization denied. This occurs when a callback function installed using sqlite3_set_authorizer() returns SQLITE_DENY.</td>
</tr>
<tr>
<td>SQLITE_ROW</td>
<td>sqlite3_step() has another row ready.</td>
</tr>
<tr>
<td>SQLITE_DONE</td>
<td>sqlite3_step() has finished executing.</td>
</tr>
</tbody>
</table>
<h2 id="&#x5904;&#x7406;&#x5FD9;&#x72B6;&#x6001;">&#x5904;&#x7406;&#x5FD9;&#x72B6;&#x6001;</h2>
<h2 id="&#x64CD;&#x4F5C;&#x63A7;&#x5236;">&#x64CD;&#x4F5C;&#x63A7;&#x5236;</h2>
<p>API&#x63D0;&#x4F9B;&#x4E86;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x76D1;&#x89C6;&#x6216;&#x7BA1;&#x7406;&#x7F16;&#x8BD1;&#x671F;&#x95F4;&#x548C;&#x8FD0;&#x884C;&#x65F6;&#x7684;SQL&#x547D;&#x4EE4;&#x3002;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x5141;&#x8BB8;&#x4F60;&#x5EFA;&#x7ACB;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x4EE5;&#x6B64;&#x5BF9;&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x4EF6;&#x8FDB;&#x884C;&#x76D1;&#x89C6;&#x548C;&#x63A7;&#x5236;(&#x5F53;&#x4E8B;&#x4EF6;&#x53D1;&#x751F;&#x65F6;)&#x3002;</p>
<h2 id="&#x63D0;&#x4EA4;hook&#x51FD;&#x6570;">&#x63D0;&#x4EA4;Hook&#x51FD;&#x6570;</h2>
<p>&#x4F7F;&#x7528;sqlite3_commit_hook()&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x5728;&#x7279;&#x5B9A;&#x8FDE;&#x63A5;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x65F6;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x76D1;&#x89C6;&#x3002;&#x5176;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>void *sqlite3_commit_hook( sqlite3 *cnx, /* database handle */
    int(*xCallback)(void *data), /* callback function */
    void *data); /* application data */
</code></pre><h2 id="&#x56DE;&#x5377;hook&#x51FD;&#x6570;">&#x56DE;&#x5377;Hook&#x51FD;&#x6570;</h2>
<p>&#x56DE;&#x5377;Hook&#x51FD;&#x6570;&#x4E0E;&#x63D0;&#x4EA4;Hook&#x51FD;&#x6570;&#x76F8;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x5B83;&#x5728;&#x7279;&#x5B9A;&#x8FDE;&#x63A5;&#x56DE;&#x5377;&#x4E8B;&#x52A1;&#x65F6;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x76D1;&#x89C6;&#x3002;</p>
<pre><code>void *sqlite3_rollback_hook(sqlite3 *cnx, void(*xCallback)(void *data), void *data);
</code></pre><h2 id="&#x4FEE;&#x6539;hook&#x51FD;&#x6570;">&#x4FEE;&#x6539;Hook&#x51FD;&#x6570;</h2>
<p>&#x51FD;&#x6570;sqlite3_update_hook()&#x7528;&#x6765;&#x76D1;&#x89C6;&#x7279;&#x5B9A;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x6240;&#x6709;&#x7684;UPDATE&#x3001;INSERT&#x548C;DELETE&#x64CD;&#x4F5C;&#xFF0C;&#x5BF9;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x4E2D;&#x6240;&#x6D89;&#x53CA;&#x7684;&#x6BCF;&#x4E00;&#x884C;&#x90FD;&#x8FDB;&#x884C;&#x76D1;&#x89C6;&#xFF0C;&#x5176;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>void *sqlite3_update_hook(
    sqlite3 *cnx,
    void(*)(void *, int, char const*, char const*, sqlite_int64),
    void *data);
</code></pre><p>The first argument of the callback function is a pointer to application-specific data, which you provide in the third argument. The callback function has the following form:</p>
<pre><code>void callback ( void * data,
    int operation_code,
    char const *db_name,
    char const *table_name,
    sqlite_int64 rowid),
</code></pre><h2 id="&#x6388;&#x6743;&#x51FD;&#x6570;">&#x6388;&#x6743;&#x51FD;&#x6570;</h2>
<p>sqlite3_set_authorizer()&#x662F;&#x6700;&#x5F3A;&#x6709;&#x529B;&#x7684;&#x4E8B;&#x4EF6;&#x8FC7;&#x6EE4;&#x51FD;&#x6570;&#x3002;&#x7528;&#x5B83;&#x53EF;&#x4EE5;&#x5728;&#x67E5;&#x8BE2;&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x76D1;&#x89C6;&#x548C;&#x63A7;&#x5236;&#x3002;&#x5176;&#x58F0;&#x660E;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>int sqlite3_set_authorizer(
    sqlite3*,
    int (*xAuth)( void*,int,
        const char*, const char*,
        const char*,const char*),
    void *pUserData
    );
</code></pre><p>&#x5176;&#x4E2D;&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x4E2A;callback&#x51FD;&#x6570;&#xFF0C;&#x4F5C;&#x4E3A;&#x6388;&#x6743;&#x51FD;&#x6570;&#x3002;SQLite&#x5728;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x4EF6;&#x7684;&#x547D;&#x4EE4;&#x7F16;&#x8BD1;&#x9636;&#x6BB5;&#x5C06;&#x4F1A;&#x8C03;&#x7528;&#x5B83;(&#x4E0D;&#x662F;&#x5728;&#x6267;&#x884C;&#x9636;&#x6BB5;)&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x7528;&#x610F;&#x662F;&#x4F7F;&#x7528;SQLite&#x80FD;&#x591F;&#x5B89;&#x5168;&#x5730;&#x6267;&#x884C;&#x7528;&#x6237;&#x63D0;&#x4F9B;&#x7684;SQL(user-supplied SQL)&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x9014;&#x5F84;&#x5C06;&#x8FD9;&#x7C7B;SQL&#x9650;&#x5236;&#x5728;&#x7279;&#x5B9A;&#x7684;&#x64CD;&#x4F5C;&#x4E0A;&#x6216;&#x62D2;&#x7EDD;&#x5BF9;&#x67D0;&#x4E9B;&#x8868;&#x6216;&#x5B57;&#x6BB5;&#x7684;&#x5B58;&#x53D6;&#x3002;</p>
<p>Callback&#x7684;&#x58F0;&#x660E;&#x5F62;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>int auth( void*, /* user data */
    int, /* event code */
    const char*, /* event specific */
    const char*, /* event specific */
    const char*, /* database name */
    const char* /* trigger or view name */ );
</code></pre><p>&#x7B2C;1&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x6307;&#x9488;&#xFF0C;&#x5B83;&#x4F1A;&#x4F20;&#x9012;&#x7ED9;sqlite3_set_authorizer()&#x51FD;&#x6570;&#x7684;&#x7B2C;4&#x4E2A;&#x53C2;&#x6570;&#x3002;&#x7B2C;2&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x91CF;&#xFF0C;&#x53EF;&#x9009;&#x503C;&#x5728;&#x8868;6-3&#x4E2D;&#x5217;&#x51FA;&#x3002;&#x8FD9;&#x4E9B;&#x5E38;&#x91CF;&#x503C;&#x8868;&#x793A;&#x9700;&#x8981;&#x6388;&#x6743;&#x7684;&#x662F;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;&#x3002;&#x7B2C;3&#x3001;4&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x542B;&#x4E49;&#x51B3;&#x5B9A;&#x4E8E;&#x4E8B;&#x4EF6;&#x4EE3;&#x7801;(&#x7B2C;2&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x53C2;&#x8868;6-3)&#x3002;</p>
<p>&#x7B2C;5&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x6570;&#x636E;&#x5E93;&#x540D;&#x3002;&#x7B2C;6&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x6700;&#x5185;&#x5C42;&#x89E6;&#x53D1;&#x5668;&#x6216;&#x89C6;&#x56FE;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x89E6;&#x53D1;&#x5668;&#x6216;&#x89C6;&#x56FE;&#x4F01;&#x56FE;&#x5B58;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;NULL&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x8FD9;&#x79CD;&#x5B58;&#x53D6;&#x7684;&#x4F01;&#x56FE;&#x662F;&#x76F4;&#x63A5;&#x7531;&#x9876;&#x5C42;&#x7684;SQL&#x5F15;&#x53D1;&#x7684;&#x3002;</p>
<p>&#x6388;&#x6743;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x5E94;&#x8BE5;&#x662F;SQLITE_OK&#x3001;SQLITE_DENY&#x6216;SQLITE_IGNORE&#x4E4B;&#x4E00;&#x3002;&#x524D;&#x4E24;&#x4E2A;&#x503C;&#x7684;&#x542B;&#x4E49;&#x5BF9;&#x6240;&#x6709;&#x4E8B;&#x4EF6;&#x90FD;&#x662F;&#x786E;&#x5B9A;&#x7684;&#x2014;&#x2014;&#x63A5;&#x53D7;&#x6216;&#x62D2;&#x7EDD;SQL&#x3002;SQLITE_DENY&#x5C06;&#x4F1A;&#x53D6;&#x6D88;&#x6574;&#x4E2A;SQL&#x8BED;&#x53E5;&#x7684;&#x6267;&#x884C;&#x5E76;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x3002;</p>
<p>SQLITE_IGNORE&#x7684;&#x542B;&#x4E49;&#x4E0E;&#x4E8B;&#x4EF6;&#x6709;&#x5173;&#x3002;&#x5982;&#x679C;SQL&#x8BED;&#x53E5;&#x662F;&#x8BFB;&#x6216;&#x6539;&#x8BB0;&#x5F55;&#xFF0C;&#x4F1A;&#x5728;&#x8BED;&#x53E5;&#x8BD5;&#x56FE;&#x64CD;&#x4F5C;&#x7684;&#x6BCF;&#x4E2A;&#x5B57;&#x6BB5;&#x4E0A;&#x4EA7;&#x751F;SQLITE_READ&#x6216;SQLITE_UPDATE&#x4E8B;&#x4EF6;&#x3002;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x56DE;&#x53EB;&#x51FD;&#x6570;&#x8FD4;&#x56DE;SQLITE_IGNORE&#xFF0C;&#x8FD9;&#x4E9B;&#x5B57;&#x6BB5;&#x5C06;&#x4ECE;&#x64CD;&#x4F5C;&#x4E2D;&#x88AB;&#x6392;&#x9664;(&#x9AD8;&#xFF1A;&#x522B;&#x7684;&#x5B57;&#x6BB5;&#x7EE7;&#x7EED;&#x64CD;&#x4F5C;&#xFF0C;&#x8FD9;&#x4E9B;&#x5B57;&#x6BB5;&#x5C31;&#x4E0D;&#x64CD;&#x4F5C;&#x4E86;)&#x3002;&#x5177;&#x4F53;&#x8BF4;&#xFF0C;&#x8BD5;&#x56FE;&#x8BFB;&#x7684;&#x8FD4;&#x56DE;NULL&#xFF0C;&#x8BD5;&#x56FE;&#x5199;&#x7684;&#x5219;&#x4EC0;&#x4E48;&#x4E5F;&#x4E0D;&#x505A;(silently fail)&#x3002;</p>
<p>&#x8868;6-3 SQLite&#x7684;&#x6388;&#x6743;&#x4E8B;&#x4EF6;</p>
<table>
<thead>
<tr>
<th>&#x4E8B;&#x4EF6;&#x4EE3;&#x7801;</th>
<th>&#x53C2;&#x6570;3</th>
<th>&#x53C2;&#x6570;4</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQLITE_CREATE_INDEX</td>
<td>Index name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_CREATE_TABLE</td>
<td>Table name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_CREATE_TEMP_INDEX</td>
<td>Index name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_CREATE_TEMP_TABLE</td>
<td>Table name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_CREATE_TEMP_TRIGGER</td>
<td>Trigger name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_CREATE_TEMP_VIEW</td>
<td>View name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_CREATE_TRIGGER</td>
<td>Trigger name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_CREATE_VIEW</td>
<td>View name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_DELETE</td>
<td>Table name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_DROP_INDEX</td>
<td>Index name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_DROP_TABLE</td>
<td>Table name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_DROP_TEMP_INDEX</td>
<td>Index name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_DROP_TEMP_TABLE</td>
<td>Table name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_DROP_TEMP_TRIGGER</td>
<td>Trigger name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_DROP_TEMP_VIEW</td>
<td>View name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_DROP_TRIGGER</td>
<td>Trigger name</td>
<td>Table name</td>
</tr>
<tr>
<td>SQLITE_DROP_VIEW</td>
<td>View name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_INSERT</td>
<td>Table name</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_PRAGMA</td>
<td>Pragma name</td>
<td>First argument or NULL</td>
</tr>
<tr>
<td>SQLITE_READ</td>
<td>Table name</td>
<td>Column name</td>
</tr>
<tr>
<td>SQLITE_SELECT</td>
<td>NULL</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_TRANSACTION</td>
<td>NULL</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_UPDATE</td>
<td>Table name</td>
<td>Column name</td>
</tr>
<tr>
<td>SQLITE_ATTACH</td>
<td>Filename</td>
<td>NULL</td>
</tr>
<tr>
<td>SQLITE_DETACH</td>
<td>Database name</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>&#x4E0B;&#x9762;&#x4F8B;&#x5B50;&#x8BF4;&#x660E;&#x6388;&#x6743;&#x51FD;&#x6570;&#x7684;&#x4F7F;&#x7528;(&#x5B8C;&#x6574;&#x7684;&#x7A0B;&#x5E8F;&#x5728;authorizer.c&#x4E2D;)&#x3002;</p>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x957F;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x4F1A;&#x7528;&#x6388;&#x6743;&#x51FD;&#x6570;&#x5BF9;&#x5F88;&#x591A;&#x4E0D;&#x540C;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x4EF6;&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x7A0B;&#x5E8F;&#x7247;&#x6BB5;&#x6765;&#x8FDB;&#x884C;&#x8BF4;&#x660E;&#x3002;&#x89C1;&#x5217;&#x8868;6-10&#x3002;</p>
<p>&#x5217;&#x8868;6-10 &#x6388;&#x6743;&#x51FD;&#x6570;&#x793A;&#x4F8B;</p>
<p>&#x6388;&#x6743;&#x51FD;&#x6570;&#x7684;&#x4E00;&#x822C;&#x5F62;&#x5F0F;&#x4E3A;&#xFF1A;</p>
<pre><code>int auth( void* x, int type,
          const char* a, const char* b,
          const char* c, const char* d )
{
    const char* operation = a;
    //printf( &quot;    %s &quot;, event_description(type));
    /* Filter for different database events
    ** from SQLITE_TRANSACTION to SQLITE_INSERT,
    ** UPDATE, DELETE, ATTACH, etc. and either allow or deny
    ** them.
    */
    return SQLITE_OK;
}
</code></pre><p>&#x6388;&#x6743;&#x51FD;&#x6570;&#x505A;&#x7684;&#x7B2C;1&#x4EF6;&#x4E8B;&#x662F;&#xFF1A;&#x770B;&#x770B;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x662F;&#x5426;&#x6539;&#x53D8;&#xFF1B;&#x5982;&#x679C;&#x6539;&#x53D8;&#xFF0C;&#x5219;&#x8F93;&#x51FA;&#x4E00;&#x4E2A;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre><code>    if((a != NULL) &amp;&amp; (type == SQLITE_TRANSACTION)) {
        printf(&quot;: %s &#xEA;&#xC2;&#xCE;&#xF1;&quot;, operation);
    }
</code></pre><p>&#x4E0B;&#x4E00;&#x6B65;&#x662F;&#x5BF9;&#x5F15;&#x8D77;schema&#x6539;&#x53D8;&#x7684;&#x4E8B;&#x4EF6;&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#xFF1A;</p>
<pre><code>    switch(type) {
        case SQLITE_CREATE_INDEX:
        case SQLITE_CREATE_TABLE:
        case SQLITE_CREATE_TRIGGER:
        case SQLITE_CREATE_VIEW:
        case SQLITE_DROP_INDEX:
        case SQLITE_DROP_TABLE:
        case SQLITE_DROP_TRIGGER:
        case SQLITE_DROP_VIEW:
        {
            printf(&quot;: Schema&#xB8;&#xC4;&#xB1;&#xE4;&#xE1;&#xCB;&#xA1;&#xFFE1;&quot;);
        }
    }
</code></pre><p>&#x4E0B;&#x4E00;&#x6B65;&#x662F;&#x5BF9;&#x8BFB;&#x7684;&#x4F01;&#x56FE;&#x8FDB;&#x884C;&#x68C0;&#x67E5;&#xFF0C;&#x8FD9;&#x79CD;&#x4F01;&#x56FE;&#x662F;&#x57FA;&#x4E8E;&#x5B57;&#x6BB5;&#x7684;&#x3002;&#x8FD9;&#x91CC;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x8BFB;&#x90FD;&#x88AB;&#x5141;&#x8BB8;&#xFF0C;&#x9664;&#x4E86;z&#x5B57;&#x6BB5;&#x3002;&#x5F53;&#x8981;&#x8BFB;z&#x5B57;&#x6BB5;&#x65F6;&#xFF0C;&#x51FD;&#x6570;&#x8FD4;&#x56DE;SQLITE_IGNORE&#xFF0C;&#x8FD9;&#x5C06;&#x5BFC;&#x81F4;SQLite&#x5728;&#x8BFB;&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x65F6;&#x8FD4;&#x56DE;NULL&#xFF0C;&#x4ECE;&#x800C;&#x6709;&#x6548;&#x5730;&#x4FDD;&#x62A4;&#x5176;&#x6570;&#x636E;&#x3002;</p>
<pre><code>    if(type == SQLITE_READ) {
        printf(&quot;: Read of %s.%s &quot;, a, b);
        /* Block attempts to read column z */
        if(strcmp(b,&quot;z&quot;)==0) {
            printf(&quot;-&gt; DENIED\n&quot;);
            return SQLITE_IGNORE;
        }
    }
</code></pre><p>&#x4E0B;&#x9762;&#x662F;INSERT&#x548C;UPDATE&#x7684;&#x8FC7;&#x6EE4;&#x3002;&#x6240;&#x6709;&#x7684;&#x63D2;&#x5165;&#x88AB;&#x5141;&#x8BB8;&#x3002;&#x5BF9;x&#x5B57;&#x6BB5;&#x7684;&#x4FEE;&#x6539;&#x88AB;&#x62D2;&#x7EDD;&#x3002;&#x8FD9;&#x6837;&#x4E0D;&#x4F1A;&#x9501;&#x4F4F;UPDATE&#x7684;&#x6267;&#x884C;&#xFF0C;&#x800C;&#x662F;&#x7B80;&#x5355;&#x5730;&#x8FC7;&#x6EE4;&#x6389;&#x5BF9;x&#x5B57;&#x6BB5;&#x7684;&#x4FEE;&#x6539;&#x4F01;&#x56FE;&#x3002;</p>
<pre><code>    if(type == SQLITE_INSERT) {
        printf(&quot;: 2&#xE5;&#xE8;&#xEB;&#xBC;&#xC7;&#xC2;&#xBC; into %s &quot;, a);
    }
    if(type == SQLITE_UPDATE) {
        printf(&quot;: Update of %s.%s &quot;, a, b);
        /* Block updates of column x */
        if(strcmp(b,&quot;x&quot;)==0) {
            printf(&quot;-&gt; DENIED\n&quot;);
            return SQLITE_IGNORE;
        }
    }
</code></pre><p>&#x6700;&#x540E;&#xFF0C;&#x5BF9;DELETE&#x3001;ATTACH&#x548C;DETACH&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#xFF0C;&#x5728;&#x9047;&#x5230;&#x8FD9;&#x4E9B;&#x4E8B;&#x4EF6;&#x65F6;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x5730;&#x7ED9;&#x51FA;&#x901A;&#x77E5;&#x3002;</p>
<pre><code>    if(type == SQLITE_DELETE) {
        printf(&quot;: Delete from %s &quot;, a);
    }
    if(type == SQLITE_ATTACH) {
        printf(&quot;: %s&quot;, a);
    }
    if(type == SQLITE_DETACH) {
        printf(&quot;-&gt; %s&quot;, a);
    }
</code></pre><p>&#x4E0B;&#x9762;&#x662F;&#x4E3B;&#x7A0B;&#x5E8F;&#xFF0C;&#x4E3A;&#x4E86;&#x4ECB;&#x7ECD;&#x7684;&#x65B9;&#x4FBF;&#xFF0C;&#x4E5F;&#x4F1A;&#x5206;&#x6210;&#x591A;&#x4E2A;&#x7247;&#x6BB5;&#x3002;</p>
<pre><code>int main(int argc, char **argv)
{
    sqlite3 *db, *db2;
    char *zErr;
    int rc;
    /* -------------------------------------------------------------------------
    **  Setup                                                                 
    ** -------------------------------------------------------------------------
    */
    /* Connect to test.db */
    rc = sqlite3_open(&quot;test.db&quot;, &amp;db);
    if(rc) {
        fprintf(stderr, &quot;Can&apos;t open database: %s\n&quot;, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }
    /* -------------------------------------------------------------------------
    **  Authorize and test
    ** -------------------------------------------------------------------------
    */
    /* Register the authorizer function */
    sqlite3_set_authorizer(db, auth, NULL);
    /* Test transactions events */
    printf(&quot;program : Starting transaction\n&quot;);
    sqlite3_exec(db, &quot;BEGIN&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Committing transaction\n&quot;);
    sqlite3_exec(db, &quot;COMMIT&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Starting transaction\n&quot;);
    sqlite3_exec(db, &quot;BEGIN&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Aborting transaction\n&quot;);
    sqlite3_exec(db, &quot;ROLLBACK&quot;, NULL, NULL, &amp;zErr);
    // Test table events
    printf(&quot;program : Creating table\n&quot;);
    sqlite3_exec(db, &quot;create table foo(x int, y int, z int)&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Inserting record\n&quot;);
    sqlite3_exec(db, &quot;insert into foo values (1,2,3)&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Selecting record (value for z should be NULL)\n&quot;);
    print_sql_result(db, &quot;select * from foo&quot;);
    printf(&quot;program : Updating record (update of x should be denied)\n&quot;);
    sqlite3_exec(db, &quot;update foo set x=4, y=5, z=6&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Selecting record (notice x was not updated)\n&quot;);
    print_sql_result(db, &quot;select * from foo&quot;);
    printf(&quot;program : Deleting record\n&quot;);
    sqlite3_exec(db, &quot;delete from foo&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Dropping table\n&quot;);
    sqlite3_exec(db, &quot;drop table foo&quot;, NULL, NULL, &amp;zErr);
</code></pre><p>Several things are going on here. The program selects all records in the table, one of which is</p>
<p>column z. We should see in the output that column z&#x2019;s value is NULL. All other fields should</p>
<p>contain data from the table. Next, the program attempts to update all fields, the most important</p>
<p>of which is column x. The update should succeed, but the value in column x should be</p>
<p>unchanged, as the authorizer denies it. This is confirmed on the following SELECT statement,</p>
<p>which shows that all columns were updated except for column x, which is unchanged. The</p>
<p>program then drops the foo table, which should issue a schema change notification from the</p>
<p>previous filter.</p>
<pre><code>    // Test ATTACH/DETACH
    // Connect to test2.db
    rc = sqlite3_open(&quot;test2.db&quot;, &amp;db2);
    if(rc) {
        fprintf(stderr, &quot;Can&apos;t open database: %s\n&quot;, sqlite3_errmsg(db2));
        sqlite3_close(db2);
        exit(1);
     }
    // Drop table foo2 in test2 if exists
    sqlite3_exec(db2, &quot;drop table foo2&quot;, NULL, NULL, &amp;zErr);
    sqlite3_exec(db2, &quot;create table foo2(x int, y int, z int)&quot;, NULL, NULL, &amp;zErr);
    // Attach database test2.db to test.db
    printf(&quot;program : Attaching database test2.db\n&quot;);
    sqlite3_exec(db, &quot;attach &apos;test2.db&apos; as test2&quot;, NULL, NULL, &amp;zErr);
    // Select record from test2.db foo2 in test.db
    printf(&quot;program : Selecting record from attached database test2.db\n&quot;);
    sqlite3_exec(db, &quot;select * from foo2&quot;, NULL, NULL, &amp;zErr);
    printf(&quot;program : Detaching table\n&quot;);
    sqlite3_exec(db, &quot;detach test2&quot;, NULL, NULL, &amp;zErr);
    /* -------------------------------------------------------------------------
    **  Cleanup
    ** -------------------------------------------------------------------------
    */
    sqlite3_close(db);
    sqlite3_close(db2);
    return 0;   
}
</code></pre><h2 id="&#x7EBF;&#x7A0B;">&#x7EBF;&#x7A0B;</h2>
<p>&#x5982;&#x7B2C;2&#x7AE0;&#x6240;&#x8FF0;&#xFF0C;SQLite&#x652F;&#x6301;&#x7EBF;&#x7A0B;&#x3002;&#x5728;&#x591A;&#x7EBF;&#x7A0B;&#x73AF;&#x5883;&#x4E0B;&#x4F7F;&#x7528;SQLite&#x65F6;&#xFF0C;&#x6709;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x89C4;&#x5219;&#x9700;&#x8981;&#x9075;&#x5B88;&#x3002;</p>
<h2 id="&#x5171;&#x4EAB;&#x7F13;&#x51B2;&#x533A;&#x6A21;&#x5F0F;">&#x5171;&#x4EAB;&#x7F13;&#x51B2;&#x533A;&#x6A21;&#x5F0F;</h2>
<p><img src="img/image012.jpg" alt=""></p>
<p>Figure 6-3. The shared cache model</p>
<p>&#x5171;&#x4EAB;&#x7F13;&#x51B2;&#x533A;&#x6A21;&#x5F0F;&#x7684;&#x76EE;&#x5F55;&#x662F;&#x4E3A;&#x4E86;&#x8282;&#x7701;&#x5185;&#x5728;&#xFF0C;SQLite&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x662F;&#x4E0E;&#x7EBF;&#x7A0B;&#x548C;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x6709;&#x5173;&#x7684;&#x3002;&#x4F7F;&#x7528;&#x5B83;&#x4EEC;&#x53EF;&#x4EE5;&#x9650;&#x5236;&#x5806;&#x7684;&#x5C3A;&#x5BF8;&#x6216;&#x624B;&#x5DE5;&#x5730;&#x53D1;&#x8D77;&#x5185;&#x5B58;&#x6E05;&#x7406;&#x3002;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x5305;&#x62EC;&#xFF1A;</p>
<pre><code>void sqlite3_soft_heap_limit(int N);
int sqlite3_release_memory(int N);
void sqlite3_thread_cleanup(void);
</code></pre>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./7.html" class="navigation navigation-prev " aria-label="Previous page: 第5章  设计和概念"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./9.html" class="navigation navigation-next " aria-label="Next page: 第7章  扩充C API"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="gitbook/plugins/gitbook-plugin-comment/plugin.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"comment":{"highlightCommented":true},"autocover":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
