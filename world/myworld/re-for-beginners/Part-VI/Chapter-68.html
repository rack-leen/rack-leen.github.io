
<!DOCTYPE HTML>
<html lang="zh" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Windows-NT · 逆向工程入门指南</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        <meta name="author" content="wizardforcel">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-comment/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Part-VII/part7.html" />
    
    
    <link rel="prev" href="Chapter-67.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="輸入並搜尋" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://www.gitbook.com/book/wizardforcel/re-for-beginners" target="_blank" class="custom-link">逆向工程入门指南</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    逆向工程入门指南
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Part-I/part1.html">
            
                <a href="../Part-I/part1.html">
            
                    
                    Part I 代码模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Part-I/Chapter-01.html">
            
                <a href="../Part-I/Chapter-01.html">
            
                    
                    CPU简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Part-I/Chapter-02.html">
            
                <a href="../Part-I/Chapter-02.html">
            
                    
                    最简单的函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Part-I/Chapter-03.html">
            
                <a href="../Part-I/Chapter-03.html">
            
                    
                    Hello,world!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Part-I/Chapter-04.html">
            
                <a href="../Part-I/Chapter-04.html">
            
                    
                    函数的开始和结束
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Part-I/Chapter-05.html">
            
                <a href="../Part-I/Chapter-05.html">
            
                    
                    栈
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../Part-I/Chapter-06.html">
            
                <a href="../Part-I/Chapter-06.html">
            
                    
                    printf()与参数处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../Part-I/Chapter-07.html">
            
                <a href="../Part-I/Chapter-07.html">
            
                    
                    scanf()
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="../Part-I/Chapter-08.html">
            
                <a href="../Part-I/Chapter-08.html">
            
                    
                    访问实参
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="../Part-I/Chapter-09.html">
            
                <a href="../Part-I/Chapter-09.html">
            
                    
                    一个或者多个字的返回值
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="../Part-I/Chapter-10.html">
            
                <a href="../Part-I/Chapter-10.html">
            
                    
                    指针
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.11" data-path="../Part-I/Chapter-11.html">
            
                <a href="../Part-I/Chapter-11.html">
            
                    
                    GOTO操作符
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.12" data-path="../Part-I/Chapter-12.html">
            
                <a href="../Part-I/Chapter-12.html">
            
                    
                    条件转跳
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.13" data-path="../Part-I/Chapter-13.html">
            
                <a href="../Part-I/Chapter-13.html">
            
                    
                    选择结构switch()/case/default
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.14" data-path="../Part-I/Chapter-14.html">
            
                <a href="../Part-I/Chapter-14.html">
            
                    
                    循环
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.15" data-path="../Part-I/Chapter-15.html">
            
                <a href="../Part-I/Chapter-15.html">
            
                    
                    对C-Strings的简单处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.16" data-path="../Part-I/Chapter-16.html">
            
                <a href="../Part-I/Chapter-16.html">
            
                    
                    用其他东西代替算数操作符
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.17" data-path="../Part-I/Chapter-17.html">
            
                <a href="../Part-I/Chapter-17.html">
            
                    
                    浮点数单元
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.18" data-path="../Part-I/Chapter-18.html">
            
                <a href="../Part-I/Chapter-18.html">
            
                    
                    数组
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.19" data-path="../Part-I/Chapter-19.html">
            
                <a href="../Part-I/Chapter-19.html">
            
                    
                    操纵特定的bit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.20" data-path="../Part-I/Chapter-20.html">
            
                <a href="../Part-I/Chapter-20.html">
            
                    
                    用线性同余生成器来产生伪随机数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.21" data-path="../Part-I/Chapter-21.html">
            
                <a href="../Part-I/Chapter-21.html">
            
                    
                    结构体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.22" data-path="../Part-I/Chapter-22.html">
            
                <a href="../Part-I/Chapter-22.html">
            
                    
                    联合体
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.23" data-path="../Part-I/Chapter-23.html">
            
                <a href="../Part-I/Chapter-23.html">
            
                    
                    指向函数的指针
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.24" data-path="../Part-I/Chapter-24.html">
            
                <a href="../Part-I/Chapter-24.html">
            
                    
                    在32位环境中的64位值
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.25" data-path="../Part-I/Chapter-25.html">
            
                <a href="../Part-I/Chapter-25.html">
            
                    
                    SIMD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.26" data-path="../Part-I/Chapter-26.html">
            
                <a href="../Part-I/Chapter-26.html">
            
                    
                    64位化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.27" data-path="../Part-I/Chapter-27.html">
            
                <a href="../Part-I/Chapter-27.html">
            
                    
                    使用SIMD来处理浮点数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.28" data-path="../Part-I/Chapter-28.html">
            
                <a href="../Part-I/Chapter-28.html">
            
                    
                    关于ARM的特殊细节
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.29" data-path="../Part-I/Chapter-29.html">
            
                <a href="../Part-I/Chapter-29.html">
            
                    
                    关于MIPS的特殊细节
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Part-II/part2.html">
            
                <a href="../Part-II/part2.html">
            
                    
                    Part II 重要的基础知识
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Part-II/Chapter-30.html">
            
                <a href="../Part-II/Chapter-30.html">
            
                    
                    有符号数的表示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Part-II/Chapter-31.html">
            
                <a href="../Part-II/Chapter-31.html">
            
                    
                    字节序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Part-II/Chapter-32.html">
            
                <a href="../Part-II/Chapter-32.html">
            
                    
                    内存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Part-II/Chapter-33.html">
            
                <a href="../Part-II/Chapter-33.html">
            
                    
                    CPU
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Part-II/Chapter-34.html">
            
                <a href="../Part-II/Chapter-34.html">
            
                    
                    哈希函数
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Part-III/part3.html">
            
                <a href="../Part-III/part3.html">
            
                    
                    Part III 更高级些的例子
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../Part-III/Chapter-35.html">
            
                <a href="../Part-III/Chapter-35.html">
            
                    
                    温度转换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../Part-III/Chapter-36.html">
            
                <a href="../Part-III/Chapter-36.html">
            
                    
                    斐波那契数列
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../Part-III/Chapter-37.html">
            
                <a href="../Part-III/Chapter-37.html">
            
                    
                    CRC32的计算实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../Part-III/Chapter-38.html">
            
                <a href="../Part-III/Chapter-38.html">
            
                    
                    网址的计算实例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../Part-III/Chapter-39.html">
            
                <a href="../Part-III/Chapter-39.html">
            
                    
                    循环:几个迭代器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../Part-III/Chapter-40.html">
            
                <a href="../Part-III/Chapter-40.html">
            
                    
                    Duff’s device
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../Part-III/Chapter-41.html">
            
                <a href="../Part-III/Chapter-41.html">
            
                    
                    除以9
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../Part-III/Chapter-42.html">
            
                <a href="../Part-III/Chapter-42.html">
            
                    
                    将字符串转化为数字(atoi())
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../Part-III/Chapter-43.html">
            
                <a href="../Part-III/Chapter-43.html">
            
                    
                    内联函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../Part-III/Chapter-44.html">
            
                <a href="../Part-III/Chapter-44.html">
            
                    
                    C99 的约束
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11" data-path="../Part-III/Chapter-45.md">
            
                <span>
            
                    
                    无分支的abs()函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.12" data-path="../Part-III/Chapter-46.md">
            
                <span>
            
                    
                    参数可变的函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.13" data-path="../Part-III/Chapter-47.md">
            
                <span>
            
                    
                    字符串截取
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.14" data-path="../Part-III/Chapter-48.md">
            
                <span>
            
                    
                    toupper()函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.15" data-path="../Part-III/Chapter-49.html">
            
                <a href="../Part-III/Chapter-49.html">
            
                    
                    不正确的反汇编代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.16" data-path="../Part-III/Chapter-50.html">
            
                <a href="../Part-III/Chapter-50.html">
            
                    
                    花指令
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.17" data-path="../Part-III/Chapter-51.html">
            
                <a href="../Part-III/Chapter-51.html">
            
                    
                    C++
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.18" data-path="../Part-III/Chapter-52.html">
            
                <a href="../Part-III/Chapter-52.html">
            
                    
                    负的数组引索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.19" data-path="../Part-III/Chapter-53.html">
            
                <a href="../Part-III/Chapter-53.html">
            
                    
                    Windoes 16-bit
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../Part-IV/part4.html">
            
                <a href="../Part-IV/part4.html">
            
                    
                    Part IV JAVA
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../Part-IV/Chapter-54.html">
            
                <a href="../Part-IV/Chapter-54.html">
            
                    
                    Java
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Part-V/part5.html">
            
                <a href="../Part-V/part5.html">
            
                    
                    Part V 在代码里面寻找重要又有趣的东西
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Part-V/Chapter-55.html">
            
                <a href="../Part-V/Chapter-55.html">
            
                    
                    可执行文件的识别
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Part-V/Chapter-56.html">
            
                <a href="../Part-V/Chapter-56.html">
            
                    
                    和外部世界的交流(win32)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Part-V/Chapter-57.html">
            
                <a href="../Part-V/Chapter-57.html">
            
                    
                    字符串
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Part-V/Chapter-58.html">
            
                <a href="../Part-V/Chapter-58.html">
            
                    
                    调用断言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Part-V/Chapter-59.html">
            
                <a href="../Part-V/Chapter-59.html">
            
                    
                    常量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../Part-V/Chapter-60.html">
            
                <a href="../Part-V/Chapter-60.html">
            
                    
                    找到真正的指令
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="../Part-V/Chapter-61.html">
            
                <a href="../Part-V/Chapter-61.html">
            
                    
                    可疑代码的模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="../Part-V/Chapter-62.html">
            
                <a href="../Part-V/Chapter-62.html">
            
                    
                    在追踪时使用Magic numbers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="../Part-V/Chapter-63.html">
            
                <a href="../Part-V/Chapter-63.html">
            
                    
                    其他东西
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="part6.html">
            
                <a href="part6.html">
            
                    
                    Part VI 操作系统的特性
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="Chapter-64.html">
            
                <a href="Chapter-64.html">
            
                    
                    参数传递方法(调用规则)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="Chapter-65.html">
            
                <a href="Chapter-65.html">
            
                    
                    本地线程储存区
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="Chapter-66.html">
            
                <a href="Chapter-66.html">
            
                    
                    系统调用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="Chapter-67.html">
            
                <a href="Chapter-67.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7.5" data-path="Chapter-68.html">
            
                <a href="Chapter-68.html">
            
                    
                    Windows-NT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../Part-VII/part7.html">
            
                <a href="../Part-VII/part7.html">
            
                    
                    Part VII 工具
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../Part-VII/Chapter-69.html">
            
                <a href="../Part-VII/Chapter-69.html">
            
                    
                    反汇编器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../Part-VII/Chapter-70.html">
            
                <a href="../Part-VII/Chapter-70.html">
            
                    
                    调试器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../Part-VII/Chapter-71.html">
            
                <a href="../Part-VII/Chapter-71.html">
            
                    
                    系统调用的追踪
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../Part-VII/Chapter-72.html">
            
                <a href="../Part-VII/Chapter-72.html">
            
                    
                    反编译器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../Part-VII/Chapter-73.html">
            
                <a href="../Part-VII/Chapter-73.html">
            
                    
                    其他工具
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../Part-IX/part9.html">
            
                <a href="../Part-IX/part9.html">
            
                    
                    Part IX 逆向文件格式的例子
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../Part-IX/Chapter-84.html">
            
                <a href="../Part-IX/Chapter-84.html">
            
                    
                    基本的异或加密
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../Part-IX/Chapter-85.html">
            
                <a href="../Part-IX/Chapter-85.html">
            
                    
                    Millenium 的存档文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../Part-IX/Chapter-86.html">
            
                <a href="../Part-IX/Chapter-86.html">
            
                    
                    Oracle RDBMS SYM-files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="../Part-IX/Chapter-87.html">
            
                <a href="../Part-IX/Chapter-87.html">
            
                    
                    Oracle RDBMS MSB-files
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../Afterword/part12.html">
            
                <a href="../Afterword/part12.html">
            
                    
                    后记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../Afterword/Chapter-99.html">
            
                <a href="../Afterword/Chapter-99.html">
            
                    
                    附录
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../Appendix/Appendix.html">
            
                <a href="../Appendix/Appendix.html">
            
                    
                    附录
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../Appendix/Appendix-A.html">
            
                <a href="../Appendix/Appendix-A.html">
            
                    
                    x86
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.2" data-path="../Appendix/Appendix-B.html">
            
                <a href="../Appendix/Appendix-B.html">
            
                    
                    ARM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.3" data-path="../Appendix/Appendix-C.html">
            
                <a href="../Appendix/Appendix-C.html">
            
                    
                    MIPS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.4" data-path="../Appendix/Appendix-D.html">
            
                <a href="../Appendix/Appendix-D.html">
            
                    
                    一些GCC库函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.5" data-path="../Appendix/Appendix-E.html">
            
                <a href="../Appendix/Appendix-E.html">
            
                    
                    一些MIPS库函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.6" data-path="../Appendix/Appendix-F.html">
            
                <a href="../Appendix/Appendix-F.html">
            
                    
                    速查表
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../Acronyms-used.html">
            
                <a href="../Acronyms-used.html">
            
                    
                    缩略词表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../Glossary.html">
            
                <a href="../Glossary.html">
            
                    
                    杂项
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../Idx.html">
            
                <a href="../Idx.html">
            
                    
                    快速引索
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../Bibliography.html">
            
                <a href="../Bibliography.html">
            
                    
                    参考文献
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本書使用 GitBook 釋出
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Windows-NT</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x7B2C;&#x516D;&#x5341;&#x516B;&#x7AE0;">&#x7B2C;&#x516D;&#x5341;&#x516B;&#x7AE0;</h1>
<h1 id="windows-nt">Windows Nt</h1>
<h2 id="681-crtwin32">68.1 CRT(win32)</h2>
<p>&#x7A0B;&#x5E8F;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x4ECE;main()&#x51FD;&#x6570;&#x6267;&#x884C;&#x7684;&#xFF1F;&#x4E8B;&#x5B9E;&#x5E76;&#x975E;&#x5982;&#x6B64;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x7528;IDA&#x6216;&#x8005;HIEW&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;OEP&#xFF08;Original Entry Point&#xFF09;&#x6307;&#x5411;&#x4E86;&#x5176;&#x5B83;&#x4EE3;&#x7801;&#x5757;&#x3002;&#x8FD9;&#x4E9B;&#x4EE3;&#x7801;&#x505A;&#x4E86;&#x4E00;&#x4E9B;&#x7EF4;&#x62A4;&#x548C;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x4E4B;&#x540E;&#x518D;&#x628A;&#x63A7;&#x5236;&#x6D41;&#x4EA4;&#x7ED9;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;startup-code&#x6216;&#x53EB;CRT code(C RunTime)&#x3002;</p>
<p>main()&#x51FD;&#x6570;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x63A5;&#x6536;&#x547D;&#x4EE4;&#x884C;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x4E0E;&#x6B64;&#x7C7B;&#x4F3C;&#x3002;&#x901A;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F20;&#x9012;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x5230;&#x7A0B;&#x5E8F;&#x4E4B;&#x540E;&#xFF0C;CRT code&#x4F1A;&#x7528;&#x7A7A;&#x683C;&#x6765;&#x5206;&#x5272;&#x5B83;&#x4EEC;&#x3002;CRT code&#x540C;&#x6837;&#x4E5F;&#x51C6;&#x5907;&#x4E86;&#x4E00;&#x4E2A;envp&#x6765;&#x5B58;&#x653E;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x3002;&#x5982;&#x679C;&#x662F;GUI&#x7248;&#x672C;&#x7684;win32&#x7A0B;&#x5E8F;&#xFF0C;&#x5165;&#x53E3;&#x51FD;&#x6570;&#x9700;&#x8981;&#x4F7F;&#x7528;WinMain()&#x6765;&#x4EE3;&#x66FF;main()&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x4E5F;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x53C2;&#x6570;&#x3002;</p>
<pre><code>int CALLBACK WinMain(
    _In_ HINSTANCE hInstance,
    _In_ HINSTANCE hPrevInstance,
    _In_ LPSTR lpCmdLine,
    _In_ int nCmdShow
);
</code></pre><p>CRT code&#x540C;&#x6837;&#x4F1A;&#x51C6;&#x5907;&#x597D;&#x5B83;&#x6240;&#x9700;&#x8981;&#x7684;&#x6240;&#x6709;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;main()&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x5B83;&#x7684;&#x9000;&#x51FA;&#x7801;&#x3002;CRT code&#x5C06;&#x5B83;&#x4F5C;&#x4E3A;ExitProcess()&#x7684;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x901A;&#x5E38;&#xFF0C;&#x6BCF;&#x4E2A;&#x7F16;&#x8BD1;&#x5668;&#x90FD;&#x6709;&#x5B83;&#x81EA;&#x5DF1;&#x7684;CRT code&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x662F;MSVC 2008&#x7279;&#x6709;&#x7684;CRT code&#x3002;</p>
<pre><code>___tmainCRTStartup proc near

var_24 = dword ptr -24h
var_20 = dword ptr -20h
var_1C = dword ptr -1Ch
ms_exc = CPPEH_RECORD ptr -18h

    push 14h
    push offset stru_4092D0
    call __SEH_prolog4
    mov eax, 5A4Dh
    cmp ds:400000h, ax
    jnz short loc_401096
    mov eax, ds:40003Ch
    cmp dword ptr [eax+400000h], 4550h
    jnz short loc_401096
    mov ecx, 10Bh
    cmp [eax+400018h], cx
    jnz short loc_401096
    cmp dword ptr [eax+400074h], 0Eh
    jbe short loc_401096
    xor ecx, ecx
    cmp [eax+4000E8h], ecx
    setnz cl
    mov [ebp+var_1C], ecx
    jmp short loc_40109A


loc_401096: ; CODE XREF: ___tmainCRTStartup+18
            ; ___tmainCRTStartup+29 ...
    and [ebp+var_1C], 0

loc_40109A: ; CODE XREF: ___tmainCRTStartup+50
    push 1
    call __heap_init
    pop ecx
    test eax, eax
    jnz short loc_4010AE
    push 1Ch
    call _fast_error_exit
    pop ecx

loc_4010AE: ; CODE XREF: ___tmainCRTStartup+60
    call __mtinit
    test eax, eax
    jnz short loc_4010BF
    push 10h
    call _fast_error_exit
    pop ecx

loc_4010BF: ; CODE XREF: ___tmainCRTStartup+71
    call sub_401F2B
    and [ebp+ms_exc.disabled], 0
    call __ioinit
    test eax, eax
    jge short loc_4010D9
    push 1Bh
    call __amsg_exit
    pop ecx

loc_4010D9: ; CODE XREF: ___tmainCRTStartup+8B
    call ds:GetCommandLineA
    mov dword_40B7F8, eax
    call ___crtGetEnvironmentStringsA
    mov dword_40AC60, eax
    call __setargv
    test eax, eax
    jge short loc_4010FF
    push 8
    call __amsg_exit
    pop ecx

loc_4010FF: ; CODE XREF: ___tmainCRTStartup+B1
    call __setenvp
    test eax, eax
    jge short loc_401110
    push 9
    call __amsg_exit
    pop ecx

loc_401110: ; CODE XREF: ___tmainCRTStartup+C2
    push 1
    call __cinit
    pop ecx
    test eax, eax
    jz short loc_401123
    push eax
    call __amsg_exit
    pop ecx
loc_401123: ; CODE XREF: ___tmainCRTStartup+D6
    mov eax, envp
    mov dword_40AC80, eax
    push eax ; envp
    push argv ; argv
    push argc ; argc
    call _main
    add esp, 0Ch
    mov [ebp+var_20], eax
    cmp [ebp+var_1C], 0
    jnz short $LN28
    push eax ; uExitCode
    call $LN32

$LN28: ; CODE XREF: ___tmainCRTStartup+105
    call __cexit
    jmp short loc_401186


$LN27: ; DATA XREF: .rdata:stru_4092D0
    mov eax, [ebp+ms_exc.exc_ptr] ; Exception filter 0 for function 401044
    mov ecx, [eax]
    mov ecx, [ecx]
    mov [ebp+var_24], ecx
    push eax
    push ecx
    call __XcptFilter
    pop ecx
    pop ecx

$LN24:
    retn

$LN14: ; DATA XREF: .rdata:stru_4092D0
    mov esp, [ebp+ms_exc.old_esp] ; Exception handler 0 for function 401044
    mov eax, [ebp+var_24]
    mov [ebp+var_20], eax
    cmp [ebp+var_1C], 0
    jnz short $LN29
    push eax ; int
    call __exit

$LN29: ; CODE XREF: ___tmainCRTStartup+135
    call __c_exit

loc_401186: ; CODE XREF: ___tmainCRTStartup+112
    mov [ebp+ms_exc.disabled], 0FFFFFFFEh
    mov eax, [ebp+var_20]
    call __SEH_epilog4
    retn
</code></pre><p>&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4EE3;&#x7801;&#x8C03;&#x7528;&#x4E86;GetCommandLineA()&#xFF0C;setargv()&#x548C;setenvp()&#x53BB;&#x586B;&#x5145;argc&#xFF0C;argv&#xFF0C;envp&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x53BB;&#x8C03;&#x7528;main()&#x51FD;&#x6570;&#x3002;</p>
<p>&#x6709;&#x4E9B;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4E86;&#x4E0E;&#x81EA;&#x8EAB;&#x7C7B;&#x4F3C;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5982;heap_init()&#xFF0C;ioinit()&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F60;&#x5C1D;&#x8BD5;&#x5728;CRT code&#x4EE3;&#x7801;&#x4E2D;&#x4F7F;&#x7528;malloc()&#xFF0C;&#x5B83;&#x5C06;&#x5F02;&#x5E38;&#x9000;&#x51FA;&#x4E0B;&#x9762;&#x7684;&#x9519;&#x8BEF;&#xFF1A;</p>
<pre><code>runtime error R6030
- CRT not initialized
</code></pre><p>&#x5728;C++&#x4E2D;&#xFF0C;&#x5168;&#x5C40;&#x5BF9;&#x8C61;&#x7684;&#x521D;&#x59CB;&#x5316;&#x4E5F;&#x540C;&#x6837;&#x53D1;&#x751F;&#x5728;main()&#x51FD;&#x6570;&#x6267;&#x884C;&#x4E4B;&#x524D;&#x7684;CRT&#xFF1A;51.4.1&#x3002;</p>
<p>main()&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x4F20;&#x7ED9;cexit()&#x6216;$LN32&#xFF0C;&#x540E;&#x8005;&#x8C03;&#x7528;doexit()&#x3002;</p>
<p>&#x80FD;&#x5426;&#x6446;&#x8131;CRT&#xFF1F;&#x8FD9;&#x4E2A;&#x5F53;&#x7136;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x77E5;&#x9053;&#x4F60;&#x5728;&#x505A;&#x4EC0;&#x4E48;&#x7684;&#x8BDD;&#x3002;</p>
<p>MSVC&#x7684;&#x94FE;&#x63A5;&#x5668;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;/ENTRY&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x5165;&#x53E3;&#x51FD;&#x6570;&#x3002;</p>
<pre><code>#include &lt;windows.h&gt;
int main()
{
    MessageBox (NULL, &quot;hello, world&quot;, &quot;caption&quot;, MB_OK);
};
</code></pre><p>&#x8BA9;&#x6211;&#x4EEC;&#x7528;MSVC 2008&#x6765;&#x7F16;&#x8BD1;&#x5B83;&#x3002;</p>
<pre><code>cl no_crt.c user32.lib /link /entry:main
</code></pre><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x5927;&#x5C0F;&#x4E3A;2560&#x5B57;&#x8282;&#x7684;runnable.exe&#x3002;&#x5B83;&#x6709;&#x4E00;&#x4E2A;PE&#x5934;&#xFF0C;&#x8C03;&#x7528;MessageBox&#x7684;&#x6307;&#x4EE4;&#xFF0C;&#x6570;&#x636E;&#x6BB5;&#x4E2D;&#x6709;&#x4E24;&#x4E32;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x800C;MessageBox&#x51FD;&#x6570;&#x5BFC;&#x5165;&#x81EA;user32.DLL&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x80FD;&#x591F;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#xFF0C;&#x4F46;&#x4F60;&#x4E0D;&#x80FD;&#x5728;main()&#x51FD;&#x6570;&#x91CC;&#x9762;&#x4F7F;&#x7528;WinMain()&#x7684;&#x56DB;&#x4E2A;&#x53C2;&#x6570;&#x3002;&#x51C6;&#x786E;&#x70B9;&#x6765;&#x8BF4;&#x4F60;&#x80FD;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x5E76;&#x6CA1;&#x6709;&#x5728;&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#x51C6;&#x5907;&#x597D;&#x3002;</p>
<pre><code>cl no_crt.c user32.lib /link /entry:main /align:16
</code></pre><p>&#x5B83;&#x4F1A;&#x62A5;&#x4E00;&#x4E2A;&#x94FE;&#x63A5;&#x8B66;&#x544A;&#xFF1A;</p>
<pre><code>LINK : warning LNK4108: /ALIGN specified without /DRIVER; image may not run
</code></pre><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;720&#x5B57;&#x8282;&#x7684;exe&#x6587;&#x4EF6;&#x3002;&#x5B83;&#x53EF;&#x4EE5;&#x5728;Windows 7 x86&#x4E0A;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x529E;&#x6CD5;&#x5728;x64&#x4E0A;&#x8FD0;&#x884C;&#xFF08;&#x5F53;&#x4F60;&#x8FD0;&#x884C;&#x5B83;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5C06;&#x5148;&#x662F;&#x4E00;&#x6761;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF09;&#x3002;&#x66F4;&#x591A;&#x7684;&#x4F18;&#x5316;&#x53EF;&#x80FD;&#x53EF;&#x4EE5;&#x63D0;&#x9AD8;&#x6267;&#x884C;&#x6548;&#x7387;&#xFF0C;&#x4F46;&#x5982;&#x4F60;&#x6240;&#x89C1;&#xFF0C;&#x5F88;&#x5FEB;&#x5C31;&#x51FA;&#x73B0;&#x4E86;&#x517C;&#x5BB9;&#x95EE;&#x9898;&#x3002;</p>
<h2 id="682-win32-pe">68.2 Win32 PE</h2>
<p>PE&#x662F;Windows&#x4E0B;&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x3002;</p>
<p>.exe&#xFF0C;.dll&#xFF0C;.sys&#x6587;&#x4EF6;&#x5B83;&#x4EEC;&#x4E4B;&#x95F4;&#x7684;&#x533A;&#x522B;&#x662F;&#xFF0C;.exe&#x548C;.sys&#x6587;&#x4EF6;&#x901A;&#x5E38;&#x6CA1;&#x6709;&#x5BFC;&#x51FA;&#x8868;&#xFF0C;&#x53EA;&#x6709;&#x5BFC;&#x5165;&#x8868;&#x3002;</p>
<p>DLL&#x6587;&#x4EF6;&#x548C;&#x5176;&#x5B83;PE&#x6587;&#x4EF6;&#x7C7B;&#x4F3C;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x5165;&#x53E3;&#x70B9;&#xFF08;OEP&#xFF09;&#xFF08;DllMain()&#x51FD;&#x6570;&#xFF09;&#xFF0C;&#x4F46;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x5F88;&#x5C11;DLL&#x5E26;&#x6709;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x3002;</p>
<p>.sys&#x901A;&#x5E38;&#x662F;&#x4E00;&#x4E2A;&#x8BBE;&#x5907;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x4F5C;&#x4E3A;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#xFF0C;Windows&#x9700;&#x8981;&#x68C0;&#x9A8C;&#x5B83;&#x7684;PE&#x6587;&#x4EF6;&#x5E76;&#x4FDD;&#x8BC1;&#x5B83;&#x662F;&#x6B63;&#x786E;&#x7684;&#x3002;</p>
<p>&#x4ECE;Windows Vista&#x5F00;&#x59CB;&#xFF0C;&#x4E00;&#x4E2A;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x6587;&#x4EF6;&#x5FC5;&#x987B;&#x62E5;&#x6709;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#xFF0C;&#x5426;&#x5219;&#x5B83;&#x4F1A;&#x88AB;&#x62D2;&#x7EDD;&#x52A0;&#x8F7D;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;PE&#x6587;&#x4EF6;&#x90FD;&#x7531;&#x4E00;&#x6BB5;&#x6253;&#x5370;&#x201C;This program cannot be run in DOS mode.&#x201D;&#x7684;DOS&#x7A0B;&#x5E8F;&#x5757;&#x5F00;&#x59CB;&#x3002;&#x5982;&#x679C;&#x4F60;&#x7684;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x4E8E;DOS&#x6216;&#x8005;Windows 3.1&#xFF08;&#x8FD9;&#x4E9B;OS&#x5E76;&#x4E0D;&#x8BC6;&#x522B;PE&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#xFF09;&#xFF0C;&#x8FD9;&#x4E2A;DOS&#x7A0B;&#x5E8F;&#x5757;&#x5C06;&#x88AB;&#x6267;&#x884C;&#x6253;&#x5370;&#x3002;</p>
<h3 id="6821-&#x672F;&#x8BED;">68.2.1 &#x672F;&#x8BED;</h3>
<ul>
<li>Module&#xFF08;&#x6A21;&#x5757;&#xFF09; - &#x4E00;&#x4E2A;exe/dll&#x6587;&#x4EF6;&#x3002;</li>
<li>Process&#xFF08;&#x8FDB;&#x7A0B;&#xFF09; - &#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#x5E76;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x901A;&#x5E38;&#x7531;&#x4E00;&#x4E2A;exe&#x6587;&#x4EF6;&#x548C;&#x591A;&#x4E2A;dll&#x6587;&#x4EF6;&#x7EC4;&#x6210;&#x3002;</li>
<li>Process memory&#xFF08;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#xFF09; - &#x8FDB;&#x7A0B;&#x6240;&#x5728;&#x5BB9;&#x6240;&#x3002;&#x6BCF;&#x4E2A;&#x8FDB;&#x7A0B;&#x90FD;&#x62E5;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5185;&#x5B58;&#x3002;&#x901A;&#x5E38;&#x662F;&#x52A0;&#x8F7D;&#x7684;&#x6A21;&#x5757;&#xFF0C;&#x6808;&#x5185;&#x5B58;&#xFF0C;&#x5806;&#x5185;&#x5B58;&#x7B49;&#x7B49;&#x3002;</li>
<li>VA&#xFF08;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF09; - &#x53EF;&#x4EE5;&#x88AB;&#x7A0B;&#x5E8F;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x5730;&#x5740;&#x3002;</li>
<li>Base address&#xFF08;&#x57FA;&#x5730;&#x5740;&#xFF09; - &#x6A21;&#x5757;&#x88AB;&#x52A0;&#x8F7D;&#x5230;&#x8FDB;&#x7A0B;&#x5185;&#x5B58;&#x540E;&#x7684;&#x5730;&#x5740;&#x3002;</li>
<li>RVA&#xFF08;&#x76F8;&#x5BF9;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF09; - VA&#x5730;&#x5740;&#x51CF;&#x53BB;&#x57FA;&#x5730;&#x5740;&#x540E;&#x7684;&#x5730;&#x5740;&#x3002;PE&#x6587;&#x4EF6;&#x4E2D;&#x6709;&#x8BB8;&#x591A;&#x5730;&#x5740;&#x4F7F;&#x7528;RVA&#x5730;&#x5740;&#x3002;</li>
<li>IAT&#xFF08;&#x5BFC;&#x5165;&#x5730;&#x5740;&#x8868;&#xFF09;- &#x4E00;&#x4E2A;&#x5BFC;&#x5165;&#x7B26;&#x53F7;&#x5730;&#x5740;&#x7684;&#x6570;&#x7EC4;&#x3002;&#x901A;&#x5E38;&#x7531;&#x4E00;&#x4E2A;IMAGE_DIRECTORY_ENTRY_IAT&#x6570;&#x636E;&#x76EE;&#x5F55;&#x6307;&#x5411;IAT&#x3002;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;IDA&#x53EF;&#x4F1A;&#x7ED9;IAT&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x540D;&#x4E3A;.idata&#x7684;pseudo-section&#xFF0C;&#x5373;&#x4F7F;IAT&#x662F;&#x5176;&#x5B83;section&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;</li>
<li>INT&#xFF08;&#x5BFC;&#x5165;&#x540D;&#x79F0;&#x8868;&#xFF09; - &#x4E00;&#x4E2A;&#x5BFC;&#x5165;&#x7B26;&#x53F7;&#x540D;&#x7684;&#x6570;&#x7EC4;&#x3002;</li>
</ul>
<h3 id="6822-base-address">68.2.2 Base address</h3>
<p>&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x6A21;&#x5757;&#xFF08;DLL&#xFF09;&#x7684;&#x5F00;&#x53D1;&#x8005;&#x4E0D;&#x53EF;&#x80FD;&#x4E8B;&#x5148;&#x77E5;&#x9053;&#x54EA;&#x4E9B;&#x5730;&#x5740;&#x5206;&#x914D;&#x7ED9;&#x54EA;&#x4E9B;&#x6A21;&#x5757;&#x4F7F;&#x7528;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x4E24;&#x4E2A;&#x5177;&#x6709;&#x76F8;&#x540C;&#x57FA;&#x5730;&#x5740;&#x7684;DLL&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x52A0;&#x8F7D;&#x5230;&#x8FD9;&#x4E2A;&#x57FA;&#x5730;&#x5740;&#x800C;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x52A0;&#x8F7D;&#x5230;&#x8FDB;&#x7A0B;&#x7684;&#x5176;&#x5B83;&#x7A7A;&#x95F2;&#x5185;&#x5B58;&#x5904;&#x5E76;&#x8C03;&#x6574;&#x7B2C;&#x4E8C;&#x4E2A;DLL&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#x3002;</p>
<p>&#x901A;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;MSVC&#x94FE;&#x63A5;&#x5668;&#x751F;&#x6210;.exe&#x6587;&#x4EF6;&#x7684;&#x57FA;&#x5730;&#x5740;&#x662F;0x400000&#xFF0C;&#x5E76;&#x628A;&#x4EE3;&#x7801;&#x6BB5;&#x5B89;&#x6392;&#x5728;0x401000&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x8BE5;&#x4EE3;&#x7801;&#x6BB5;&#x7684;RVA&#x5730;&#x5740;&#x662F;0x1000&#x3002;DLL&#x7684;&#x57FA;&#x5730;&#x5740;&#x901A;&#x5E38;&#x88AB;MSVC&#x94FE;&#x63A5;&#x5668;&#x5B89;&#x6392;&#x5728;0x10000000&#x3002;</p>
<p>&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x52A0;&#x8F7D;&#x6A21;&#x5757;&#x65F6;&#x4F1A;&#x5BFC;&#x81F4;&#x57FA;&#x5730;&#x5740;&#x6D6E;&#x52A8;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;ASLR(Address Space Layout Randomization&#xFF08;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5E03;&#x5C40;&#x968F;&#x673A;&#x5316;&#xFF09;)&#x3002;</p>
<p>&#x4E00;&#x4E2A;shellcode&#x60F3;&#x8981;&#x6267;&#x884C;&#x5FC5;&#x987B;&#x8C03;&#x7528;&#x5230;&#x7CFB;&#x7EDF;&#x7684;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5728;&#x8001;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5F53;&#x4E2D;&#xFF08;&#x5982;&#x679C;&#x662F;WindowsNT&#xFF0C;&#x5219;&#x5728;Windows Vista&#x4E4B;&#x524D;&#xFF09;&#xFF0C;&#x7CFB;&#x7EDF;&#x7684;DLL&#xFF08;&#x5982;kernel32.dll&#xFF0C;user32.dll&#xFF09;&#x603B;&#x662F;&#x52A0;&#x8F7D;&#x5230;&#x5DF2;&#x77E5;&#x7684;&#x5730;&#x5740;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8FD8;&#x8BB0;&#x5F97;&#x7684;&#x8BDD;&#xFF0C;&#x5B83;&#x4EEC;&#x7684;&#x7248;&#x672C;&#x662F;&#x5F88;&#x5C11;&#x6709;&#x53D8;&#x52A8;&#x7684;&#x3002;&#x56E0;&#x4E3A;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;shellcode&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x5B83;&#x4EEC;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;ASLR&#x6BCF;&#x6B21;&#x5728;&#x52A0;&#x8F7D;&#x6A21;&#x5757;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x4F1A;&#x968F;&#x673A;&#x5B89;&#x6392;&#x5B83;&#x4EEC;&#x7684;&#x57FA;&#x5730;&#x5740;&#x3002;</p>
<p>&#x652F;&#x6301;ASLR&#x7684;&#x7A0B;&#x5E8F;&#x5728;PE&#x5934;&#x4E2D;&#x4F1A;&#x8BBE;&#x7F6E;IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE&#x6807;&#x8BC6;&#x8868;&#x660E;&#x5176;&#x652F;&#x6301;ASLR&#x3002;</p>
<h3 id="6823-subsystem">68.2.3 Subsystem</h3>
<p>&#x8FD8;&#x6709;&#x4E00;&#x4E2A;subsystem&#x5B57;&#x6BB5;, &#x901A;&#x5E38;&#x662F;:</p>
<ul>
<li>native (sys&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;)</li>
<li>console (&#x63A7;&#x5236;&#x53F0;&#x7A0B;&#x5E8F;)</li>
<li>GUI (&#x56FE;&#x5F62;&#x7A0B;&#x5E8F;)</li>
</ul>
<h3 id="6824-os-version">68.2.4 OS version</h3>
<p>PE&#x6587;&#x4EF6;&#x8FD8;&#x89C4;&#x5B9A;&#x4E86;&#x53EF;&#x4EE5;&#x52A0;&#x8F7D;&#x5B83;&#x7684;&#x6700;&#x5C0F;Windows&#x7248;&#x672C;&#x53F7;&#x3002;&#x6709;&#x4E00;&#x4E2A;&#x8868;&#x4FDD;&#x5B58;&#x4E86;PE&#x7684;&#x7248;&#x672C;&#x53F7;&#x548C;&#x76F8;&#x5E94;&#x7684;Windows&#x5F00;&#x53D1;&#x4EE3;&#x53F7;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;MSVC 2005&#x7F16;&#x8BD1;&#x7684;.exe&#x6587;&#x4EF6;&#x8FD0;&#x884C;&#x5728;Windows NT4&#xFF08;version 4.00&#xFF09;&#x3002;&#x4F46;MSVC 2008&#x4E0D;&#x662F;&#xFF08;&#x751F;&#x6210;&#x6587;&#x4EF6;&#x7684;&#x7248;&#x672C;&#x662F;5.00&#xFF0C;&#x81F3;&#x5C11;&#x8FD0;&#x884C;&#x4E8E;Windows 2000&#xFF09;&#x3002;</p>
<p>MSVC 2012&#x751F;&#x6210;&#x7684;.exe&#x6587;&#x4EF6;&#x9ED8;&#x8BA4;&#x662F;6.00&#x7248;&#x672C;&#xFF0C;&#x6700;&#x4F4E;&#x5E73;&#x53F0;&#x8981;&#x6C42;&#x81F3;&#x5C11;&#x662F;Windows Vista&#x3002;&#x4F46;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x66F4;&#x6539;&#x7F16;&#x8BD1;&#x9009;&#x9879;&#xFF0C;&#x5F3A;&#x5236;&#x7F16;&#x8BD1;&#x5668;&#x652F;&#x6301;Windows XP&#x3002;</p>
<h3 id="6825-sections">68.2.5 Sections</h3>
<p>&#x4E00;&#x90E8;&#x5206;section&#x4F3C;&#x4E4E;&#x5B58;&#x5728;&#x4E8E;&#x6240;&#x6709;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x91CC;&#x9762;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x7684;&#x6807;&#x5FD7;&#x4F4D;&#x7528;&#x4E8E;&#x533A;&#x5206;&#x4EE3;&#x7801;&#x548C;&#x5E38;&#x91CF;&#x6570;&#x636E;&#xFF1A;</p>
<ul>
<li>&#x5F53;IMAGE_SCN_CNT_CODE&#x6216;IMAGE_SCN_MEM_EXECUTE&#x88AB;&#x7F6E;&#x4F4D;&#xFF0C;&#x8868;&#x793A;&#x8BE5;section&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x3002;</li>
<li>&#x5728;&#x6570;&#x636E;section&#x4E2D;&#xFF0C;IMAGE_SCN_CNT_INITIALIZED_DATA&#xFF0C;IMAGE_SCN_MEM_READ&#x548C;IMAGE_SCN_MEM_WRITE&#x88AB;&#x7F6E;&#x4F4D;&#x3002;</li>
<li>&#x5728;&#x672A;&#x521D;&#x59CB;&#x5316;section&#x548C;&#x7A7A;section&#x4E2D;&#xFF0C;IMAGE_SCN_CNT_UNINITIALIZED_DATA&#xFF0C; IMAGE_SCN_MEM_READ&#x548C;IMAGE_SCN_MEM_WRITE&#x88AB;&#x7F6E;&#x4F4D;&#x3002;</li>
<li>&#x5728;&#x5E38;&#x91CF;&#x6570;&#x636E;section&#xFF08;&#x5199;&#x4FDD;&#x62A4;&#xFF09;&#x4E2D;&#xFF0C;IMAGE_SCN_CNT_INITIALIZED_DATA&#x548C;IMAGE_SCN_MEM_READ&#x88AB;&#x7F6E;&#x4F4D;&#xFF0C;&#x4F46;&#x4E0D;&#x53EF;&#x4EE5;&#x7F6E;&#x4F4D; IMAGE_SCN_MEM_WRITE&#x3002;&#x5F53;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5C1D;&#x8BD5;&#x5728;&#x8FD9;&#x4E2A;section&#x5199;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x8FDB;&#x7A0B;&#x4F1A;&#x5D29;&#x6E83;&#x6389;&#x3002;</li>
</ul>
<p>&#x6BCF;&#x4E2A;section&#x5728;PE&#x6587;&#x4EF6;&#x53EF;&#x80FD;&#x6709;&#x4E00;&#x4E2A;&#x540D;&#x5B57;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x5E76;&#x4E0D;&#x662F;&#x5F88;&#x91CD;&#x8981;&#x3002;&#x901A;&#x5E38;&#xFF08;&#x4F46;&#x4E0D;&#x603B;&#x662F;&#xFF09;&#x4EE3;&#x7801;section&#x7684;&#x540D;&#x5B57;&#x662F;.text&#xFF0C;&#x6570;&#x636E;section&#x662F;.data&#xFF0C;&#x5E38;&#x91CF;&#x6570;&#x636E;section&#x662F;.rdata(readable data)&#x3002;&#x5176;&#x5B83;&#x6D41;&#x884C;&#x7684;&#x540D;&#x5B57;&#x8FD8;&#x6709;&#xFF1A;</p>
<ul>
<li>.idata&#x2014;imports section&#xFF08;&#x5BFC;&#x5165;section&#xFF09;&#x3002;IDA&#x53EF;&#x80FD;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;(68.2.1)&#x7684;pseudo-section&#x3002;</li>
<li>.edata&#x2014;exports section&#xFF08;&#x5BFC;&#x51FA;section&#xFF09;&#x3002;</li>
<li>.pdata&#x2014;&#x5728;Windows NT&#xFF08;MIPS&#xFF0C;IA64&#xFF0C;x64&#xFF09;&#x5305;&#x542B;&#x4E86;&#x6240;&#x6709;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x3002;</li>
<li>.reloc&#x2014;relocs section&#xFF08;&#x91CD;&#x5B9A;&#x4F4D;section&#xFF09;</li>
<li>.bss&#x2014;uninitialized data&#xFF08;&#x672A;&#x521D;&#x59CB;&#x5316;&#x6570;&#x636E;&#xFF08;BSS&#xFF09;&#xFF09;</li>
<li>.tls&#x2014;thread local storage&#xFF08;&#x7EBF;&#x7A0B;&#x5C40;&#x90E8;&#x5B58;&#x50A8;&#xFF08;TLS&#xFF09;&#xFF09;</li>
<li>.rsrc&#x2014;resources&#xFF08;&#x8D44;&#x6E90;&#xFF09;</li>
<li>.CRT&#x2014;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x53E4;&#x8001;&#x7684;MSVC&#x7248;&#x672C;&#x7F16;&#x8BD1;&#x51FA;&#x6765;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x3002;</li>
</ul>
<p>PE&#x6587;&#x4EF6;&#x7684;&#x6253;&#x5305;&#x5668;/&#x52A0;&#x5BC6;&#x5668;&#x7ECF;&#x5E38;&#x6253;&#x4E71;section&#x540D;&#x5B57;&#x6216;&#x8005;&#x628A;&#x540D;&#x5B57;&#x66FF;&#x6362;&#x4E3A;&#x81EA;&#x5DF1;&#x7684;&#x3002;</p>
<p>MSVC&#x5141;&#x8BB8;&#x4F60;&#x4EFB;&#x610F;&#x547D;&#x540D;section&#x3002;</p>
<p>&#x4E00;&#x4E9B;&#x7F16;&#x8BD1;&#x5668;&#x548C;&#x94FE;&#x63A5;&#x5668;&#x53EF;&#x4EE5;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x8C03;&#x8BD5;&#x7B26;&#x53F7;&#x548C;&#x5176;&#x4ED6;&#x8C03;&#x8BD5;&#x4FE1;&#x606F;&#x7684;section(&#x4F8B;&#x5982;MinGW)&#x3002;&#x4F46;&#x4E0D;&#x5305;&#x62EC;MSVC&#x73B0;&#x5728;&#x7684;&#x7248;&#x672C;(&#x63D0;&#x4F9B;&#x5355;&#x72EC;&#x7684;PDB&#x6587;&#x4EF6;&#x7528;&#x4E8E;&#x8FD9;&#x4E2A;&#x76EE;&#x7684;)&#x3002;</p>
<p>&#x8FD9;&#x662F;PE&#x6587;&#x4EF6;&#x7684;section&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;&#xFF1A;</p>
<pre><code>typedef struct _IMAGE_SECTION_HEADER {
    BYTE Name[IMAGE_SIZEOF_SHORT_NAME];
    union {
        DWORD PhysicalAddress;
        DWORD VirtualSize;
    } Misc;
    DWORD VirtualAddress;
    DWORD SizeOfRawData;
    DWORD PointerToRawData;
    DWORD PointerToRelocations;
    DWORD PointerToLinenumbers;
    WORD NumberOfRelocations;
    WORD NumberOfLinenumbers;
    DWORD Characteristics;
} IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;
</code></pre><p>&#x4E00;&#x4E9B;&#x76F8;&#x5173;&#x7684;&#x5B57;&#x6BB5;&#x7684;&#x89E3;&#x91CA;&#xFF1A;PointerToRawData&#x662F;&#x5728;&#x78C1;&#x76D8;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x504F;&#x79FB;&#xFF0C;VirtualAddress&#x5728;Hiew&#x4E2D;&#x662F;&#x88C5;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#x7684;RVA&#x3002;</p>
<h3 id="6826-relocations-relocs">68.2.6 Relocations (relocs)</h3>
<p>&#x4E5F;&#x79F0;&#x4E3A;FIXUP-s&#xFF08;&#x5728;Hiew&#xFF09;&#x3002;</p>
<p>&#x4ED6;&#x4EEC;&#x4E5F;&#x5B58;&#x5728;&#x4E8E;&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x3002;</p>
<p>&#x663E;&#x7136;&#xFF0C;&#x6A21;&#x5757;&#x53EF;&#x4EE5;&#x88AB;&#x52A0;&#x8F7D;&#x5230;&#x5404;&#x79CD;&#x57FA;&#x5730;&#x5730;&#x5740;&#xFF0C;&#x4F46;&#x5982;&#x4F55;&#x5904;&#x7406;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF1F;&#x4E00;&#x4E2A;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x662F;&#x4F7F;&#x7528;&#x4F4D;&#x7F6E;&#x65E0;&#x5173;&#x4EE3;&#x7801;&#xFF08;67.1&#x7AE0;&#xFF09;&#xFF0C;&#x4F46;&#x5B83;&#x5E76;&#x4E0D;&#x662F;&#x603B;&#x662F;&#x6709;&#x7528;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x5B58;&#x5728;&#x7684;&#x7406;&#x7531;&#xFF1A;&#x5F53;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x57FA;&#x5730;&#x5740;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x4EEC;&#x7684;&#x5165;&#x53E3;&#x5730;&#x5740;&#x90FD;&#x9700;&#x8981;&#x4FEE;&#x6B63;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5730;&#x5740;&#x662F;0x410000&#xFF0C;&#x5B83;&#x662F;&#x8FD9;&#x6837;&#x8BBF;&#x95EE;&#x7684;&#xFF1A;</p>
<pre><code>A1 00 00 41 00    mov eax, [000410000]
</code></pre><p>&#x6A21;&#x5757;&#x7684;&#x57FA;&#x5730;&#x5740;&#x662F;0x400000&#xFF0C;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;RVA&#x5730;&#x5740;&#x662F;0x10000&#x3002;</p>
<p>&#x5982;&#x679C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x5230;0x500000&#x8FD9;&#x4E2A;&#x57FA;&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x5B9E;&#x9645;&#x7684;&#x5730;&#x5740;&#x5FC5;&#x987B;&#x662F;0x510000&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5728;0xA1&#x5B57;&#x8282;&#x4E4B;&#x540E;&#xFF0C;&#x53D8;&#x91CF;&#x7684;&#x5730;&#x5740;&#x7F16;&#x7801;&#x5230;MOV&#x6307;&#x4EE4;&#x4E2D;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;0xA1&#x5B57;&#x8282;&#x4E4B;&#x540E;&#x7684;4&#x4E2A;&#x5B57;&#x8282;&#x5730;&#x5740;&#x5199;&#x5728;&#x4E86;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x3002;</p>
<p>&#x5982;&#x679C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x57FA;&#x5730;&#x5740;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x52A0;&#x8F7D;&#x5668;&#x679A;&#x4E3E;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x4E2D;&#x6240;&#x6709;&#x5730;&#x5740;&#xFF0C;&#x67E5;&#x627E;&#x6BCF;&#x4E2A;32&#x4F4D;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x51CF;&#x53BB;&#x539F;&#x6765;&#x7684;&#x57FA;&#x5730;&#x5740;(&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5F97;&#x5230;&#x4E86;RVA)&#xFF0C;&#x5E76;&#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x57FA;&#x5730;&#x5740;&#x3002;</p>
<p>&#x5982;&#x679C;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x5230;&#x539F;&#x6765;&#x7684;&#x57FA;&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;&#x4E0D;&#x505A;&#x4EFB;&#x4F55;&#x4E8B;&#x60C5;&#x3002;</p>
<p>&#x6240;&#x6709;&#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x90FD;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x5904;&#x7406;&#x3002;</p>
<p>&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x53EF;&#x80FD;&#x6709;&#x5404;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x4F46;&#x662F;&#x5728;x86&#x5904;&#x7406;&#x5668;&#x7684;Windows&#x4E2D;&#xFF0C;&#x901A;&#x5E38;&#x662F;IMAGE_REL_BASED_HIGHLOW&#x3002;</p>
<p>&#x987A;&#x4FBF;&#x8BF4;&#x4E00;&#x4E0B;&#xFF0C;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x5728;Hiew&#x662F;&#x9690;&#x85CF;&#x7684;&#x3002;&#x76F8;&#x5173;&#x4F8B;&#x5B50;&#x8BF7;&#x67E5;&#x770B;&#xFF08;Figure 7.12&#xFF09;&#x3002;</p>
<p>OllyDbg&#x4F1A;&#x7528;&#x4E0B;&#x5212;&#x7EBF;&#x6807;&#x8BC6;&#x54EA;&#x4E9B;&#x4F7F;&#x7528;&#x4E86;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x3002;&#x76F8;&#x5173;&#x4F8B;&#x5B50;&#x8BF7;&#x67E5;&#x770B;&#xFF08;Figure 13.11&#xFF09;&#x3002;</p>
<h3 id="6827-exports-and-imports">68.2.7 Exports and imports</h3>
<p>&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;&#x4EFB;&#x4F55;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x90FD;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x670D;&#x52A1;&#x548C;&#x5176;&#x5B83;&#x4E00;&#x4E9B;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x8BF4;&#xFF0C;&#x4E00;&#x4E2A;&#x6A21;&#x5757;&#xFF08;&#x901A;&#x5E38;&#x662F;DLL&#xFF09;&#x7684;&#x51FD;&#x6570;&#x901A;&#x5E38;&#x90FD;&#x662F;&#x5BFC;&#x51FA;&#x63D0;&#x4F9B;&#x7ED9;&#x5176;&#x5B83;&#x6A21;&#x5757;&#x4F7F;&#x7528;&#xFF08;.exe&#x6587;&#x4EF6;&#x6216;&#x5176;&#x5B83;DLL&#xFF09;&#x3002;</p>
<p>&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6BCF;&#x4E2A;DLL&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x5BFC;&#x51FA;&#xFF08;exports&#xFF09;&#x8868;&#xFF0C;&#x7531;&#x6A21;&#x5757;&#x7684;&#x51FD;&#x6570;&#x52A0;&#x5B83;&#x4EEC;&#x7684;&#x5730;&#x5740;&#x7EC4;&#x6210;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;exe&#x6216;dll&#x6587;&#x4EF6;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x5BFC;&#x5165;&#xFF08;imports&#xFF09;&#x8868;&#xFF0C;&#x91CC;&#x9762;&#x5305;&#x542B;&#x4E86;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x6240;&#x9700;&#x51FD;&#x6570;&#x5BF9;&#x5E94;&#x7684;DLL&#x6587;&#x4EF6;&#x540D;&#x3002;</p>
<p>&#x5728;&#x52A0;&#x8F7D;main.exe&#x6587;&#x4EF6;&#x4E4B;&#x540E;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x52A0;&#x8F7D;&#x5668;&#x5F00;&#x59CB;&#x5904;&#x7406;&#x5BFC;&#x5165;&#x8868;&#xFF1A;&#x5B83;&#x52A0;&#x8F7D;&#x6240;&#x9700;&#x7684;DLL&#x6587;&#x4EF6;&#xFF0C;&#x63A5;&#x7740;&#x5728;DLL&#x7684;&#x5BFC;&#x5165;&#x8868;&#x67E5;&#x627E;&#x5BF9;&#x5E94;&#x51FD;&#x6570;&#x540D;&#x5B57;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x5B83;&#x4EEC;&#x7684;&#x5730;&#x5740;&#x5199;&#x5230;main.exe&#x6A21;&#x5757;&#x7684;IAT&#xFF08;&#xFF08;Import Address Table&#xFF09;&#x5BFC;&#x5165;&#x8868;&#xFF09;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x52A0;&#x8F7D;&#x5668;&#x5FC5;&#x987B;&#x5927;&#x91CF;&#x6BD4;&#x8F83;&#x51FD;&#x6570;&#x540D;&#xFF0C;&#x4F46;&#x5B57;&#x7B26;&#x4E32;&#x6BD4;&#x8F83;&#x6548;&#x7387;&#x5E76;&#x4E0D;&#x662F;&#x5F88;&#x9AD8;&#x3002;&#x6240;&#x4EE5;&#x6709;&#x4E00;&#x4E2A;&#x652F;&#x6301;&#x201C;ordinals&#x201D;&#x6216;&#x201C;hints&#x201D;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x8868;&#x793A;&#x51FD;&#x6570;&#x5B58;&#x50A8;&#x5728;&#x8868;&#x4E2D;&#x7684;&#x5E8F;&#x53F7;&#xFF0C;&#x7528;&#x4E8E;&#x4EE3;&#x66FF;&#x5B83;&#x4EEC;&#x7684;&#x51FD;&#x6570;&#x540D;&#x3002;</p>
<p>&#x8FD9;&#x4F7F;&#x5F97;&#x5B83;&#x4EEC;&#x53EF;&#x4EE5;&#x66F4;&#x5FEB;&#x5730;&#x52A0;&#x8F7D;DLL&#x3002;Ordinals&#x5728;&#x5BFC;&#x51FA;&#x8868;&#x4E2D;&#x6C38;&#x8FDC;&#x90FD;&#x5B58;&#x5728;&#x3002;</p>
<p>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;&#x4E00;&#x4E2A;&#x4F7F;&#x7528;MFC&#x5E93;&#x7684;&#x7A0B;&#x5E8F;&#x90FD;&#x662F;&#x901A;&#x8FC7;ordinals&#x52A0;&#x8F7D;mfc*.dll&#xFF0C;&#x5728;&#x8FD9;&#x79CD;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;INT&#xFF08;Import Name Table&#xFF09;&#x662F;&#x4E0D;&#x5B58;&#x5728;MFC&#x51FD;&#x6570;&#x540D;&#x5B57;&#x7684;&#x3002;</p>
<p>&#x4F7F;&#x7528;IDA&#x52A0;&#x8F7D;&#x8FD9;&#x7C7B;&#x7A0B;&#x5E8F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x544A;&#x8BC9;&#x5B83;mfc*.dll&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x51FD;&#x6570;&#x540D;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x544A;&#x8BC9;IDA&#x8FD9;&#x4E9B;DLL&#x8DEF;&#x5F84;&#xFF0C;&#x5B83;&#x4F1A;&#x663E;&#x793A;&#x8BF8;&#x5982;mfc80_123&#x800C;&#x4E0D;&#x662F;&#x51FD;&#x6570;&#x540D;&#x3002;</p>
<h4 id="imports-section">Imports section</h4>
<p>&#x7F16;&#x8BD1;&#x5668;&#x901A;&#x5E38;&#x4F1A;&#x7ED9;&#x5BFC;&#x5165;&#x8868;&#x53CA;&#x5176;&#x76F8;&#x5173;&#x5185;&#x5BB9;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;section&#xFF08;&#x540D;&#x5B57;&#x7C7B;&#x4F3C;.idata&#xFF09;&#xFF0C;&#x4F46;&#x8FD9;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5F3A;&#x5236;&#x89C4;&#x5B9A;&#x3002;</p>
<p>&#x56E0;&#x4E3A;&#x672F;&#x8BED;&#x6DF7;&#x4E71;&#xFF0C;&#x5BFC;&#x5165;&#x8868;&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x4EE4;&#x4EBA;&#x56F0;&#x60D1;&#x7684;&#x5730;&#x65B9;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x5C1D;&#x8BD5;&#x4E00;&#x4E0B;&#x6574;&#x7406;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x3002;</p>
<p><img src="img/C68-Figure_68.1_A_scheme_that_unites_all_PE-file_structures_related_to_imports.jpg" alt="Figure 68.1: A scheme that unites all PE-file structures related to imports"></p>
<p>Figure 68.1: A scheme that unites all PE-file structures related to imports</p>
<p>&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x7684;&#x7ED3;&#x6784;&#x662F;IMAGE_IMPORT_DESCRIPTOR&#x6570;&#x7EC4;&#x3002;&#x6BCF;&#x4E2A;&#x88AB;&#x52A0;&#x8F7D;&#x8FDB;&#x6765;&#x7684;DLL&#x5360;&#x7528;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6587;&#x672C;&#x5B57;&#x7B26;&#x4E32;&#xFF08;DLL&#x540D;&#x5B57;&#xFF09;&#x7684;RVA&#x5730;&#x5740;&#x3002;</p>
<p>OriginalFirstThink&#x662F;INT&#x8868;&#x7684;RVA&#x5730;&#x5740;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;RVA&#x5730;&#x5740;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x91CC;&#x9762;&#x6BCF;&#x4E2A;&#x6210;&#x5458;&#x90FD;&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x540D;&#x7684;&#x6587;&#x672C;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x540D;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x4E4B;&#x524D;&#x662F;&#x4E00;&#x4E2A;16&#x4F4D;&#x7684;(&quot;hint&quot;)-&quot;ordinal&quot;&#x6574;&#x6570;&#x3002;</p>
<p>&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;ordinal&#x627E;&#x5230;&#x51FD;&#x6570;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5B57;&#x7B26;&#x4E32;&#x6BD4;&#x8F83;&#x6765;&#x67E5;&#x627E;&#x51FD;&#x6570;&#x3002;&#x6570;&#x7EC4;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x662F;0&#x3002;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;FirstThunk&#x5B57;&#x6BB5;&#x6307;&#x5411;IAT&#x8868;&#xFF0C;&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#x662F;&#x52A0;&#x8F7D;&#x5668;&#x91CD;&#x5199;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x89E3;&#x6790;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#x7684;RVA&#x5730;&#x5740;&#x3002;</p>
<p>&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x5668;&#x91CD;&#x5199;&#x5730;&#x5740;&#x7684;&#x51FD;&#x6570;&#x5728;IDA&#x4E2D;&#x52A0;&#x4E86;&#x8BF8;&#x5982;&#x8FD9;&#x79CD;&#x6807;&#x8BB0;&#xFF1A;__imp_CreateFileA&#x3002;</p>
<p>&#x52A0;&#x8F7D;&#x5668;&#x81F3;&#x5C11;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x91CD;&#x5199;&#x5730;&#x5740;&#xFF1A;</p>
<ul>
<li><p>&#x4EE3;&#x7801;&#x4F1A;&#x6709;&#x8BF8;&#x5982;&#x8C03;&#x7528;__imp_CreateFileA&#x7684;&#x6307;&#x4EE4;&#xFF0C;&#x56E0;&#x4E3A;&#x5BFC;&#x5165;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#x5728;&#x67D0;&#x79CD;&#x610F;&#x4E49;&#x4E0A;&#x662F;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x5F53;&#x6A21;&#x5757;&#x52A0;&#x8F7D;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x57FA;&#x5730;&#x5740;&#x65F6;&#xFF0C;call&#x6307;&#x4EE4;&#x7684;&#x5730;&#x5740;&#x88AB;&#x6DFB;&#x52A0;&#x5230;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x4E2D;&#x3002;
&#x4F46;&#x662F;&#xFF0C;&#x663E;&#x7136;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x80FD;&#x4F1A;&#x6269;&#x5927;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x3002;&#x56E0;&#x4E3A;&#x6709;&#x53EF;&#x80FD;&#x4ECE;&#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x5927;&#x91CF;&#x8C03;&#x7528;&#x5BFC;&#x5165;&#x7684;&#x51FD;&#x6570;&#x3002;&#x800C;&#x4E14;&#xFF0C;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x592A;&#x5927;&#x7684;&#x8BDD;&#x4F1A;&#x51CF;&#x6162;&#x6A21;&#x5757;&#x7684;&#x52A0;&#x8F7D;&#x901F;&#x5EA6;&#x3002;</p>
</li>
<li><p>&#x6BCF;&#x4E2A;&#x5BFC;&#x5165;&#x51FD;&#x6570;&#x7ED9;&#x5B83;&#x5206;&#x914D;&#x4E00;&#x6761;jmp&#x6307;&#x4EE4;&#xFF0C;&#x4F7F;&#x7528;jmp&#x6307;&#x4EE4;&#x52A0;&#x4E0A;&#x91CD;&#x5B9A;&#x4F4D;&#x8868;&#x7684;&#x5730;&#x5740;&#x8DF3;&#x8F6C;&#x5230;&#x5BFC;&#x5165;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x4E9B;&#x5165;&#x53E3;&#x70B9;&#x88AB;&#x79F0;&#x4E4B;&#x4E3A;&#x201C;thunks&#x201D;&#xFF0C;&#x6240;&#x6709;&#x8C03;&#x7528;&#x5BFC;&#x5165;&#x51FD;&#x6570;&#x4EC5;&#x9700;&#x8981;&#x8C03;&#x7528;&#x76F8;&#x5BF9;&#x5E94;&#x7684;&#x201C;thunk&#x201D;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x91CD;&#x5B9A;&#x4F4D;&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E9B;CALL&#x90FD;&#x4F7F;&#x7528;&#x76F8;&#x5BF9;&#x5730;&#x5740;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x8C03;&#x6574;&#x64CD;&#x4F5C;&#x3002;</p>
</li>
</ul>
<p>&#x8FD9;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x7EC4;&#x5408;&#x4F7F;&#x7528;&#x3002;&#x53EF;&#x80FD;&#x7684;&#x8BDD;&#xFF0C;&#x94FE;&#x63A5;&#x5668;&#x7ED9;&#x90A3;&#x4E9B;&#x88AB;&#x8C03;&#x7528;&#x592A;&#x591A;&#x6B21;&#x7684;&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x201C;thunk&#x201D;&#xFF0C;&#x7136;&#x800C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x662F;&#x8FD9;&#x6837;&#x3002;</p>
<p>&#x987A;&#x4FBF;&#x8BF4;&#x4E00;&#x4E0B;&#xFF0C;FirstThunk&#x6307;&#x5411;&#x7684;&#x51FD;&#x6570;&#x5730;&#x5740;&#x6570;&#x7EC4;&#x4E0D;&#x5FC5;&#x8981;&#x4F4D;&#x4E8E;IAT section&#x3002;&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x66FE;&#x7ECF;&#x5199;&#x7684;<a href="http://go.yurichev.com/17049" target="_blank">PE_add_import</a>&#x5DE5;&#x5177;&#x53EF;&#x4EE5;&#x7ED9;.exe&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x5BFC;&#x5165;&#x51FD;&#x6570;&#x3002;&#x5728;&#x65E9;&#x4E9B;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A;&#x5DE5;&#x5177;&#x53EF;&#x4EE5;&#x8BA9;&#x4F60;&#x7684;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x5176;&#x5B83;DLL&#x6587;&#x4EF6;&#x7684;&#x51FD;&#x6570;&#x3002;&#x6211;&#x7684;&#x5DE5;&#x5177;&#x6DFB;&#x52A0;&#x4E86;&#x7C7B;&#x4F3C;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code>MOV EAX, [yourdll.dll!function]
JMP EAX
</code></pre><p>FirstThunk&#x6307;&#x5411;&#x7B2C;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#xFF0C;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x5F53;&#x52A0;&#x8F7D;yourdll.dll&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x52A0;&#x8F7D;&#x5668;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x5199;&#x5165;function&#x51FD;&#x6570;&#x7684;&#x6B63;&#x786E;&#x5730;&#x5740;&#x3002;</p>
<p>&#x8FD8;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x4EE3;&#x7801;&#x6BB5;&#x901A;&#x5E38;&#x662F;&#x5199;&#x4FDD;&#x62A4;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x7684;&#x5DE5;&#x5177;&#x5728;code section&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;IMAGE_SCN_MEM_WRITE&#x6807;&#x5FD7;&#x4F4D;&#x3002;&#x5426;&#x5219;&#xFF0C;&#x7A0B;&#x5E8F;&#x5728;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x7206;&#x51FA;&#x9519;&#x8BEF;&#x7801;&#x4E3A;5&#xFF08;&#x8BBF;&#x95EE;&#x5931;&#x8D25;&#xFF09;&#x7684;&#x5F02;&#x5E38;&#x9519;&#x8BEF;&#x3002;</p>
<p>&#x6709;&#x4EBA;&#x53EF;&#x80FD;&#x4F1A;&#x95EE;&#xFF1A;&#x5982;&#x679C;&#x6211;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x7A0B;&#x5E8F;&#x4E0E;&#x4E00;&#x7EC4;&#x4E0D;&#x53D8;&#x7684;DLL&#x6587;&#x4EF6;&#xFF0C;&#x662F;&#x6709;&#x53EF;&#x80FD;&#x52A0;&#x5FEB;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#xFF1F;</p>
<p>&#x662F;&#x7684;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x63D0;&#x524D;&#x628A;&#x51FD;&#x6570;&#x7684;&#x5730;&#x5740;&#x5199;&#x5165;&#x5230;&#x5BFC;&#x5165;&#x8868;&#x7684;FirstThunk&#x6570;&#x7EC4;&#x3002;IMAGE_IMPORT_DESCRIPTOR&#x7ED3;&#x6784;&#x6709;&#x4E00;&#x4E2A;Timestamp&#x5B57;&#x6BB5;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x52A0;&#x8F7D;&#x5668;&#x4F1A;&#x6BD4;&#x8F83;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x548C;DLL&#x6587;&#x4EF6;&#x65E5;&#x671F;&#x65F6;&#x95F4;&#x3002;&#x5982;&#x679C;&#x5B83;&#x4EEC;&#x76F8;&#x7B49;&#xFF0C;&#x90A3;&#x4E48;&#x52A0;&#x8F7D;&#x5668;&#x4E0D;&#x505A;&#x4EFB;&#x4F55;&#x4E8B;&#x60C5;&#xFF0C;&#x6240;&#x4EE5;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x53EF;&#x4EE5;&#x5F88;&#x5FEB;&#x5B8C;&#x6210;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;&#x201C;old-style binding&#x201D;&#x3002;&#x4E3A;&#x4E86;&#x52A0;&#x5FEB;&#x7A0B;&#x5E8F;&#x7684;&#x52A0;&#x8F7D;&#xFF0C;<a href="http://go.yurichev.com/17318" target="_blank">Matt Pietrek. &#x201C;An In-Depth Look into the Win32 Portable Executable File Format&#x201D;</a>&#xFF0C;&#x5EFA;&#x8BAE;&#x4F60;&#x7684;&#x7A0B;&#x5E8F;&#x5B89;&#x88C5;&#x5728;&#x6700;&#x7EC8;&#x7528;&#x6237;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x540E;&#x4E0D;&#x4E45;&#x505A;&#x6346;&#x7ED1;&#x3002;</p>
<p>PE&#x6587;&#x4EF6;&#x7684;&#x6253;&#x5305;&#x5668;/&#x52A0;&#x5BC6;&#x5668;&#x4E5F;&#x53EF;&#x4EE5;&#x538B;&#x7F29;/&#x52A0;&#x5BC6;&#x5BFC;&#x5165;&#x8868;&#x3002;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Windows&#x7684;&#x52A0;&#x8F7D;&#x5668;&#x5F53;&#x7136;&#x4E0D;&#x4F1A;&#x52A0;&#x8F7D;&#x6240;&#x6709;&#x9700;&#x8981;&#x7684;DLL&#x3002;&#x56E0;&#x6B64;&#x6253;&#x5305;&#x5668;/&#x52A0;&#x5BC6;&#x5668;&#x53EA;&#x80FD;&#x901A;&#x8FC7;LoadLibrary()&#x548C;GetProcAddress()&#x6765;&#x83B7;&#x53D6;&#x6240;&#x9700;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5B89;&#x88C5;&#x5728;Windows&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x6807;&#x51C6;DLL&#x6587;&#x4EF6;&#xFF0C;IAT&#x5F80;&#x5F80;&#x662F;&#x4F4D;&#x4E8E;PE&#x6587;&#x4EF6;&#x7684;&#x5F00;&#x5934;&#x3002;&#x636E;&#x8BF4;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x4F18;&#x5316;&#x3002;&#x52A0;&#x8F7D;&#x65F6;.exe&#x6587;&#x4EF6;&#x4E0D;&#x662F;&#x5168;&#x90E8;&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#xFF0C;&#x5B83;&#x662F;&#x201C;&#x6620;&#x5C04;&#x201D;&#x548C;&#x52A0;&#x8F7D;&#x90E8;&#x5206;&#x9700;&#x8981;&#x88AB;&#x8BBF;&#x95EE;&#x5230;&#x7684;&#x5185;&#x5B58;&#x3002;&#x53EF;&#x80FD;&#x5FAE;&#x8F6F;&#x7684;&#x5F00;&#x53D1;&#x8005;&#x8BA4;&#x4E3A;&#x8FD9;&#x6837;&#x52A0;&#x8F7D;&#x6BD4;&#x8F83;&#x5FEB;&#x3002;</p>
<h3 id="6828-resources">68.2.8 Resources</h3>
<p>&#x8D44;&#x6E90;&#x5728;PE&#x6587;&#x4EF6;&#x53EA;&#x662F;&#x4E00;&#x7EC4;&#x56FE;&#x6807;&#xFF0C;&#x56FE;&#x7247;&#xFF0C;&#x6587;&#x672C;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x5BF9;&#x8BDD;&#x6846;&#x63CF;&#x8FF0;&#x3002;&#x56E0;&#x4E3A;&#x628A;&#x5B83;&#x4EEC;&#x4ECE;&#x4E3B;&#x4EE3;&#x7801;&#x5206;&#x79BB;&#x4E86;&#x51FA;&#x6765;&#xFF0C;&#x6240;&#x4EE5;&#x591A;&#x56FD;&#x8BED;&#x8A00;&#x7A0B;&#x5E8F;&#x5F88;&#x5BB9;&#x6613;&#x5B9E;&#x73B0;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x6839;&#x636E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x8BBE;&#x7F6E;&#x7684;&#x8BED;&#x8A00;&#x53BB;&#x9009;&#x62E9;&#x6587;&#x672C;&#x6216;&#x56FE;&#x7247;&#x7684;&#x8BED;&#x8A00;&#x3002;</p>
<p>&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x526F;&#x4F5C;&#x7528;&#xFF0C;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x8BF8;&#x5982;ResHack&#x7684;&#x7F16;&#x8F91;&#x5668;&#xFF0C;&#x5373;&#x4F7F;&#x5728;&#x6CA1;&#x6709;&#x4E13;&#x4E1A;&#x77E5;&#x8BC6;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x8F7B;&#x677E;&#x5730;&#x7F16;&#x8F91;&#x548C;&#x4FDD;&#x5B58;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x8D44;&#x6E90;&#x3002;</p>
<h3 id="6829-net">68.2.9 .NET</h3>
<p>.NET&#x7684;&#x7A0B;&#x5E8F;&#x5E76;&#x4E0D;&#x7F16;&#x8BD1;&#x6210;&#x673A;&#x5668;&#x7801;&#xFF0C;&#x800C;&#x662F;&#x7F16;&#x8BD1;&#x6210;&#x5B57;&#x8282;&#x7801;&#x3002;&#x4E25;&#x683C;&#x5730;&#x8BF4;&#xFF0C;&#x662F;&#x5728;.exe&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x4F7F;&#x7528;&#x5B57;&#x8282;&#x7801;&#x4EE3;&#x66FF;x86&#x673A;&#x5668;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x8FDB;&#x5165;&#x5165;&#x53E3;&#x70B9;&#xFF08;OEP&#xFF09;&#x8FD8;&#x662F;&#x9700;&#x8981;&#x4E00;&#x5C0F;&#x6BB5;x86&#x673A;&#x5668;&#x7801;:</p>
<pre><code>jmp mscoree.dll!_CorExeMain
</code></pre><p>.NET&#x7684;&#x52A0;&#x8F7D;&#x5668;&#x4F4D;&#x4E8E;mscoree.dll&#xFF0C;&#x7531;&#x5B83;&#x6765;&#x5904;&#x7406;PE&#x6587;&#x4EF6;&#x3002;&#x5B83;&#x5B58;&#x5728;&#x4E8E;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;Windows XP&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x3002;&#x4ECE;XP&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;OS&#x7684;&#x52A0;&#x8F7D;&#x5668;&#x80FD;&#x591F;&#x63A2;&#x6D4B;.NET&#x6587;&#x4EF6;&#x5E76;&#x901A;&#x8FC7;JMP&#x6307;&#x4EE4;&#x6267;&#x884C;&#x3002;</p>
<h3 id="68210-tls">68.2.10 TLS</h3>
<p>&#x8FD9;&#x4E2A;section&#x5305;&#x542B;&#x4E86;&#x521D;&#x59CB;&#x5316;TLS&#x7684;&#x6570;&#x636E;&#xFF08;65&#x7AE0;&#xFF09;&#xFF08;&#x5982;&#x679C;&#x9700;&#x8981;&#x7684;&#x8BDD;&#xFF09;&#x3002;&#x5F53;&#x4E00;&#x4E2A;&#x65B0;&#x7EBF;&#x7A0B;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x7684;TLS&#x6570;&#x636E;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;section&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#x3002;</p>
<p>&#x9664;&#x6B64;&#x4E4B;&#x5916;&#xFF0C;PE&#x6587;&#x4EF6;&#x89C4;&#x8303;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;TLS&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF01;&#x5F53;section&#xFF0C;TLS callbacks&#x5B58;&#x5728;&#xFF0C;&#x5B83;&#x4EEC;&#x4F1A;&#x5728;&#x4F20;&#x9012;&#x63A7;&#x5236;&#x6743;&#x5230;&#x4E3B;&#x5165;&#x53E3;&#x70B9;&#xFF08;OEP&#xFF09;&#x4E4B;&#x524D;&#x88AB;&#x8C03;&#x7528;&#x3002;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x5E7F;&#x6CDB;&#x7528;&#x4E8E;PE&#x6587;&#x4EF6;&#x7684;&#x6253;&#x5305;&#x548C;&#x52A0;&#x5BC6;&#x3002;</p>
<h3 id="68211-&#x5DE5;&#x5177;">68.2.11 &#x5DE5;&#x5177;</h3>
<ul>
<li>objdump - cygwin&#x7248;&#x672C;&#x53EF;&#x4EE5;&#x53CD;&#x6C47;&#x7F16;PE&#x6587;&#x4EF6;</li>
<li>Hiew - (&#x53C2;&#x8003;73&#x7AE0;)</li>
<li>pefile - &#x4E00;&#x4E2A;&#x5904;&#x7406;PE&#x6587;&#x4EF6;&#x7684;Python&#x5E93;</li>
<li>ResHack AKA Resource Hacker &#x2014; &#x8D44;&#x6E90;&#x7F16;&#x8F91;&#x5668;</li>
<li>PE_add_import &#x2014; &#x6DFB;&#x52A0;&#x7B26;&#x53F7;&#x5230;&#x5BFC;&#x5165;&#x8868;&#x7684;&#x7B80;&#x6613;&#x5DE5;&#x5177;</li>
<li>PE_patcher &#x2014; &#x4FEE;&#x8865;PE&#x6587;&#x4EF6;&#x7684;&#x7B80;&#x6613;&#x5DE5;&#x5177;</li>
<li>PE_search_str_refs &#x2014; &#x67E5;&#x627E;&#x51FD;&#x6570;&#x5728;PE&#x6587;&#x4EF6;&#x91CC;&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x7B80;&#x6613;&#x5DE5;&#x5177;</li>
</ul>
<h3 id="68212-&#x6269;&#x5C55;&#x9605;&#x8BFB;">68.2.12 &#x6269;&#x5C55;&#x9605;&#x8BFB;</h3>
<p><a href="http://go.yurichev.com/17056" target="_blank">Daniel Pistelli &#x2014; The .NET File Format</a></p>
<h2 id="683-windows-seh">68.3 Windows SEH</h2>
<h3 id="6831-&#x8BA9;&#x6211;&#x4EEC;&#x5148;&#x5FD8;&#x4E86;msvc">68.3.1 &#x8BA9;&#x6211;&#x4EEC;&#x5148;&#x5FD8;&#x4E86;MSVC</h3>
<p>&#x5728;Windows&#xFF0C;SEH&#xFF08;Structured Exception Handling&#xFF08;&#x7ED3;&#x6784;&#x5316;&#x5F02;&#x5E38;&#x5904;&#x7406;&#xFF09;&#xFF09;&#x662F;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7684;&#x4E00;&#x79CD;&#x673A;&#x5236;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x5B83;&#x662F;&#x8BED;&#x8A00;&#x65E0;&#x5173;&#x7684;&#xFF0C;&#x4E0D;&#x7BA1;&#x662F;<code>C++</code>&#x6216;&#x8005;&#x5176;&#x5B83;OOP&#x8BED;&#x8A00;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;SEH&#xFF08;&#x4ECE;<code>C++</code>&#x548C;MSVC&#x6269;&#x5C55;&#xFF09;&#x662F;&#x72EC;&#x7ACB;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;&#x8FD0;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#x90FD;&#x6709;&#x4E00;&#x4E2A;SEH&#x5904;&#x7406;&#x94FE;&#xFF0C;TIB&#x6709;&#x5B83;&#x6700;&#x540E;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x7684;&#x5730;&#x5740;&#x3002;&#x5F53;&#x5F02;&#x5E38;&#x53D1;&#x751F;&#x65F6;(&#x9664;&#x96F6;&#xFF0C;&#x9519;&#x8BEF;&#x7684;&#x5730;&#x5740;&#x8BBF;&#x95EE;&#xFF0C;&#x7528;&#x6237;&#x901A;&#x8FC7;&#x8C03;&#x7528;RaiseException()&#x51FD;&#x6570;&#x5F15;&#x53D1;&#x5F02;&#x5E38;)&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5728;TIB&#x627E;&#x5230;&#x6700;&#x540E;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x5E76;&#x8C03;&#x7528;&#x5B83;&#xFF0C;&#x83B7;&#x53D6;&#x5F02;&#x5E38;&#x65F6;CPU&#x7684;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#xFF08;&#x5982;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#x7B49;&#x7B49;&#xFF09;&#x3002;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x5F53;&#x524D;&#x7684;&#x5F02;&#x5E38;&#x80FD;&#x5426;&#x4FEE;&#x590D;&#xFF0C;&#x5982;&#x679C;&#x80FD;&#xFF0C;&#x5219;&#x4FEE;&#x590D;&#x8BE5;&#x5F02;&#x5E38;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x80FD;&#xFF0C;&#x5B83;&#x901A;&#x77E5;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x65E0;&#x6CD5;&#x5904;&#x7406;&#x5B83;&#x5E76;&#x7531;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x94FE;&#x4E2D;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x7A0B;&#x5E8F;,&#x76F4;&#x5230;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x80FD;&#x591F;&#x5904;&#x7406;&#x7684;&#x5F02;&#x5E38;&#x88AB;&#x53D1;&#x73B0;&#x3002;</p>
<p>&#x5728;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x94FE;&#x7684;&#x7ED3;&#x5C3E;&#x5904;&#x6709;&#x4E00;&#x4E2A;&#x6807;&#x51C6;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x5B83;&#x663E;&#x793A;&#x4E00;&#x4E2A;&#x5BF9;&#x8BDD;&#x6846;&#x7528;&#x4E8E;&#x901A;&#x77E5;&#x7528;&#x6237;&#x8FDB;&#x7A0B;&#x5D29;&#x6E83;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x4E00;&#x4E9B;&#x5D29;&#x6E83;&#x65F6;CPU&#x7684;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#xFF0C;&#x6536;&#x96C6;&#x8D77;&#x6765;&#x5E76;&#x5C06;&#x5176;&#x53D1;&#x9001;&#x7ED9;&#x5FAE;&#x8F6F;&#x5F00;&#x53D1;&#x5546;&#x3002;</p>
<p><img src="img/C68-Figure_68.2_Windows_XP.jpg" alt="Figure 68.2: Windows XP"></p>
<p>Figure 68.2: Windows XP</p>
<p><img src="img/C68-Figure_68.3_Windows_XP.jpg" alt="Figure 68.3: Windows XP"></p>
<p>Figure 68.3: Windows XP</p>
<p><img src="img/C68-Figure_68.4_Windows_7.jpg" alt="Figure 68.4: Windows 7"></p>
<p>Figure 68.4: Windows 7</p>
<p><img src="img/C68-Figure_68.5_Windows_8.1.jpg" alt="Figure 68.5: Windows 8.1"></p>
<p>Figure 68.5: Windows 8.1</p>
<p>&#x65E9;&#x4E9B;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x88AB;&#x79F0;&#x4E3A;Dr.Watson&#x3002;</p>
<p>&#x987A;&#x4FBF;&#x8BF4;&#x4E00;&#x53E5;&#xFF0C;&#x6709;&#x4E9B;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x4F1A;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x53D1;&#x9001;&#x7A0B;&#x5E8F;&#x5D29;&#x6E83;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x901A;&#x8FC7;SetUnhandledExceptionFilter()&#x51FD;&#x6570;&#x6CE8;&#x518C;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x5982;&#x679C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x5176;&#x5B83;&#x65B9;&#x5F0F;&#x5904;&#x7406;&#x5F02;&#x5E38;&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x5B83;&#x3002;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x662F;Oracle RDBMS&#xFF0C;&#x5B83;&#x4FDD;&#x5B58;&#x4E86;CPU&#x6240;&#x6709;&#x53EF;&#x80FD;&#x6709;&#x7528;&#x7684;&#x4FE1;&#x606F;&#x548C;&#x5185;&#x5B58;&#x72B6;&#x6001;&#x7684;&#x5DE8;&#x5927;&#x8F6C;&#x50A8;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x5199;&#x4E00;&#x4E2A;&#x81EA;&#x5DF1;&#x7684;primitive exception handler&#xFF1A;</p>
<pre><code>#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

DWORD new_value=1234;

EXCEPTION_DISPOSITION __cdecl except_handler(
    struct _EXCEPTION_RECORD *ExceptionRecord,
    void * EstablisherFrame,
    struct _CONTEXT *ContextRecord,
    void * DispatcherContext )
{
    unsigned i;

    printf (&quot;%s\n&quot;, __FUNCTION__);
    printf (&quot;ExceptionRecord-&gt;ExceptionCode=0x%p\n&quot;, ExceptionRecord-&gt;ExceptionCode);
    printf (&quot;ExceptionRecord-&gt;ExceptionFlags=0x%p\n&quot;, ExceptionRecord-&gt;ExceptionFlags);
    printf (&quot;ExceptionRecord-&gt;ExceptionAddress=0x%p\n&quot;, ExceptionRecord-&gt;ExceptionAddress);
    if (ExceptionRecord-&gt;ExceptionCode==0xE1223344)
    {
        printf (&quot;That&apos;s for us\n&quot;);
        // yes, we &quot;handled&quot; the exception
        return ExceptionContinueExecution;
    }
    else if (ExceptionRecord-&gt;ExceptionCode==EXCEPTION_ACCESS_VIOLATION)
    {
        printf (&quot;ContextRecord-&gt;Eax=0x%08X\n&quot;, ContextRecord-&gt;Eax);
        // will it be possible to &apos;fix&apos; it?
        printf (&quot;Trying to fix wrong pointer address\n&quot;);
        ContextRecord-&gt;Eax=(DWORD)&amp;new_value;
        // yes, we &quot;handled&quot; the exception
        return ExceptionContinueExecution;
    }
    else
    {
        printf (&quot;We do not handle this\n&quot;);
        // someone else&apos;s problem
        return ExceptionContinueSearch;
    };
}
int main()
{
    DWORD handler = (DWORD)except_handler; // take a pointer to our handler
    // install exception handler
    __asm
    { // make EXCEPTION_REGISTRATION record:
        push handler // address of handler function
        push FS:[0] // address of previous handler
        mov FS:[0],ESP // add new EXECEPTION_REGISTRATION
    }
    RaiseException (0xE1223344, 0, 0, NULL);
    // now do something very bad
    int* ptr=NULL;
    int val=0;
    val=*ptr;
    printf (&quot;val=%d\n&quot;, val);
    // deinstall exception handler
    __asm
    { // remove our EXECEPTION_REGISTRATION record
        mov eax,[ESP] // get pointer to previous record
        mov FS:[0], EAX // install previous record
        add esp, 8 // clean our EXECEPTION_REGISTRATION off stack
    }
    return 0;
}
</code></pre><p>FS&#x6BB5;&#x5BC4;&#x5B58;&#x5668;&#xFF1A;&#x5728;Win32&#x6307;&#x5411;TIB&#x3002;&#x5728;TIB&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x662F;&#x6307;&#x5411;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6307;&#x9488;&#x94FE;&#x4E2D;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x81EA;&#x5DF1;&#x7684;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x7684;&#x5730;&#x5740;&#x4FDD;&#x5B58;&#x5728;&#x8FD9;&#x91CC;&#x3002;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x94FE;&#x7684;&#x7ED3;&#x70B9;&#x7ED3;&#x6784;&#x4F53;&#x540D;&#x5B57;&#x662F;_EXCEPTION_REGISTRATION&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x94FE;&#x8868;&#x5B9E;&#x73B0;&#x7684;&#x6808;&#x5BB9;&#x5668;&#x3002;</p>
<p>Listing 68.1: MSVC/VC/crt/src/exsup.inc</p>
<pre><code>\_EXCEPTION\_REGISTRATION struc
    prev dd ?
    handler dd ?
\_EXCEPTION\_REGISTRATION ends
</code></pre><p>&#x6BCF;&#x4E2A;&#x7ED3;&#x70B9;&#x7684;handler&#x5B57;&#x6BB5;&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x6BCF;&#x4E2A;&#x7ED3;&#x70B9;&#x7684;prev&#x5B57;&#x6BB5;&#x6307;&#x5411;&#x5728;&#x6808;&#x4E2D;&#x7684;&#x4E0A;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x3002;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x7684;prev&#x6307;&#x5411;0xFFFFFFFF(-1)&#x3002;</p>
<p><img src="img/C68-exception.jpg" alt="Figure 68.5: Windows 8.1"></p>
<p>&#x6211;&#x4EEC;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x5B89;&#x88C5;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x8C03;&#x7528;RaiseException()&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x5F02;&#x5E38;&#x3002;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x68C0;&#x67E5;&#x5F02;&#x5E38;&#x4EE3;&#x7801;&#xFF0C;&#x5982;&#x679C;&#x5F02;&#x5E38;&#x4EE3;&#x7801;&#x662F;0xE1223344&#xFF0C;&#x5B83;&#x8FD4;&#x56DE;ExceptionContinueExecution&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x4FEE;&#x590D;&#x4E86;CPU&#x7684;&#x72B6;&#x6001;&#xFF08;&#x901A;&#x5E38;&#x662F;EIP/ESP&#x5BC4;&#x5B58;&#x5668;&#xFF09;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53EF;&#x4EE5;&#x6062;&#x590D;&#x8FD0;&#x884C;&#x3002;&#x5982;&#x679C;&#x4F60;&#x7A0D;&#x5FAE;&#x4FEE;&#x6539;&#x4E00;&#x4E0B;&#x4EE3;&#x7801;&#xFF0C;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x8FD4;&#x56DE;ExceptionContinueSearch&#xFF0C;&#x90A3;&#x4E48;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5C06;&#x8C03;&#x7528;&#x4E0B;&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF08;&#x56E0;&#x4E3A;&#x6CA1;&#x4EBA;&#x6355;&#x83B7;&#x8BE5;&#x5F02;&#x5E38;&#xFF09;&#xFF0C;&#x4F60;&#x4F1A;&#x770B;&#x5230;&#x6807;&#x51C6;&#x7684;Windows&#x8FDB;&#x7A0B;&#x5D29;&#x6E83;&#x5BF9;&#x8BDD;&#x6846;&#x3002;</p>
<p>&#x7CFB;&#x7EDF;&#x5F02;&#x5E38;&#x548C;&#x7528;&#x6237;&#x5F02;&#x5E38;&#x4E4B;&#x95F4;&#x7684;&#x533A;&#x522B;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x8FD9;&#x91CC;&#x6709;&#x7CFB;&#x7EDF;&#x7684;&#xFF1A;</p>
<table>
<thead>
<tr>
<th>as defined in WinBase.h</th>
<th>as defined in ntstatus.h numerical</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>EXCEPTION_ACCESS_VIOLATION</td>
<td>STATUS_ACCESS_VIOLATION</td>
<td>0xC0000005</td>
</tr>
<tr>
<td>EXCEPTION_DATATYPE_MISALIGNMENT</td>
<td>STATUS_DATATYPE_MISALIGNMENT</td>
<td>0x80000002</td>
</tr>
<tr>
<td>EXCEPTION_BREAKPOINT</td>
<td>STATUS_BREAKPOINT</td>
<td>0x80000003</td>
</tr>
<tr>
<td>EXCEPTION_SINGLE_STEP</td>
<td>STATUS_SINGLE_STEP</td>
<td>0x80000004</td>
</tr>
<tr>
<td>EXCEPTION_ARRAY_BOUNDS_EXCEEDED</td>
<td>STATUS_ARRAY_BOUNDS_EXCEEDED</td>
<td>0xC000008C</td>
</tr>
<tr>
<td>EXCEPTION_FLT_DENORMAL_OPERAND</td>
<td>STATUS_FLOAT_DENORMAL_OPERAND</td>
<td>0xC000008D</td>
</tr>
<tr>
<td>EXCEPTION_FLT_DIVIDE_BY_ZERO</td>
<td>STATUS_FLOAT_DIVIDE_BY_ZERO</td>
<td>0xC000008E</td>
</tr>
<tr>
<td>EXCEPTION_FLT_INEXACT_RESULT</td>
<td>STATUS_FLOAT_INEXACT_RESULT</td>
<td>0xC000008F</td>
</tr>
<tr>
<td>EXCEPTION_FLT_INVALID_OPERATION</td>
<td>STATUS_FLOAT_INVALID_OPERATION</td>
<td>0xC0000090</td>
</tr>
<tr>
<td>EXCEPTION_FLT_OVERFLOW</td>
<td>STATUS_FLOAT_OVERFLOW</td>
<td>0xC0000091</td>
</tr>
<tr>
<td>EXCEPTION_FLT_STACK_CHECK</td>
<td>STATUS_FLOAT_STACK_CHECK</td>
<td>0xC0000092</td>
</tr>
<tr>
<td>EXCEPTION_FLT_UNDERFLOW</td>
<td>STATUS_FLOAT_UNDERFLOW</td>
<td>0xC0000093</td>
</tr>
<tr>
<td>EXCEPTION_INT_DIVIDE_BY_ZERO</td>
<td>STATUS_INTEGER_DIVIDE_BY_ZERO</td>
<td>0xC0000094</td>
</tr>
<tr>
<td>EXCEPTION_INT_OVERFLOW</td>
<td>STATUS_INTEGER_OVERFLOW</td>
<td>0xC0000095</td>
</tr>
<tr>
<td>EXCEPTION_PRIV_INSTRUCTION</td>
<td>STATUS_PRIVILEGED_INSTRUCTION</td>
<td>0xC0000096</td>
</tr>
<tr>
<td>EXCEPTION_IN_PAGE_ERROR</td>
<td>STATUS_IN_PAGE_ERROR</td>
<td>0xC0000006</td>
</tr>
<tr>
<td>EXCEPTION_ILLEGAL_INSTRUCTION</td>
<td>STATUS_ILLEGAL_INSTRUCTION</td>
<td>0xC000001D</td>
</tr>
<tr>
<td>EXCEPTION_NONCONTINUABLE_EXCEPTION</td>
<td>STATUS_NONCONTINUABLE_EXCEPTION</td>
<td>0xC0000025</td>
</tr>
<tr>
<td>EXCEPTION_STACK_OVERFLOW</td>
<td>STATUS_STACK_OVERFLOW</td>
<td>0xC00000FD</td>
</tr>
<tr>
<td>EXCEPTION_INVALID_DISPOSITION</td>
<td>STATUS_INVALID_DISPOSITION</td>
<td>0xC0000026</td>
</tr>
<tr>
<td>EXCEPTION_GUARD_PAGE</td>
<td>STATUS_GUARD_PAGE_VIOLATION</td>
<td>0x80000001</td>
</tr>
<tr>
<td>EXCEPTION_INVALID_HANDLE</td>
<td>STATUS_INVALID_HANDLE</td>
<td>0xC0000008</td>
</tr>
<tr>
<td>EXCEPTION_POSSIBLE_DEADLOCK</td>
<td>STATUS_POSSIBLE_DEADLOCK</td>
<td>0xC0000194</td>
</tr>
<tr>
<td>CONTROL_C_EXIT</td>
<td>STATUS_CONTROL_C_EXIT</td>
<td>0xC000013A</td>
</tr>
</tbody>
</table>
<p>&#x8FD9;&#x4E9B;&#x5F02;&#x5E38;&#x7801;&#x7684;&#x5B9A;&#x4E49;&#x89C4;&#x5219;&#x662F;&#xFF1A;</p>
<table>
<thead>
<tr>
<th>31</th>
<th>29</th>
<th>28</th>
<th>27 ~ 16</th>
<th>15 ~ 0</th>
</tr>
</thead>
<tbody>
<tr>
<td>S</td>
<td>U</td>
<td>0</td>
<td>Facility code</td>
<td>Error code</td>
</tr>
</tbody>
</table>
<p>S&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x672C;&#x4EE3;&#x7801;: 11&#x2014;error; 10&#x2014;warning; 01&#x2014;informational; 00&#x2014;success&#xFF1B;U&#x8868;&#x793A;&#x662F;&#x5426;&#x662F;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x9009;&#x62E9;&#x4E86;0xE1223344&#xFF0C;0xE(1110b)&#x610F;&#x5473;&#x7740;1&#xFF09;user exception&#xFF08;&#x7528;&#x6237;&#x5F02;&#x5E38;&#xFF09;;2&#xFF09;error&#xFF08;&#x9519;&#x8BEF;&#xFF09;&#x3002;</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x5C1D;&#x8BD5;&#x8BFB;&#x53D6;&#x5730;&#x5740;&#x4E3A;0&#x7684;&#x5185;&#x5B58;&#x65F6;&#x3002;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x5728;win32&#x4E2D;&#x5E76;&#x4E0D;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x5F15;&#x53D1;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#x3002;&#x901A;&#x8FC7;&#x68C0;&#x67E5;&#x5F02;&#x5E38;&#x7801;&#x662F;&#x5426;&#x7B49;&#x4E8E;EXCEPTION_ACCESS_VIOLATION&#x5E38;&#x91CF;&#x3002;</p>
<p>&#x8BFB;0&#x5730;&#x5740;&#x5185;&#x5B58;&#x7684;&#x4EE3;&#x7801;&#x770B;&#x8D77;&#x6765;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<p>Listing 68.2: MSVC 2010</p>
<pre><code>...
    xor eax, eax
    mov eax, DWORD PTR [eax] ; exception will occur here
    push eax
    push OFFSET msg
    call _printf
    add esp, 8
...
</code></pre><p>&#x80FD;&#x5426;&#x4FEE;&#x590D;&#x201C;on the fly&#x201D;&#x8FD9;&#x4E2A;&#x9519;&#x8BEF;&#x7136;&#x540E;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#xFF1F;&#x5F53;&#x7136;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x4FEE;&#x590D;EAX&#x503C;&#x7136;&#x540E;&#x8BA9;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x4E0B;&#x53BB;&#x3002;&#x8FD9;&#x662F;&#x6211;&#x4EEC;&#x8BE5;&#x505A;&#x7684;&#x3002;printf()&#x5C06;&#x6253;&#x5370;1234&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x540E;EAX&#x4E0D;&#x662F;0&#xFF0C;&#x800C;&#x662F;&#x5168;&#x5C40;&#x53D8;&#x91CF;new_value&#x7684;&#x5730;&#x5740;&#x3002;</p>
<p>&#x82E5;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x5668;&#x6709;&#x4E00;&#x4E2A;&#x5173;&#x4E8E;CPU&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x53F7;&#xFF0C;CPU&#x4F1A;&#x6682;&#x505C;&#x7EBF;&#x7A0B;&#xFF0C;&#x5728;Windows&#x5185;&#x6838;&#x67E5;&#x627E;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x7136;&#x540E;&#x4E00;&#x4E2A;&#x4E00;&#x4E2A;&#x8C03;&#x7528;SEH&#x94FE;&#x7684;handler&#x3002;</p>
<p>&#x6211;&#x5728;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;MSVC 2010&#xFF0C;&#x5F53;&#x7136;&#xFF0C;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4FDD;&#x8BC1;EAX&#x5C06;&#x7528;&#x4E8E;&#x8FD9;&#x4E2A;&#x6307;&#x9488;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x66FF;&#x6362;&#x7684;&#x6280;&#x5DE7;&#x975E;&#x5E38;&#x7684;&#x6F02;&#x4EAE;&#xFF0C;&#x6211;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x5B83;&#x63D2;&#x5165;&#x5230;SEH&#x5185;&#x90E8;&#x4E2D;&#x3002;&#x4E0D;&#x8FC7;&#xFF0C;&#x6211;&#x5FD8;&#x8BB0;&#x4E86;&#x5728;&#x54EA;&#x91CC;&#x7528;&#x5B83;&#x4FEE;&#x590D;&#x201C;on the fly&#x201D;&#x9519;&#x8BEF;&#x3002;</p>
<p>&#x4E3A;&#x4EC0;&#x4E48;SHE&#x76F8;&#x5173;&#x7684;&#x8BB0;&#x5F55;&#x5B58;&#x50A8;&#x5728;&#x6808;&#x4E0A;&#x800C;&#x4E0D;&#x662F;&#x5176;&#x5B83;&#x5730;&#x65B9;&#xFF1F;&#x636E;&#x8BF4;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0D;&#x9700;&#x8981;&#x5728;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#x5173;&#x5FC3;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x3002;&#x4F46;&#x6211;&#x4E0D;&#x80FD;100%&#x80AF;&#x5B9A;&#x3002;&#x8FD9;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;alloca()&#x3002;</p>
<h3 id="6832-&#x73B0;&#x5728;&#x8BA9;&#x6211;&#x4EEC;&#x56DE;&#x5230;msvc">68.3.2 &#x73B0;&#x5728;&#x8BA9;&#x6211;&#x4EEC;&#x56DE;&#x5230;MSVC</h3>
<p>&#x636E;&#x8BF4;&#xFF0C;&#x5FAE;&#x8F6F;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#x9700;&#x8981;&#x5728;C&#x8BED;&#x8A00;&#x800C;&#x4E0D;&#x662F;<code>C++</code>&#x4E0A;&#x4F7F;&#x7528;&#x5F02;&#x5E38;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x4EEC;&#x5728;MSVC&#x4E0A;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x975E;&#x6807;&#x51C6;&#x7684;C&#x6269;&#x5C55;&#x3002;&#x5B83;&#x4E0E;<code>C++</code>&#x7684;&#x5F02;&#x5E38;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x5173;&#x8054;&#x3002;</p>
<pre><code>__try
{
    ...
}
__except(filter code)
{
    handler code
}
</code></pre><p>&#x201C;Finally&#x201D;&#x5757;&#x4E5F;&#x8BB8;&#x80FD;&#x4EE3;&#x66FF;handler code&#xFF1A;</p>
<pre><code>__try
{
    ...
}
__finally
{
    ...
}
</code></pre><p>filte code&#x662F;&#x4E00;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x544A;&#x8BC9;handler code&#x662F;&#x5426;&#x5BF9;&#x5E94;&#x5F15;&#x53D1;&#x7684;&#x5F02;&#x5E38;&#x3002;&#x5982;&#x679C;&#x4F60;&#x7684;filte code&#x592A;&#x5927;&#x800C;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;filte&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5728;Windows&#x5185;&#x6838;&#x6709;&#x5F88;&#x591A;&#x8FD9;&#x6837;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x51E0;&#x4E2A;&#x4F8B;&#x5B50;&#xFF08;WRK&#xFF08;Windows Research Kernel&#xFF09;&#xFF09;&#xFF1A;</p>
<p>Listing 68.3: WRK-v1.2/base/ntos/ob/obwait.c</p>
<pre><code>try {
    KeReleaseMutant( (PKMUTANT)SignalObject,
                      MUTANT_INCREMENT,
                      FALSE,
                      TRUE );
} except((GetExceptionCode () == STATUS_ABANDONED ||
          GetExceptionCode () == STATUS_MUTANT_NOT_OWNED)?
          EXCEPTION_EXECUTE_HANDLER :
          EXCEPTION_CONTINUE_SEARCH) {
    Status = GetExceptionCode();
    goto WaitExit;
}
</code></pre><p>Listing 68.4: WRK-v1.2/base/ntos/cache/cachesub.c</p>
<pre><code>try {
    RtlCopyBytes( (PVOID)((PCHAR)CacheBuffer + PageOffset),
                   UserBuffer,
                   MorePages ?
                  (PAGE_SIZE - PageOffset) :
                  (ReceivedLength - PageOffset) );
} except( CcCopyReadExceptionFilter( GetExceptionInformation(), Status ) ) {
</code></pre><p>&#x8FD9;&#x91CC;&#x662F;&#x4E00;&#x4E2A;filter code&#x7684;&#x4F8B;&#x5B50;&#xFF1A;</p>
<p>Listing 68.5: WRK-v1.2/base/ntos/cache/copysup.c</p>
<pre><code>LONG
CcCopyReadExceptionFilter(
    IN PEXCEPTION_POINTERS ExceptionPointer,
    IN PNTSTATUS ExceptionCode
)

/*++

Routine Description:
    This routine serves as a exception filter and has the special job of
    extracting the &quot;real&quot; I/O error when Mm raises STATUS_IN_PAGE_ERROR
    beneath us.
Arguments:
    ExceptionPointer - A pointer to the exception record that contains
    the real Io Status.
    ExceptionCode - A pointer to an NTSTATUS that is to receive the real
    status.
Return Value:
    EXCEPTION_EXECUTE_HANDLER

--*/
{
    *ExceptionCode = ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionCode;
    if ( (*ExceptionCode == STATUS_IN_PAGE_ERROR) &amp;&amp;
         (ExceptionPointer-&gt;ExceptionRecord-&gt;NumberParameters &gt;= 3) ) {
        *ExceptionCode = (NTSTATUS) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionInformation[2];
    }
    ASSERT( !NT_SUCCESS(*ExceptionCode) );
    return EXCEPTION_EXECUTE_HANDLER;
}
</code></pre><p>&#x5728;&#x5185;&#x90E8;&#xFF0C;SEH&#x662F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x652F;&#x6301;&#x7684;&#x5F02;&#x5E38;&#x6269;&#x5C55;&#x3002;&#x4F46;&#x662F;&#x5904;&#x7406;&#x51FD;&#x6570;&#x662F;_except_handler3&#xFF08;&#x5BF9;&#x4E8E;SEH3&#xFF09;&#x6216;_except_handler4&#xFF08;&#x5BF9;&#x4E8E;SEH4&#xFF09;&#x3002; &#x8FD9;&#x4E2A;&#x5904;&#x7406;&#x51FD;&#x6570;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x4E0E;MSVC&#x76F8;&#x5173;&#x7684;&#xFF0C;&#x5B83;&#x4F4D;&#x4E8E;&#x5B83;&#x7684;&#x5E93;&#x6216;&#x5728;msvcr*.dll&#x6587;&#x4EF6;&#x3002;&#x5176;&#x4ED6;&#x7684;Win32&#x7F16;&#x8BD1;&#x5668;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x4E0E;&#x4E4B;&#x5B8C;&#x5168;&#x4E0D;&#x540C;&#x7684;&#x673A;&#x5236;&#x3002;</p>
<h4 id="seh3">SEH3</h4>
<p>SEH3&#x6709;&#x4E00;&#x4E2A;_except_handler3&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF0C;&#x800C;&#x4E14;&#x6269;&#x5C55;&#x4E86;_EXCEPTION_REGISTRATION&#x8868;&#xFF0C;&#x5E76;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5411;scope table&#x548C;previous try level&#x53D8;&#x91CF;&#x3002;SEH4&#x6269;&#x5C55;&#x4E86;scope table&#x7F13;&#x51B2;&#x6EA2;&#x51FA;&#x4FDD;&#x62A4;&#x3002;</p>
<p>scope table&#x662F;&#x4E00;&#x4E2A;&#x8868;&#xFF0C;&#x5305;&#x542B;&#x4E86;&#x6307;&#x5411;filter&#x548C;handler code&#x7684;&#x5757;&#x548C;&#x6BCF;&#x4E2A;try/except&#x5D4C;&#x5957;&#x3002;</p>
<p><img src="img/C68-seh3.jpg" alt="scopetable"></p>
<p>&#x518D;&#x8005;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53EA;&#x5173;&#x5FC3;prev/handle&#x5B57;&#x6BB5;&#x3002;_except_handler3&#x51FD;&#x6570;&#x7684;&#x5DE5;&#x4F5C;&#x662F;&#x8BFB;&#x53D6;&#x5176;&#x4ED6;&#x5B57;&#x6BB5;&#x548C;scope table&#xFF0C;&#x5E76;&#x51B3;&#x5B9A;&#x7531;&#x54EA;&#x4E9B;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x6765;&#x6267;&#x884C;&#x3002;</p>
<p>_except_handler3&#x51FD;&#x6570;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x662F;&#x95ED;&#x6E90;&#x7684;&#x3002;&#x7136;&#x800C;&#xFF0C;Sanos&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;win32&#x517C;&#x5BB9;&#x6027;&#x5C42;&#x91CD;&#x65B0;&#x5B9E;&#x73B0;&#x76F8;&#x540C;&#x7684;&#x529F;&#x80FD;&#x3002;&#x5176;&#x5B83;&#x7C7B;&#x4F3C;&#x7684;&#x5B9E;&#x73B0;&#x6709;Wine&#x548C;ReactOS&#x3002;</p>
<p>&#x5982;&#x679C;filter&#x6307;&#x9488;&#x4E3A;NULL&#xFF0C;handler&#x6307;&#x9488;&#x5219;&#x6307;&#x5411;finally&#x4EE3;&#x7801;&#x5757;&#x3002;</p>
<p>&#x6267;&#x884C;&#x671F;&#x95F4;&#xFF0C;&#x6808;&#x4E2D;&#x7684;previous try level&#x53D8;&#x91CF;&#x53D1;&#x751F;&#x53D8;&#x5316;&#xFF0C;&#x6240;&#x4EE5;_except_handler3&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5D4C;&#x5957;&#x7EA7;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x624D;&#x77E5;&#x9053;&#x8981;&#x4F7F;&#x7528;scope table&#x54EA;&#x4E00;&#x8868;&#x9879;&#x3002;</p>
<h4 id="seh3-&#x4E00;&#x4E2A;tryexcept&#x5757;&#x4F8B;&#x5B50;">SEH3: &#x4E00;&#x4E2A;try/except&#x5757;&#x4F8B;&#x5B50;</h4>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;excpt.h&gt;
int main()
{
    int* p = NULL;
    __try
    {
        printf(&quot;hello #1!\n&quot;);
        *p = 13; // causes an access violation exception;
        printf(&quot;hello #2!\n&quot;);
    }
    __except(GetExceptionCode()==EXCEPTION_ACCESS_VIOLATION ?
             EXCEPTION_EXECUTE_HANDLER : EXCEPTION_CONTINUE_SEARCH)
    {
        printf(&quot;access violation, can&apos;t recover\n&quot;);
    }
}
</code></pre><p>Listing 68.6: MSVC 2003</p>
<pre><code>$SG74605 DB &apos;hello #1!&apos;, 0aH, 00H
$SG74606 DB &apos;hello #2!&apos;, 0aH, 00H
$SG74608 DB &apos;access violation, can&apos;&apos;t recover&apos;, 0aH, 00H
_DATA ENDS

; scope table

CONST SEGMENT
$T74622 DD 0ffffffffH   ; previous try level
    DD FLAT:$L74617     ; filter
    DD FLAT:$L74618     ; handler
CONST ENDS

_TEXT SEGMENT
$T74621 = -32     ; size = 4
_p$ = -28         ; size = 4
__$SEHRec$ = -24  ; size = 24
_main PROC NEAR
    push ebp
    mov ebp, esp
    push -1                              ; previous try level
    push OFFSET FLAT:$T74622             ; scope table
    push OFFSET FLAT:__except_handler3   ; handler
    mov eax, DWORD PTR fs:__except_list
    push eax                             ; prev
    mov DWORD PTR fs:__except_list, esp
    add esp, -16
    push ebx                             ; saved 3 registers
    push esi                             ; saved 3 registers
    push edi                             ; saved 3 registers
    mov DWORD PTR __$SEHRec$[ebp], esp
    mov DWORD PTR _p$[ebp], 0
    mov DWORD PTR __$SEHRec$[ebp+20], 0   ; previous try level
    push OFFSET FLAT:$SG74605             ; &apos;hello #1!&apos;
    call _printf
    add esp, 4
    mov eax, DWORD PTR _p$[ebp]
    mov DWORD PTR [eax], 13
    push OFFSET FLAT:$SG74606             ; &apos;hello #2!&apos;
    call _printf
    add esp, 4
    mov DWORD PTR __$SEHRec$[ebp+20], -1  ; previous try level
    jmp SHORT $L74616
    ; filter code
$L74617:
$L74627:
    mov ecx, DWORD PTR __$SEHRec$[ebp+4]
    mov edx, DWORD PTR [ecx]
    mov eax, DWORD PTR [edx]
    mov DWORD PTR $T74621[ebp], eax
    mov eax, DWORD PTR $T74621[ebp]
    sub eax, -1073741819; c0000005H
    neg eax
    sbb eax, eax
    inc eax
$L74619:
$L74626:
    ret 0
    ; handler code
$L74618:
    mov esp, DWORD PTR __$SEHRec$[ebp]
    push OFFSET FLAT:$SG74608             ; &apos;access violation, can&apos;&apos;t recover&apos;
    call _printf
    add esp, 4
    mov DWORD PTR __$SEHRec$[ebp+20], -1  ; setting previous try level back to -1
$L74616:
    xor eax, eax
    mov ecx, DWORD PTR __$SEHRec$[ebp+8]
    mov DWORD PTR fs:__except_list, ecx
    pop edi
    pop esi
    pop ebx
    mov esp, ebp
    pop ebp
    ret 0
_main ENDP
_TEXT ENDS
END
</code></pre><p>&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;SEH&#x5E27;&#x662F;&#x5982;&#x679C;&#x5728;&#x6808;&#x4E2D;&#x6784;&#x5EFA;&#x51FA;&#x6765;&#x7684;&#xFF0C;scope table&#x4F4D;&#x4E8E;CONST segment-&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;&#x8FD9;&#x4E9B;&#x5B57;&#x6BB5;&#x662F;&#x4E0D;&#x88AB;&#x6539;&#x53D8;&#x7684;&#x3002;&#x4E00;&#x4EF6;&#x6709;&#x8DA3;&#x7684;&#x4E8B;&#x60C5;&#x662F;&#x5982;&#x4F55;&#x6539;&#x53D8;previous try level&#x53D8;&#x91CF;&#x3002;&#x5B83;&#x7684;&#x521D;&#x59CB;&#x5316;&#x503C;&#x662F;0xFFFFFFFF(-1)&#x3002;&#x5F53;&#x8FDB;&#x5165;try&#x8BED;&#x53E5;&#x5757;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x4E3A;0&#x3002;&#x5F53;try&#x8BED;&#x53E5;&#x5757;&#x7ED3;&#x675F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5199;&#x56DE;-1&#x3002;&#x6211;&#x4EEC;&#x8FD8;&#x80FD;&#x770B;&#x5230;filter&#x548C;handler code&#x7684;&#x5730;&#x5740;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F88;&#x5BB9;&#x6613;&#x5728;&#x51FD;&#x6570;&#x91CC;&#x770B;&#x5230;try/except&#x662F;&#x5982;&#x4F55;&#x6784;&#x9020;&#x7684;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x51FD;&#x6570;&#x5E8F;&#x8A00;&#x7684;SEH&#x5B89;&#x88C5;&#x4EE3;&#x7801;&#x88AB;&#x591A;&#x4E2A;&#x51FD;&#x6570;&#x5171;&#x4EAB;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x5728;&#x51FD;&#x6570;&#x5E8F;&#x8A00;&#x63D2;&#x5165;&#x8C03;&#x7528;SEH_prolog()&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x3002;&#x8BE5;SEH&#x56DE;&#x6536;&#x4EE3;&#x7801;&#x662F;SEH_epilog()&#x51FD;&#x6570;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x5C1D;&#x8BD5;&#x7528;tracer&#x8FD0;&#x884C;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code>tracer.exe -l:2.exe --dump-seh
</code></pre><p>Listing 68.7: tracer.exe output</p>
<pre><code>EXCEPTION_ACCESS_VIOLATION at 2.exe!main+0x44 (0x401054) ExceptionInformation[0]=1
EAX=0x00000000 EBX=0x7efde000 ECX=0x0040cbc8 EDX=0x0008e3c8
ESI=0x00001db1 EDI=0x00000000 EBP=0x0018feac ESP=0x0018fe80
EIP=0x00401054
FLAGS=AF IF RF
* SEH frame at 0x18fe9c prev=0x18ff78 handler=0x401204 (2.exe!_except_handler
SEH3 frame. previous trylevel=0
scopetable entry[0]. previous try level=-1, filter=0x401070 (2.exe!main+0x60) handler=0x401088 (2.exe!main+0x78)
* SEH frame at 0x18ff78 prev=0x18ffc4 handler=0x401204 (2.exe!_except_handler3)
SEH3 frame. previous trylevel=0
scopetable entry[0]. previous try level=-1, filter=0x401531 (2.exe!mainCRTStartup+0x18d) handler=0x401545 (2.exe!mainCRTStartup+0x1a1)
* SEH frame at 0x18ffc4 prev=0x18ffe4 handler=0x771f71f5 (ntdll.dll!__except_handler4)
SEH4 frame. previous trylevel=0
SEH4 header: GSCookieOffset=0xfffffffe GSCookieXOROffset=0x0
EHCookieOffset=0xffffffcc EHCookieXOROffset=0x0
scopetable entry[0]. previous try level=-2, filter=0x771f74d0 (ntdll.dll!___safe_se_handler_table+0x20) handler=0x771f90eb (ntdll.dll!_TppTerminateProcess@4+0x43)
* SEH frame at 0x18ffe4 prev=0xffffffff handler=0x77247428 (ntdll.dll!_FinalExceptionHandler@16)
</code></pre><p>&#x6211;&#x4EEC;&#x770B;&#x5230;&#xFF0C;SEH&#x94FE;&#x5305;&#x542B;4&#x4E2A;handler&#x3002;</p>
<p>&#x524D;&#x9762;&#x4E24;&#x4E2A;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x4F8B;&#x5B50;&#x3002;&#x4E24;&#x4E2A;&#xFF1F;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#xFF1F;&#x662F;&#x7684;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;CRT&#x7684;_mainCRTStartup()&#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x7684;&#x3002;&#x5E76;&#x81F3;&#x5C11;&#x4F5C;&#x4E3A;FPU&#x5F02;&#x5E38;&#x7684;&#x5904;&#x7406;&#x3002;&#x5B83;&#x7684;&#x6E90;&#x7801;&#x53EF;&#x4EE5;&#x5728;MSVC&#x7684;&#x5B89;&#x88C5;&#x76EE;&#x5F55;&#x627E;&#x5230;&#xFF1A;crt/src/winxfltr.c&#x3002;</p>
<p>&#x7B2C;&#x4E09;&#x4E2A;&#x662F;ntdll.dll&#x7684;SEH4&#xFF0C;&#x7B2C;&#x56DB;&#x4E2A;handler&#x4E5F;&#x4F4D;&#x4E8E;ntdll.dll&#xFF0C;&#x8DDF;MSVC&#x6CA1;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#xFF0C;&#x5B83;&#x6709;&#x4E00;&#x4E2A;&#x81EA;&#x63CF;&#x8FF0;&#x51FD;&#x6570;&#x540D;&#x3002;</p>
<p>&#x6B63;&#x5982;&#x4F60;&#x6240;&#x89C1;&#xFF0C;&#x5728;&#x4E00;&#x4E2A;&#x94FE;&#x4E2D;&#x6709;&#x4E09;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF1A;&#x4E00;&#x4E2A;&#x8DDF;MSVC(&#x6700;&#x540E;&#x4E00;&#x4E2A;)&#x6CA1;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#x548C;&#x4E24;&#x4E2A;&#x4E0E;MSVC&#x5173;&#x8054;&#x7684;&#xFF1A;SEH3&#x548C;SEH4&#x3002;</p>
<h4 id="seh3-&#x4E24;&#x4E2A;tryexcept&#x5757;&#x4F8B;&#x5B50;">SEH3: &#x4E24;&#x4E2A;try/except&#x5757;&#x4F8B;&#x5B50;</h4>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;excpt.h&gt;
int filter_user_exceptions (unsigned int code, struct _EXCEPTION_POINTERS *ep)
{
    printf(&quot;in filter. code=0x%08X\n&quot;, code);
    if (code == 0x112233)
    {
        printf(&quot;yes, that is our exception\n&quot;);
        return EXCEPTION_EXECUTE_HANDLER;
    }
    else
    {
        printf(&quot;not our exception\n&quot;);
        return EXCEPTION_CONTINUE_SEARCH;
    };
}
int main()
{
    int* p = NULL;
    __try
    {
        __try
        {
            printf (&quot;hello!\n&quot;);
            RaiseException (0x112233, 0, 0, NULL);
            printf (&quot;0x112233 raised. now let&apos;s crash\n&quot;);
            *p = 13; // causes an access violation exception;
        }
        __except(GetExceptionCode()==EXCEPTION_ACCESS_VIOLATION ?
                 EXCEPTION_EXECUTE_HANDLER : EXCEPTION_CONTINUE_SEARCH)
        {
            printf(&quot;access violation, can&apos;t recover\n&quot;);
        }
    }
    __except(filter_user_exceptions(GetExceptionCode(), GetExceptionInformation()))
    {
        // the filter_user_exceptions() function answering to the question
        // &quot;is this exception belongs to this block?&quot;
        // if yes, do the follow:
        printf(&quot;user exception caught\n&quot;);
    }
}
</code></pre><p>&#x73B0;&#x5728;&#x6709;&#x4E24;&#x4E2A;try&#x5757;&#xFF0C;&#x6240;&#x4EE5;scope table&#x73B0;&#x5728;&#x6709;&#x4E24;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x6BCF;&#x4E2A;&#x5757;&#x5360;&#x7528;&#x4E00;&#x4E2A;&#x3002;Previous try level&#x968F;&#x7740;try&#x5757;&#x7684;&#x8FDB;&#x5165;&#x6216;&#x9000;&#x51FA;&#x800C;&#x6539;&#x53D8;&#x3002;</p>
<p>Listing 68.8: MSVC 2003</p>
<pre><code>$SG74606 DB &apos;in filter. code=0x%08X&apos;, 0aH, 00H
$SG74608 DB &apos;yes, that is our exception&apos;, 0aH, 00H
$SG74610 DB &apos;not our exception&apos;, 0aH, 00H
$SG74617 DB &apos;hello!&apos;, 0aH, 00H
$SG74619 DB &apos;0x112233 raised. now let&apos;&apos;s crash&apos;, 0aH, 00H
$SG74621 DB &apos;access violation, can&apos;&apos;t recover&apos;, 0aH, 00H
$SG74623 DB &apos;user exception caught&apos;, 0aH, 00H
_code$ = 8 ; size = 4
_ep$ = 12 ; size = 4
_filter_user_exceptions PROC NEAR
    push ebp
    mov ebp, esp
    mov eax, DWORD PTR _code$[ebp]
    push eax
    push OFFSET FLAT:$SG74606 ; &apos;in filter. code=0x%08X&apos;
    call _printf
    add esp, 8
    cmp DWORD PTR _code$[ebp], 1122867; 00112233H
    jne SHORT $L74607
    push OFFSET FLAT:$SG74608 ; &apos;yes, that is our exception&apos;
    call _printf
    add esp, 4
    mov eax, 1
    jmp SHORT $L74605
$L74607:
    push OFFSET FLAT:$SG74610 ; &apos;not our exception&apos;
    call _printf
    add esp, 4
    xor eax, eax
$L74605:
    pop ebp
    ret 0
_filter_user_exceptions ENDP

    ; scope table

CONST SEGMENT
$T74644 DD 0ffffffffH ; previous try level for outer block
    DD FLAT:$L74634 ; outer block filter
    DD FLAT:$L74635 ; outer block handler
    DD 00H ; previous try level for inner block
    DD FLAT:$L74638 ; inner block filter
    DD FLAT:$L74639 ; inner block handler
CONST ENDS

$T74643 = -36 ; size = 4
$T74642 = -32 ; size = 4
_p$ = -28 ; size = 4
__$SEHRec$ = -24 ; size = 24
_main PROC NEAR
    push ebp
    mov ebp, esp
    push -1 ; previous try level
    push OFFSET FLAT:$T74644
    push OFFSET FLAT:__except_handler3
    mov eax, DWORD PTR fs:__except_list
    push eax
    mov DWORD PTR fs:__except_list, esp
    add esp, -20
    push ebx
    push esi
    push edi
    mov DWORD PTR __$SEHRec$[ebp], esp
    mov DWORD PTR _p$[ebp], 0
    mov DWORD PTR __$SEHRec$[ebp+20], 0 ; outer try block entered. set previous try level to 0
    mov DWORD PTR __$SEHRec$[ebp+20], 1 ; inner try block entered. set previous try level to 1
    push OFFSET FLAT:$SG74617 ; &apos;hello!&apos;
    call _printf
    add esp, 4
    push 0
    push 0
    push 0
    push 1122867 ; 00112233H
    call DWORD PTR __imp__RaiseException@16
    push OFFSET FLAT:$SG74619 ; &apos;0x112233 raised. now let&apos;&apos;s crash&apos;
    call _printf
    add esp, 4
    mov eax, DWORD PTR _p$[ebp]
    mov DWORD PTR [eax], 13
    mov DWORD PTR __$SEHRec$[ebp+20], 0 ; inner try block exited. set previous try level back to 0
    jmp SHORT $L74615
    ; inner block filter
$L74638:
$L74650:
    mov ecx, DWORD PTR __$SEHRec$[ebp+4]
    mov edx, DWORD PTR [ecx]
    mov eax, DWORD PTR [edx]
    mov DWORD PTR $T74643[ebp], eax
    mov eax, DWORD PTR $T74643[ebp]
    sub eax, -1073741819; c0000005H
    neg eax
    sbb eax, eax
    inc eax
$L74640:
$L74648:
    ret 0
    ; inner block handler
$L74639:
    mov esp, DWORD PTR __$SEHRec$[ebp]
    push OFFSET FLAT:$SG74621 ; &apos;access violation, can&apos;&apos;t recover&apos;
    call _printf
    add esp, 4
    mov DWORD PTR __$SEHRec$[ebp+20], 0 ; inner try block exited. set previous try level back to 0
$L74615:
    mov DWORD PTR __$SEHRec$[ebp+20], -1 ; outer try block exited, set previous try level back to -1
    jmp SHORT $L74633
    ; outer block filter
$L74634:
$L74651:
    mov ecx, DWORD PTR __$SEHRec$[ebp+4]
    mov edx, DWORD PTR [ecx]
    mov eax, DWORD PTR [edx]
    mov DWORD PTR $T74642[ebp], eax
    mov ecx, DWORD PTR __$SEHRec$[ebp+4]
    push ecx
    mov edx, DWORD PTR $T74642[ebp]
    push edx
    call _filter_user_exceptions
    add esp, 8
$L74636:
$L74649:
    ret 0
    ; outer block handler
$L74635:
    mov esp, DWORD PTR __$SEHRec$[ebp]
    push OFFSET FLAT:$SG74623 ; &apos;user exception caught&apos;
    call _printf
    add esp, 4
    mov DWORD PTR __$SEHRec$[ebp+20], -1 ; both try blocks exited. set previous try level back to -1
$L74633:
    xor eax, eax
    mov ecx, DWORD PTR __$SEHRec$[ebp+8]
    mov DWORD PTR fs:__except_list, ecx
    pop edi
    pop esi
    pop ebx
    mov esp, ebp
    pop ebp
    ret 0
_main ENDP
</code></pre><p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;handler&#x4E2D;&#x8C03;&#x7528;&#x7684;printf()&#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x65AD;&#x70B9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x53E6;&#x4E00;&#x4E2A;SEH handler&#x5982;&#x4F55;&#x88AB;&#x6DFB;&#x52A0;&#x3002;&#x540C;&#x6837;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x5230;scope table&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x5143;&#x7D20;&#x3002;</p>
<pre><code>tracer.exe -l:3.exe bpx=3.exe!printf --dump-seh
</code></pre><p>Listing 68.9: tracer.exe output</p>
<pre><code>(0) 3.exe!printf
EAX=0x0000001b EBX=0x00000000 ECX=0x0040cc58 EDX=0x0008e3c8
ESI=0x00000000 EDI=0x00000000 EBP=0x0018f840 ESP=0x0018f838
EIP=0x004011b6
FLAGS=PF ZF IF
* SEH frame at 0x18f88c prev=0x18fe9c handler=0x771db4ad (ntdll.dll!ExecuteHandler2@20+0x3a)
* SEH frame at 0x18fe9c prev=0x18ff78 handler=0x4012e0 (3.exe!_except_handler3)
SEH3 frame. previous trylevel=1
scopetable entry[0]. previous try level=-1, filter=0x401120 (3.exe!main+0xb0) handler=0x40113b (3.exe!main+0xcb)
scopetable entry[1]. previous try level=0, filter=0x4010e8 (3.exe!main+0x78) handler=0x401100 (3.exe!main+0x90)
* SEH frame at 0x18ff78 prev=0x18ffc4 handler=0x4012e0 (3.exe!_except_handler3)
SEH3 frame. previous trylevel=0
scopetable entry[0]. previous try level=-1, filter=0x40160d (3.exe!mainCRTStartup+0x18d) handler=0x401621 (3.exe!mainCRTStartup+0x1a1
* SEH frame at 0x18ffc4 prev=0x18ffe4 handler=0x771f71f5 (ntdll.dll!__except_handler4)
SEH4 frame. previous trylevel=0
SEH4 header: GSCookieOffset=0xfffffffe GSCookieXOROffset=0x0
EHCookieOffset=0xffffffcc EHCookieXOROffset=0x0
scopetable entry[0]. previous try level=-2, filter=0x771f74d0 (ntdll.dll!___safe_se_handler_table+0x20) handler=0x771f90eb (ntdll.dll!_TppTerminateProcess@4+0x43)
* SEH frame at 0x18ffe4 prev=0xffffffff handler=0x77247428 (ntdll.dll!_FinalExceptionHandler@16)
</code></pre><h4 id="seh4">SEH4</h4>
<p>&#x5728;&#x7F13;&#x51B2;&#x533A;&#x653B;&#x51FB;&#x671F;&#x95F4;&#xFF08;18.2&#x7AE0;&#xFF09;&#xFF0C;scope table&#x7684;&#x5730;&#x5740;&#x53EF;&#x4EE5;&#x88AB;&#x91CD;&#x5199;&#x3002;&#x6240;&#x4EE5;&#x4ECE;MSVC 2005&#x5F00;&#x59CB;&#xFF0C;SEH3&#x5347;&#x7EA7;&#x5230;SEH4&#x540E;&#x6709;&#x4E86;&#x7F13;&#x51B2;&#x533A;&#x6EA2;&#x51FA;&#x4FDD;&#x62A4;&#x3002;&#x73B0;&#x5728;scope table&#x6307;&#x9488;&#x4E0E;&#x4E00;&#x4E2A;security cookie&#xFF08;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x503C;&#xFF09;&#x505A;&#x5F02;&#x6216;&#x8FD0;&#x7B97;&#x3002;scope table&#x6269;&#x5C55;&#x4E86;&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x6307;&#x5411;security cookie&#x6307;&#x9488;&#x7684;&#x5934;&#x90E8;&#x3002;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x90FD;&#x6709;&#x53E6;&#x4E00;&#x4E2A;&#x6808;&#x5185;&#x504F;&#x79FB;&#x503C;&#xFF1A;&#x6808;&#x5E27;&#x7684;&#x5730;&#x5740;&#xFF08;EBP&#xFF09;&#x4E0E;security_cookie&#x5F02;&#x6216;&#x3002;&#x8BE5;&#x503C;&#x5C06;&#x5728;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x4E2D;&#x8BFB;&#x53D6;&#x5E76;&#x68C0;&#x67E5;&#x5176;&#x6B63;&#x786E;&#x6027;&#x3002;&#x6808;&#x4E2D;&#x7684;security cookie&#x6BCF;&#x6B21;&#x90FD;&#x662F;&#x968F;&#x673A;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8FDC;&#x7A0B;&#x653B;&#x51FB;&#x8005;&#x65E0;&#x6CD5;&#x9884;&#x6D4B;&#x5230;&#x5B83;&#x3002;</p>
<p>SEH4&#x7684;previous try level&#x521D;&#x59CB;&#x5316;&#x503C;&#x662F;-2&#x800C;&#x4E0D;&#x662F;-1&#x3002;</p>
<p><img src="img/C68-seh4.jpg" alt="seh4"></p>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x4F7F;&#x7528;MSVC&#x7F16;&#x8BD1;&#x7684;SEH4&#x4F8B;&#x5B50;&#xFF1A;</p>
<p>Listing 68.10: MSVC 2012: one try block example</p>
<pre><code>$SG85485 DB    &apos;hello #1!&apos;, 0aH, 00H
$SG85486 DB    &apos;hello #2!&apos;, 0aH, 00H
$SG85488 DB    &apos;access violation, can&apos;&apos;t recover&apos;, 0aH, 00H

; scope table:
xdata$x          SEGMENT
__sehtable$_main DD 0fffffffeH   ; GS Cookie Offset
    DD           00H             ; GS Cookie XOR Offset
    DD           0ffffffccH      ; EH Cookie Offset
    DD           00H             ; EH Cookie XOR Offset
    DD           0fffffffeH      ; previous try level
    DD           FLAT:$LN12@main ; filter
    DD           FLAT:$LN8@main  ; handler
xdata$x          ENDS

$T2 = -36        ; size = 4
_p$ = -32        ; size = 4
tv68 = -28       ; size = 4
__$SEHRec$ = -24 ; size = 24
_main    PROC
    push   ebp
    mov    ebp, esp
    push   -2
    push   OFFSET __sehtable$_main
    push   OFFSET __except_handler4
    mov    eax, DWORD PTR fs:0
    push   eax
    add    esp, -20
    push   ebx
    push   esi
    push   edi
    mov    eax, DWORD PTR ___security_cookie
    xor    DWORD PTR __$SEHRec$[ebp+16], eax ; xored pointer to scope table
    xor    eax, ebp
    push   eax                              ; ebp ^ security_cookie
    lea    eax, DWORD PTR __$SEHRec$[ebp+8] ; pointer to VC_EXCEPTION_REGISTRATION_RECORD
    mov    DWORD PTR fs:0, eax
    mov    DWORD PTR __$SEHRec$[ebp], esp
    mov    DWORD PTR _p$[ebp], 0
    mov    DWORD PTR __$SEHRec$[ebp+20], 0 ; previous try level
    push   OFFSET $SG85485 ; &apos;hello #1!&apos;
    call   _printf
    add    esp, 4
    mov    eax, DWORD PTR _p$[ebp]
    mov    DWORD PTR [eax], 13
    push   OFFSET $SG85486 ; &apos;hello #2!&apos;
    call   _printf
    add    esp, 4
    mov    DWORD PTR __$SEHRec$[ebp+20], -2 ; previous try level
    jmp    SHORT $LN6@main

; filter:
$LN7@main:
$LN12@main:
    mov    ecx, DWORD PTR __$SEHRec$[ebp+4]
    mov    edx, DWORD PTR [ecx]
    mov    eax, DWORD PTR [edx]
    mov    DWORD PTR $T2[ebp], eax
    cmp    DWORD PTR $T2[ebp], -1073741819 ; c0000005H
    jne    SHORT $LN4@main
    mov    DWORD PTR tv68[ebp], 1
    jmp    SHORT $LN5@main
$LN4@main:
    mov    DWORD PTR tv68[ebp], 0
$LN5@main:
    mov    eax, DWORD PTR tv68[ebp]
$LN9@main:
$LN11@main:
    ret    0

; handler:
$LN8@main:
    mov    esp, DWORD PTR __$SEHRec$[ebp]
    push   OFFSET $SG85488 ; &apos;access violation, can&apos;&apos;t recover&apos;
    call   _printf
    add    esp, 4
    mov    DWORD PTR __$SEHRec$[ebp+20], -2 ; previous try level
$LN6@main:
    xor    eax, eax
    mov    ecx, DWORD PTR __$SEHRec$[ebp+8]
    mov    DWORD PTR fs:0, ecx
    pop    ecx
    pop    edi
    pop    esi
    pop    ebx
    mov    esp, ebp
    pop    ebp
    ret    0
_main    ENDP
</code></pre><p>Listing 68.11: MSVC 2012: two try blocks example</p>
<pre><code>$SG85486 DB    &apos;in filter. code=0x%08X&apos;, 0aH, 00H
$SG85488 DB    &apos;yes, that is our exception&apos;, 0aH, 00H
$SG85490 DB    &apos;not our exception&apos;, 0aH, 00H
$SG85497 DB    &apos;hello!&apos;, 0aH, 00H
$SG85499 DB    &apos;0x112233 raised. now let&apos;&apos;s crash&apos;, 0aH, 00H
$SG85501 DB    &apos;access violation, can&apos;&apos;t recover&apos;, 0aH, 00H
$SG85503 DB    &apos;user exception caught&apos;, 0aH, 00H

xdata$x    SEGMENT
__sehtable$_main DD 0fffffffeH         ; GS Cookie Offset
                 DD    00H             ; GS Cookie XOR Offset
                 DD    0ffffffc8H      ; EH Cookie Offset
                 DD    00H             ; EH Cookie Offset
                 DD    0fffffffeH      ; previous try level for outer block
                 DD    FLAT:$LN19@main ; outer block filter
                 DD    FLAT:$LN9@main  ; outer block handler
                 DD    00H             ; previous try level for inner block
                 DD    FLAT:$LN18@main ; inner block filter
                 DD    FLAT:$LN13@main ; inner block handler
xdata$x    ENDS

$T2 = -40        ; size = 4
$T3 = -36        ; size = 4
_p$ = -32        ; size = 4
tv72 = -28       ; size = 4
__$SEHRec$ = -24 ; size = 24
_main    PROC
    push   ebp
    mov    ebp, esp
    push   -2  ; initial previous try level
    push   OFFSET __sehtable$_main
    push   OFFSET __except_handler4
    mov    eax, DWORD PTR fs:0
    push   eax ; prev
    add    esp, -24
    push   ebx
    push   esi
    push   edi
    mov    eax, DWORD PTR ___security_cookie
    xor    DWORD PTR __$SEHRec$[ebp+16], eax       ; xored pointer to scope table
    xor    eax, ebp                                ; ebp ^ security_cookie
    push   eax
    lea    eax, DWORD PTR __$SEHRec$[ebp+8]        ; pointer to VC_EXCEPTION_REGISTRATION_RECORD
    mov    DWORD PTR fs:0, eax
    mov    DWORD PTR __$SEHRec$[ebp], esp
    mov    DWORD PTR _p$[ebp], 0
    mov    DWORD PTR __$SEHRec$[ebp+20], 0 ; entering outer try block, setting previous try level=0
    mov    DWORD PTR __$SEHRec$[ebp+20], 1 ; entering inner try block, setting previous try level=1
    push   OFFSET $SG85497 ; &apos;hello!&apos;
    call   _printf
    add    esp, 4
    push   0
    push   0
    push   0
    push   1122867 ; 00112233H
    call   DWORD PTR __imp__RaiseException@16
    push   OFFSET $SG85499 ; &apos;0x112233 raised. now let&apos;&apos;s crash&apos;
    call   _printf
    add    esp, 4
    mov    eax, DWORD PTR _p$[ebp]
    mov    DWORD PTR [eax], 13
    mov    DWORD PTR __$SEHRec$[ebp+20], 0 ; exiting inner try block, set previous try level back to 0
    jmp    SHORT $LN2@main

; inner block filter:
$LN12@main:
$LN18@main:
    mov    ecx, DWORD PTR __$SEHRec$[ebp+4]
    mov    edx, DWORD PTR [ecx]
    mov    eax, DWORD PTR [edx]
    mov    DWORD PTR $T3[ebp], eax
    cmp    DWORD PTR $T3[ebp], -1073741819 ; c0000005H
    jne    SHORT $LN5@main
    mov    DWORD PTR tv72[ebp], 1
    jmp    SHORT $LN6@main
$LN5@main:
    mov    DWORD PTR tv72[ebp], 0
$LN6@main:
    mov    eax, DWORD PTR tv72[ebp]
$LN14@main:
$LN16@main:
    ret    0

; inner block handler:
$LN13@main:
    mov    esp, DWORD PTR __$SEHRec$[ebp]
    push   OFFSET $SG85501 ; &apos;access violation, can&apos;&apos;t recover&apos;
    call   _printf
    add    esp, 4
    mov    DWORD PTR __$SEHRec$[ebp+20], 0 ; exiting inner try block, setting previous try level back to 0
$LN2@main:
    mov    DWORD PTR __$SEHRec$[ebp+20], -2 ; exiting both blocks, setting previous try level back to -2
    jmp    SHORT $LN7@main

; outer block filter:
$LN8@main:
$LN19@main:
    mov    ecx, DWORD PTR __$SEHRec$[ebp+4]
    mov    edx, DWORD PTR [ecx]
    mov    eax, DWORD PTR [edx]
    mov    DWORD PTR $T2[ebp], eax
    mov    ecx, DWORD PTR __$SEHRec$[ebp+4]
    push   ecx
    mov    edx, DWORD PTR $T2[ebp]
    push   edx
    call   _filter_user_exceptions
    add    esp, 8
$LN10@main:
$LN17@main:
    ret    0

; outer block handler:
$LN9@main:
    mov    esp, DWORD PTR __$SEHRec$[ebp]
    push   OFFSET $SG85503 ; &apos;user exception caught&apos;
    call   _printf
    add    esp, 4
    mov    DWORD PTR __$SEHRec$[ebp+20], -2 ; exiting both blocks, setting previous try level back to -2
$LN7@main:
    xor    eax, eax
    mov    ecx, DWORD PTR __$SEHRec$[ebp+8]
    mov    DWORD PTR fs:0, ecx
    pop    ecx
    pop    edi
    pop    esi
    pop    ebx
    mov    esp, ebp
    pop    ebp
    ret    0
_main    ENDP

_code$ = 8  ; size = 4
_ep$ = 12   ; size = 4
_filter_user_exceptions PROC
    push   ebp
    mov    ebp, esp
    mov    eax, DWORD PTR _code$[ebp]
    push   eax
    push   OFFSET $SG85486 ; &apos;in filter. code=0x%08X&apos;
    call   _printf
    add    esp, 8
    cmp    DWORD PTR _code$[ebp], 1122867 ; 00112233H
    jne    SHORT $LN2@filter_use
    push   OFFSET $SG85488 ; &apos;yes, that is our exception&apos;
    call   _printf
    add    esp, 4
    mov    eax, 1
    jmp    SHORT $LN3@filter_use
    jmp    SHORT $LN3@filter_use
$LN2@filter_use:
    push   OFFSET $SG85490 ; &apos;not our exception&apos;
    call   _printf
    add    esp, 4
    xor    eax, eax
$LN3@filter_use:
    pop    ebp
    ret    0
_filter_user_exceptions ENDP
</code></pre><p>&#x8FD9;&#x91CC;&#x662F;cookie&#x7684;&#x542B;&#x4E49;&#xFF1A;Cookie Offset&#x7528;&#x4E8E;&#x533A;&#x5206;&#x6808;&#x4E2D;saved_EBP&#x7684;&#x5730;&#x5740;&#x548C;EBP&#x2295;security_cookie&#x3002;&#x9644;&#x52A0;&#x7684;Cookie XOR Offset&#x7528;&#x4E8E;&#x533A;&#x5206;EBP&#x2295;security_cookie&#x662F;&#x5426;&#x4FDD;&#x5B58;&#x5728;&#x6808;&#x4E2D;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x7B49;&#x5F0F;&#x4E0D;&#x4E3A;true&#xFF0C;&#x4F1A;&#x7531;&#x4E8E;&#x6808;&#x53D7;&#x5230;&#x7834;&#x574F;&#x800C;&#x505C;&#x6B62;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>security_cookie&#x2295;(Cookie XOR Offset+address_of_saved_EBP) == stack[address_of_saved_EBP + CookieOffset]</p>
<p>&#x5982;&#x679C;Cookie Offset&#x4E3A;-2&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5B83;&#x4E0D;&#x5B58;&#x5728;&#x3002;</p>
<p>&#x5728;&#x6211;&#x7684;tracer&#x5DE5;&#x5177;&#x4E5F;&#x5B9E;&#x73B0;&#x4E86;Cookie&#x68C0;&#x67E5;&#xFF0C;&#x5177;&#x4F53;&#x8BF7;&#x770B;<a href="http://go.yurichev.com/17061" target="_blank">Github</a>&#x3002;</p>
<p>MSVC 2005&#x4E4B;&#x540E;&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x5F00;&#x542F;/GS&#x9009;&#x9879;&#x4ECD;&#x53EF;&#x80FD;&#x4F1A;&#x56DE;&#x6EDA;&#x5230;SEH3&#x3002;&#x4E0D;&#x8FC7;&#xFF0C;CRT&#x7684;&#x4EE3;&#x7801;&#x603B;&#x662F;&#x4F7F;&#x7528;SEH4&#x3002;</p>
<h3 id="6833-windows-x64">68.3.3 Windows x64</h3>
<p>&#x6B63;&#x5982;&#x4F60;&#x6240;&#x8BA4;&#x4E3A;&#x7684;&#xFF0C;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x5E8F;&#x8A00;&#x5728;&#x8BBE;&#x7F6E;SEH&#x5E27;&#x6548;&#x7387;&#x4E0D;&#x9AD8;&#x3002;&#x53E6;&#x4E00;&#x4E2A;&#x6027;&#x80FD;&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x51FD;&#x6570;&#x6267;&#x884C;&#x671F;&#x95F4;&#x591A;&#x6B21;&#x5C1D;&#x8BD5;&#x6539;&#x53D8;previous try level&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x5728;x64&#x5B8C;&#x5168;&#x6539;&#x53D8;&#x4E86;&#xFF1A;&#x73B0;&#x5728;&#x6240;&#x6709;&#x6307;&#x5411;try&#x5757;&#xFF0C;filter&#x548C;handler&#x51FD;&#x6570;&#x90FD;&#x4FDD;&#x5B58;&#x5728;PE&#x6587;&#x4EF6;&#x7684;.pdata&#x6BB5;&#xFF0C;&#x7531;&#x5B83;&#x63D0;&#x4F9B;&#x7ED9;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x6240;&#x9700;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x4F7F;&#x7528;x64&#x7F16;&#x8BD1;&#x7684;&#x4F8B;&#x5B50;&#xFF1A;</p>
<p>Listing 68.12: MSVC 2012</p>
<pre><code>$SG86276 DB &apos;hello #1!&apos;, 0aH, 00H
$SG86277 DB &apos;hello #2!&apos;, 0aH, 00H
$SG86279 DB &apos;access violation, can&apos;&apos;t recover&apos;, 0aH, 00H
pdata SEGMENT
$pdata$main DD imagerel $LN9
    DD imagerel $LN9+61
    DD imagerel $unwind$main
pdata ENDS
pdata SEGMENT
$pdata$main$filt$0 DD imagerel main$filt$0
    DD imagerel main$filt$0+32
    DD imagerel $unwind$main$filt$0
pdata ENDS
xdata SEGMENT
$unwind$main DD 020609H
    DD 030023206H
    DD imagerel __C_specific_handler
    DD 01H
    DD imagerel $LN9+8
    DD imagerel $LN9+40
    DD imagerel main$filt$0
    DD imagerel $LN9+40
$unwind$main$filt$0 DD 020601H
    DD 050023206H
xdata ENDS
_TEXT SEGMENT
main PROC
$LN9:
    push rbx
    sub rsp, 32
    xor ebx, ebx
    lea rcx, OFFSET FLAT:$SG86276 ; &apos;hello #1!&apos;
    call printf
    mov DWORD PTR [rbx], 13
    lea rcx, OFFSET FLAT:$SG86277 ; &apos;hello #2!&apos;
    call printf
    jmp SHORT $LN8@main
$LN6@main:
    lea rcx, OFFSET FLAT:$SG86279 ; &apos;access violation, can&apos;&apos;t recover&apos;
    call printf
    npad 1 ; align next label
$LN8@main:
    xor eax, eax
    add rsp, 32
    pop rbx
    ret 0
main ENDP
_TEXT ENDS

text$x SEGMENT
main$filt$0 PROC
    push rbp
    sub rsp, 32
    mov rbp, rdx
$LN5@main$filt$:
    mov rax, QWORD PTR [rcx]
    xor ecx, ecx
    cmp DWORD PTR [rax], -1073741819; c0000005H
    sete cl
    mov eax, ecx
$LN7@main$filt$:
    add rsp, 32
    pop rbp
    ret 0
    int 3
main$filt$0 ENDP
text$x ENDS
</code></pre><p>Listing 68.13: MSVC 2012</p>
<pre><code>$SG86277 DB &apos;in filter. code=0x%08X&apos;, 0aH, 00H
$SG86279 DB &apos;yes, that is our exception&apos;, 0aH, 00H
$SG86281 DB &apos;not our exception&apos;, 0aH, 00H
$SG86288 DB &apos;hello!&apos;, 0aH, 00H
$SG86290 DB &apos;0x112233 raised. now let&apos;&apos;s crash&apos;, 0aH, 00H
$SG86292 DB &apos;access violation, can&apos;&apos;t recover&apos;, 0aH, 00H
$SG86294 DB &apos;user exception caught&apos;, 0aH, 00H

pdata SEGMENT
$pdata$filter_user_exceptions DD imagerel $LN6
    DD imagerel $LN6+73
    DD imagerel $unwind$filter_user_exceptions
$pdata$main DD imagerel $LN14
    DD imagerel $LN14+95
    DD imagerel $unwind$main
pdata ENDS
pdata SEGMENT
$pdata$main$filt$0 DD imagerel main$filt$0
    DD imagerel main$filt$0+32
    DD imagerel $unwind$main$filt$0
$pdata$main$filt$1 DD imagerel main$filt$1
    DD imagerel main$filt$1+30
    DD imagerel $unwind$main$filt$1
pdata ENDS
xdata SEGMENT
$unwind$filter_user_exceptions DD 020601H
    DD 030023206H
$unwind$main DD 020609H
    DD 030023206H
    DD imagerel __C_specific_handler
    DD 02H
    DD imagerel $LN14+8
    DD imagerel $LN14+59
    DD imagerel main$filt$0
    DD imagerel $LN14+59
    DD imagerel $LN14+8
    DD imagerel $LN14+74
    DD imagerel main$filt$1
    DD imagerel $LN14+74
$unwind$main$filt$0 DD 020601H
    DD 050023206H
$unwind$main$filt$1 DD 020601H
    DD 050023206H
xdata ENDS

_TEXT SEGMENT
main PROC
$LN14:
    push rbx
    sub rsp, 32
    xor ebx, ebx
    lea rcx, OFFSET FLAT:$SG86288 ; &apos;hello!&apos;
    call printf
    xor r9d, r9d
    xor r8d, r8d
    xor edx, edx
    mov ecx, 1122867 ; 00112233H
    call QWORD PTR __imp_RaiseException
    lea rcx, OFFSET FLAT:$SG86290 ; &apos;0x112233 raised. now let&apos;&apos;s crash&apos;
    call printf
    mov DWORD PTR [rbx], 13
    jmp SHORT $LN13@main
$LN11@main:
    lea rcx, OFFSET FLAT:$SG86292 ; &apos;access violation, can&apos;&apos;t recover&apos;
    call printf
    npad 1 ; align next label
$LN13@main:
    jmp SHORT $LN9@main
$LN7@main:
    lea rcx, OFFSET FLAT:$SG86294 ; &apos;user exception caught&apos;
    call printf
    npad 1 ; align next label
$LN9@main:
    xor eax, eax
    add rsp, 32
    pop rbx
    ret 0
main ENDP

text$x SEGMENT
main$filt$0 PROC
    push rbp
    sub rsp, 32
    mov rbp, rdx
$LN10@main$filt$:
    mov rax, QWORD PTR [rcx]
    xor ecx, ecx
    cmp DWORD PTR [rax], -1073741819; c0000005H
    sete cl
    mov eax, ecx
$LN12@main$filt$:
    add rsp, 32
    pop rbp
    ret 0
    int 3
main$filt$0 ENDP
main$filt$1 PROC
    push rbp
    sub rsp, 32
    mov rbp, rdx
$LN6@main$filt$:
    mov rax, QWORD PTR [rcx]
    mov rdx, rcx
    mov ecx, DWORD PTR [rax]
    call filter_user_exceptions
    npad 1 ; align next label
$LN8@main$filt$:
    add rsp, 32
    pop rbp
    ret 0
    int 3
main$filt$1 ENDP
text$x ENDS

_TEXT SEGMENT
code$ = 48
ep$ = 56
filter_user_exceptions PROC
$LN6:
    push rbx
    sub rsp, 32
    mov ebx, ecx
    mov edx, ecx
    lea rcx, OFFSET FLAT:$SG86277 ; &apos;in filter. code=0x%08X&apos;
    call printf
    cmp ebx, 1122867; 00112233H
    jne SHORT $LN2@filter_use
    lea rcx, OFFSET FLAT:$SG86279 ; &apos;yes, that is our exception&apos;
    call printf
    mov eax, 1
    add rsp, 32
    pop rbx
    ret 0
$LN2@filter_use:
    lea rcx, OFFSET FLAT:$SG86281 ; &apos;not our exception&apos;
    call printf
    xor eax, eax
    add rsp, 32
    pop rbx
    ret 0
filter_user_exceptions ENDP
_TEXT ENDS
</code></pre><p>&#x8BFB;<a href="http://go.yurichev.com/17294" target="_blank">Sko12</a>&#x83B7;&#x53D6;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x7684;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x9664;&#x4E86;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF0C;.pdata&#x8FD8;&#x5305;&#x542B;&#x4E86;&#x51E0;&#x4E4E;&#x6240;&#x6709;&#x51FD;&#x6570;&#x7684;&#x5F00;&#x59CB;&#x548C;&#x7ED3;&#x675F;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x53EF;&#x80FD;&#x5BF9;&#x4E8E;&#x81EA;&#x52A8;&#x5316;&#x5206;&#x6790;&#x5DE5;&#x5177;&#x6709;&#x7528;&#x3002;</p>
<h3 id="6834-&#x66F4;&#x591A;&#x5173;&#x4E8E;seh&#x7684;&#x4FE1;&#x606F;">68.3.4 &#x66F4;&#x591A;&#x5173;&#x4E8E;SEH&#x7684;&#x4FE1;&#x606F;</h3>
<p>Matt Pietrek. &#x201C;A Crash Course on the Depths of Win32&#x2122; Structured Exception Handling&#x201D;. In: MSDN magazine ().
URL: <a href="http://go.yurichev.com/17293" target="_blank">http://go.yurichev.com/17293</a>.</p>
<p>Igor Skochinsky. Compiler Internals: Exceptions and RTTI. Also available as <a href="http://go.yurichev.com/
17294" target="_blank">http://go.yurichev.com/
17294</a>. 2012.</p>
<h2 id="684-windows-nt-critical-section">68.4 Windows NT: Critical section</h2>
<p>&#x4E34;&#x754C;&#x533A;&#x5728;&#x4EFB;&#x4F55;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x591A;&#x7EBF;&#x7A0B;&#x73AF;&#x5883;&#x4E2D;&#x90FD;&#x662F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x5B83;&#x4FDD;&#x8BC1;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5728;&#x67D0;&#x4E00;&#x65F6;&#x523B;&#x8BBF;&#x95EE;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x963B;&#x585E;&#x5176;&#x5B83;&#x6B63;&#x8981;&#x8BBF;&#x95EE;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x7684;&#x7EBF;&#x7A0B;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x662F;Windows NT&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;CRITICAL_SECTION&#x58F0;&#x660E;&#xFF1A;</p>
<p>Listing 68.14: (Windows Research Kernel v1.2) public/sdk/inc/nturtl.h</p>
<pre><code>typedef struct _RTL_CRITICAL_SECTION {
    PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
    //
    // The following three fields control entering and exiting the critical
    // section for the resource
    //
    LONG LockCount;
    LONG RecursionCount;
    HANDLE OwningThread; // from the thread&apos;s ClientId-&gt;UniqueThread
    HANDLE LockSemaphore;
    ULONG_PTR SpinCount; // force size on 64-bit systems when packed
} RTL_CRITICAL_SECTION, *PRTL_CRITICAL_SECTION;
</code></pre><p>&#x4E0B;&#x9762;&#x5C55;&#x793A;&#x4E86;EnterCriticalSection()&#x51FD;&#x6570;&#x7684;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>Listing 68.15: Windows 2008/ntdll.dll/x86 (begin)</p>
<pre><code>_RtlEnterCriticalSection@4
var_C = dword ptr -0Ch
var_8 = dword ptr -8
var_4 = dword ptr -4
arg_0 = dword ptr 8
    mov edi, edi
    push ebp
    mov ebp, esp
    sub esp, 0Ch
    push esi
    push edi
    mov edi, [ebp+arg_0]
    lea esi, [edi+4] ; LockCount
    mov eax, esi
    lock btr dword ptr [eax], 0
    jnb wait ; jump if CF=0
loc_7DE922DD:
    mov eax, large fs:18h
    mov ecx, [eax+24h]
    mov [edi+0Ch], ecx
    mov dword ptr [edi+8], 1
    pop edi
    xor eax, eax
    pop esi
    mov esp, ebp
    pop ebp
    retn 4
... skipped
</code></pre><p>&#x5728;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E2D;&#x6700;&#x91CD;&#x8981;&#x7684;&#x6307;&#x4EE4;&#x662F;BTR(&#x5E26;LOCK&#x524D;&#x7F00;)&#xFF1A;&#x628A;&#x76EE;&#x7684;&#x64CD;&#x4F5C;&#x6570;&#x4E2D;&#x7531;&#x6E90;&#x64CD;&#x4F5C;&#x6570;&#x6240;&#x6307;&#x5B9A;&#x4F4D;&#x7684;&#x503C;&#x9001;&#x5F80;&#x6807;&#x5FD7;&#x4F4D;CF&#xFF0C;&#x5E76;&#x5C06;&#x76EE;&#x7684;&#x64CD;&#x4F5C;&#x6570;&#x4E2D;&#x7684;&#x8BE5;&#x4F4D;&#x7F6E;0&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#xFF0C;&#x4F1A;&#x963B;&#x585E;&#x6389;&#x5176;&#x5B83;&#x540C;&#x65F6;&#x60F3;&#x8981;&#x8BBF;&#x95EE;&#x8FD9;&#x6BB5;&#x5185;&#x5B58;&#x7684;CPU&#xFF08;&#x53C2;&#x770B;BTR&#x6307;&#x4EE4;&#x7684;LOCK&#x524D;&#x7F00;&#xFF09;&#x3002;&#x5982;&#x679C;LockCount&#x662F;1&#xFF0C;&#x5219;&#x91CD;&#x7F6E;&#x5E76;&#x8FD4;&#x56DE;&#xFF1A;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x6B63;&#x5904;&#x4E8E;&#x4E34;&#x754C;&#x533A;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x5219;&#x8868;&#x793A;&#x5176;&#x5B83;&#x7EBF;&#x7A0B;&#x6B63;&#x5728;&#x5360;&#x7528;&#xFF0C;&#x5C06;&#x8FDB;&#x5165;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;</p>
<p>&#x4F7F;&#x7528;WaitForSingleObject()&#x8FDB;&#x5165;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x5C55;&#x793A;&#x4E86;LeaveCriticalSection()&#x51FD;&#x6570;&#x7684;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>Listing 68.16: Windows 2008/ntdll.dll/x86 (begin)</p>
<pre><code>_RtlLeaveCriticalSection@4 proc near
arg_0 = dword ptr 8
    mov edi, edi
    push ebp
    mov ebp, esp
    push esi
    mov esi, [ebp+arg_0]
    add dword ptr [esi+8], 0FFFFFFFFh ;RecursionCount
    jnz short loc_7DE922B2
    push ebx
    push edi
    lea edi, [esi+4] ; LockCount
    mov dword ptr [esi+0Ch], 0
    mov ebx, 1
    mov eax, edi
    lock xadd [eax], ebx
    inc ebx
    cmp ebx, 0FFFFFFFFh
    jnz loc_7DEA8EB7
    loc_7DE922B0:
    pop edi
    pop ebx
loc_7DE922B2:
    xor eax, eax
    pop esi
    pop ebp
    retn 4
... skipped
</code></pre><p>XADD&#x6307;&#x4EE4;&#x529F;&#x80FD;&#x662F;&#xFF1A;&#x4EA4;&#x6362;&#x5E76;&#x76F8;&#x52A0;&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;LockCount&#x52A0;1&#x5E76;&#x628A;&#x7ED3;&#x679C;&#x4FDD;&#x5B58;&#x5230;EBX&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x540C;&#x65F6;&#x628A;1&#x8D4B;&#x503C;&#x7ED9;LockCount&#x3002;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x662F;&#x539F;&#x5B50;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4F7F;&#x7528;&#x4E86;LOCK&#x524D;&#x7F00;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x7CFB;&#x7EDF;&#x4F1A;&#x963B;&#x585E;&#x5176;&#x5B83;CPU&#x6216;CPU&#x6838;&#x5FC3;&#x540C;&#x65F6;&#x8BBF;&#x95EE;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x3002;</p>
<p>LOCK&#x524D;&#x7F00;&#x662F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#xFF1A;&#x5982;&#x679C;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x90FD;&#x5DE5;&#x4F5C;&#x5728;&#x4E0D;&#x540C;&#x7684;CPU&#x6216;CPU&#x6838;&#x5FC3;&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x80FD;&#x591F;&#x8FDB;&#x5165;critical section&#x5E76;&#x4FEE;&#x6539;&#x5185;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x79CD;&#x884C;&#x4E3A;&#x5C06;&#x5BFC;&#x81F4;&#x4E0D;&#x786E;&#x5B9A;&#x7684;&#x540E;&#x679C;&#x3002;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Chapter-67.html" class="navigation navigation-prev " aria-label="Previous page: Linux">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Part-VII/part7.html" class="navigation navigation-next " aria-label="Next page: Part VII 工具">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Windows-NT","level":"1.7.5","depth":2,"next":{"title":"Part VII 工具","level":"1.8","depth":1,"path":"Part-VII/part7.md","ref":"Part-VII/part7.md","articles":[{"title":"反汇编器","level":"1.8.1","depth":2,"path":"Part-VII/Chapter-69.md","ref":"Part-VII/Chapter-69.md","articles":[]},{"title":"调试器","level":"1.8.2","depth":2,"path":"Part-VII/Chapter-70.md","ref":"Part-VII/Chapter-70.md","articles":[]},{"title":"系统调用的追踪","level":"1.8.3","depth":2,"path":"Part-VII/Chapter-71.md","ref":"Part-VII/Chapter-71.md","articles":[]},{"title":"反编译器","level":"1.8.4","depth":2,"path":"Part-VII/Chapter-72.md","ref":"Part-VII/Chapter-72.md","articles":[]},{"title":"其他工具","level":"1.8.5","depth":2,"path":"Part-VII/Chapter-73.md","ref":"Part-VII/Chapter-73.md","articles":[]}]},"previous":{"title":"Linux","level":"1.7.4","depth":2,"path":"Part-VI/Chapter-67.md","ref":"Part-VI/Chapter-67.md","articles":[]},"dir":"ltr"},"config":{"plugins":["comment"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"comment":{"highlightCommented":true},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"wizardforcel","pdf":{"pageNumbers":true,"fontSize":16,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"逆向工程入门指南","language":"zh","links":{"sidebar":{"逆向工程入门指南":"https://www.gitbook.com/book/wizardforcel/re-for-beginners"},"gitbook":true},"gitbook":"*","description":""},"file":{"path":"Part-VI/Chapter-68.md","mtime":"2017-01-03T07:50:52.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-01-03T07:55:06.624Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-comment/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

